# MEOのばすくん 本番デプロイ仕様書

## ■ 1. Laravelアプリ基本構成

### 1.1 Laravelバージョン
- **Laravel**: `^12.0` (Laravel 12)
- **PHP**: `^8.2` (PHP 8.2以上必須)

### 1.2 使用DB
- **MySQL** (SQLiteは開発用のみ)
- 接続設定: `config/database.php` の `mysql` 設定を使用

### 1.3 必須環境変数（.env）

```env
# アプリ基本設定
APP_NAME=MEOのばすくん
APP_ENV=production
APP_KEY=base64:... (php artisan key:generate で生成)
APP_DEBUG=false
APP_URL=https://your-domain.com

# データベース
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=meo_production
DB_USERNAME=your_db_user
DB_PASSWORD=your_db_password

# キュー
QUEUE_CONNECTION=database

# ScrapingBee API
SCRAPINGBEE_API_KEY=your_scrapingbee_api_key
SCRAPINGBEE_RENDER_JS_DEFAULT=true
SCRAPINGBEE_TIMEOUT_MS=140000
SCRAPINGBEE_WAIT_MS_DEFAULT=0
SCRAPINGBEE_BLOCK_RESOURCES_DEFAULT=true

# セッション・キャッシュ（本番では推奨）
SESSION_DRIVER=database
CACHE_DRIVER=database

# ログ
LOG_CHANNEL=daily
LOG_LEVEL=error
```

### 1.4 書き込み要件

**書き込み可能なディレクトリ**:
- `storage/` (全階層)
- `storage/framework/cache/`
- `storage/framework/sessions/`
- `storage/framework/views/`
- `storage/logs/`
- `bootstrap/cache/`

**権限設定（Linux）**:
```bash
chmod -R 775 storage bootstrap/cache
chown -R www-data:www-data storage bootstrap/cache
```

### 1.5 主要パッケージ一覧

**本番必須**:
- `laravel/framework: ^12.0`
- `barryvdh/laravel-dompdf: ^3.1` (PDF生成)
- `mpdf/mpdf: ^8.2` (PDF生成)
- `symfony/css-selector: ^7.4` (HTMLパース)
- `symfony/dom-crawler: ^7.4` (HTMLパース)

**開発用**:
- `laravel/breeze: ^2.3`
- `laravel/pail: ^1.2.2`
- `laravel/pint: ^1.24`
- `laravel/sail: ^1.41`

---

## ■ 2. キーワード取得機能（Node）

### 2.1 rank-worker.cjs の役割

- **目的**: Google検索結果からキーワード順位を取得
- **実行方法**: `node rank-worker.cjs`
- **常駐型**: ✅ はい（常駐プロセス）

### 2.2 技術スタック

- **Playwright**: 使用中（`package.json` に `playwright: ^1.58.1`）
- **Headless Chrome**: ⚠️ **現状は `headless: false`** (524行目)
  - 本番では `headless: true` に変更推奨
- **MySQL接続**: `mysql2` パッケージ使用

### 2.3 ポート使用

- **HTTPサーバー**: 未使用（直接DB接続）
- **WebSocket**: ❌ 未使用
- **Laravel連携**: MySQL経由で `rank_fetch_jobs` テーブルを監視

### 2.4 Laravelからの呼び出し

- **直接呼び出しなし**: Laravelは `rank_fetch_jobs` テーブルにジョブをINSERT
- **rank-worker.cjs**: テーブルをポーリングしてジョブを取得・実行
- **結果保存**: `meo_rank_logs` テーブルに保存

### 2.5 本番Linux環境での動作

- ✅ **動作可能**: PlaywrightはLinux対応
- ⚠️ **注意**: 現状は `headless: false` のため、本番では `headless: true` に変更必須
- **必要な依存関係**:
  ```bash
  # Playwrightのブラウザをインストール
  npx playwright install chromium
  npx playwright install-deps chromium
  ```

---

## ■ 3. Queue処理

### 3.1 Queue Driver

- **デフォルト**: `database` (`QUEUE_CONNECTION=database`)
- **設定ファイル**: `config/queue.php`
- **テーブル**: `jobs` テーブル（自動生成）

### 3.2 同時実行数

- **デフォルト**: 1プロセス
- **設定方法**: Supervisorで複数プロセス起動可能

### 3.3 Retry設定

- **デフォルト**: 3回（Laravel標準）
- **タイムアウト**: `retry_after` = 90秒（`config/queue.php`）

### 3.4 failed_jobsテーブル

- ✅ **存在**: `failed_jobs` テーブル（Laravel標準）
- **マイグレーション**: `php artisan queue:failed-table` で作成済み

### 3.5 Supervisor前提設計

- ❌ **現状**: `php artisan queue:work` を手動起動
- ✅ **推奨**: 本番ではSupervisorで常駐化必須

**Supervisor設定例**:
```ini
[program:meo-queue-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/artisan queue:work database --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/path/to/storage/logs/queue-worker.log
stopwaitsecs=3600
```

---

## ■ 4. Schedule処理

### 4.1 Schedule定義

**ファイル**: `routes/console.php`

```php
// 毎月7日の午前9時に前月分のレポートを自動送信
Schedule::command('reports:send-monthly')
    ->monthlyOn(7, '09:00')
    ->timezone('Asia/Tokyo');

// ブログ自動クロール・投稿（毎分実行）
Schedule::command('blog:crawl')
    ->everyMinute()
    ->timezone('Asia/Tokyo')
    ->withoutOverlapping();

// Instagram自動クロール・投稿（毎分実行）
Schedule::command('instagram:crawl')
    ->everyMinute()
    ->timezone('Asia/Tokyo')
    ->withoutOverlapping();
```

### 4.2 Cron前提設計

- ✅ **推奨**: 本番ではcronで `php artisan schedule:run` を毎分実行
- **現状**: `php artisan schedule:work` を手動起動（開発用）

**Cron設定**:
```cron
* * * * * cd /path/to/project && php artisan schedule:run >> /dev/null 2>&1
```

### 4.3 schedule:run への変更

- ✅ **可能**: `schedule:work` → `schedule:run` に変更可能
- **推奨**: 本番ではcron + `schedule:run` を使用

---

## ■ 5. Instagram / ブログスクレイピング

### 5.1 ScrapingBee API呼び出し箇所

**サービス**: `app/Services/ScrapingBeeFetcher.php`

**使用箇所**:
- `app/Console/Commands/CrawlAndPostInstagram.php`
- `app/Console/Commands/CrawlAndPostBlogs.php`
- `app/Http/Controllers/InstagramTestController.php`
- `app/Http/Controllers/BlogTestController.php`

### 5.2 APIキーの保存場所

- **環境変数**: `SCRAPINGBEE_API_KEY`
- **設定ファイル**: `config/services.php` → `env('SCRAPINGBEE_API_KEY')`

### 5.3 タイムアウト設定

- **デフォルト**: 140秒（140000ms）
- **設定**: `SCRAPINGBEE_TIMEOUT_MS=140000`
- **Guzzle timeout**: 140秒（ミリ秒を秒に変換）

### 5.4 Rate Limit考慮

- ❌ **現状**: 明示的なrate limit処理なし
- ⚠️ **注意**: ScrapingBeeのAPI制限に依存
- **推奨**: 本番ではAPI使用量を監視

---

## ■ 6. 本番移行時に必要な要素

### 6.1 必須サービス

| サービス | 必須 | 用途 |
|---------|------|------|
| **PHP 8.2+** | ✅ | Laravel実行 |
| **MySQL** | ✅ | データベース |
| **Node.js** | ✅ | rank-worker.cjs実行 |
| **Redis** | ❌ | 未使用（オプション） |
| **Chrome/Chromium** | ✅ | Playwright用（自動インストール） |

### 6.2 常駐プロセス一覧

| プロセス | コマンド | 管理方法 |
|---------|---------|---------|
| **Queue Worker** | `php artisan queue:work` | Supervisor推奨 |
| **Schedule** | `php artisan schedule:run` (cron) | Cron |
| **Node Worker** | `node rank-worker.cjs` | Supervisor推奨 |
| **Web Server** | Nginx/Apache + PHP-FPM | Systemd/Init |

### 6.3 Linux本番環境で動かない可能性のある箇所

#### ⚠️ 注意が必要な箇所

1. **Windows固有のパス**
   - 現状: 特に見当たらない
   - 確認: ファイルパスは相対パスまたは `storage_path()` 使用

2. **Playwrightのブラウザ依存関係**
   - Linuxでは追加のシステム依存が必要
   - 解決: `npx playwright install-deps chromium`

3. **ファイル権限**
   - Windows: 問題なし
   - Linux: `storage/`, `bootstrap/cache/` の書き込み権限必須

4. **改行コード**
   - Windows: CRLF
   - Linux: LF
   - 影響: Gitで自動変換されるため問題なし

### 6.4 Windows依存コードの有無

- ❌ **Windows依存コード**: 見当たらない
- ✅ **クロスプラットフォーム対応**: Laravel標準機能を使用

---

## ■ 7. 本番デプロイ手順（推奨）

### 7.1 事前準備

```bash
# 1. サーバーに必要なパッケージをインストール
sudo apt update
sudo apt install -y php8.2 php8.2-fpm php8.2-mysql php8.2-mbstring php8.2-xml php8.2-curl
sudo apt install -y mysql-server nginx
sudo apt install -y nodejs npm

# 2. Composerインストール
curl -sS https://getcomposer.org/installer | php
sudo mv composer.phar /usr/local/bin/composer

# 3. Playwright依存関係インストール
cd /path/to/project
npm install
npx playwright install chromium
npx playwright install-deps chromium
```

### 7.2 アプリケーション設定

```bash
# 1. 環境変数設定
cp .env.example .env
# .env を編集（上記の必須環境変数を設定）

# 2. アプリケーションキー生成
php artisan key:generate

# 3. データベースマイグレーション
php artisan migrate --force

# 4. ストレージリンク
php artisan storage:link

# 5. 権限設定
chmod -R 775 storage bootstrap/cache
chown -R www-data:www-data storage bootstrap/cache
```

### 7.3 Supervisor設定

**`/etc/supervisor/conf.d/meo-queue-worker.conf`**:
```ini
[program:meo-queue-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/artisan queue:work database --sleep=3 --tries=3 --max-time=3600
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
numprocs=2
redirect_stderr=true
stdout_logfile=/path/to/storage/logs/queue-worker.log
stopwaitsecs=3600
```

**`/etc/supervisor/conf.d/meo-rank-worker.conf`**:
```ini
[program:meo-rank-worker]
command=node /path/to/rank-worker.cjs
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=www-data
directory=/path/to
redirect_stderr=true
stdout_logfile=/path/to/storage/logs/rank-worker.log
```

**Supervisor再読み込み**:
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start meo-queue-worker:*
sudo supervisorctl start meo-rank-worker
```

### 7.4 Cron設定

```bash
# crontab -e
* * * * * cd /path/to/project && php artisan schedule:run >> /dev/null 2>&1
```

### 7.5 Nginx設定例

```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /path/to/public;

    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";

    index index.php;

    charset utf-8;

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt  { access_log off; log_not_found off; }

    error_page 404 /index.php;

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        include fastcgi_params;
    }

    location ~ /\.(?!well-known).* {
        deny all;
    }
}
```

---

## ■ 8. 設計変更推奨事項

### 8.1 Queue Driver

- **現状**: `database`
- **推奨**: 本番では `redis` に変更を検討（パフォーマンス向上）

### 8.2 Schedule実行方式

- **現状**: `schedule:work` (開発用)
- **推奨**: `schedule:run` + Cron（本番標準）

### 8.3 ログ管理

- **現状**: `LOG_CHANNEL=daily` (日次ローテーション)
- **推奨**: 本番ではログローテーション設定を確認

### 8.4 セッション管理

- **現状**: `SESSION_DRIVER=database`
- **推奨**: 本番では `redis` に変更を検討（パフォーマンス向上）

### 8.5 Rank WorkerのHeadless設定

- **現状**: `headless: false` (524行目)
- **推奨**: 本番では `headless: true` に変更必須
- **変更箇所**: `rank-worker.cjs` の524行目
  ```javascript
  // 変更前
  headless: false,
  
  // 変更後
  headless: true,
  ```

---

## ■ 9. チェックリスト

### デプロイ前確認

- [ ] `.env` の `APP_ENV=production`, `APP_DEBUG=false` を確認
- [ ] `APP_KEY` が設定されているか確認
- [ ] データベース接続情報が正しいか確認
- [ ] `storage/`, `bootstrap/cache/` の書き込み権限を確認
- [ ] ScrapingBee APIキーが設定されているか確認
- [ ] Supervisor設定が正しいか確認
- [ ] Cron設定が正しいか確認
- [ ] Playwrightのブラウザがインストールされているか確認
- [ ] Nginx/Apache設定が正しいか確認
- [ ] SSL証明書が設定されているか確認（本番）

### デプロイ後確認

- [ ] `php artisan config:cache` を実行
- [ ] `php artisan route:cache` を実行
- [ ] `php artisan view:cache` を実行
- [ ] Queue Workerが起動しているか確認
- [ ] Rank Workerが起動しているか確認
- [ ] Scheduleが実行されているか確認
- [ ] ログファイルが生成されているか確認

---

## ■ 10. トラブルシューティング

### Queue Workerが起動しない

```bash
# Supervisorのログを確認
sudo supervisorctl tail -f meo-queue-worker:meo-queue-worker_00

# 手動で実行してエラー確認
php artisan queue:work --verbose
```

### Rank Workerが起動しない

```bash
# Supervisorのログを確認
sudo supervisorctl tail -f meo-rank-worker

# 手動で実行してエラー確認
node rank-worker.cjs
```

### Scheduleが実行されない

```bash
# Cronログを確認
grep CRON /var/log/syslog

# 手動で実行してエラー確認
php artisan schedule:run --verbose
```

---

**最終更新**: 2026-02-16

