# CompetitorAnalysis 論理破綻防止 設計仕様書

## 目的
monthly_review_count / monthly_post_count を含む数値項目について、「事実と矛盾する文章生成」を構造的に防止する。

---

## 【変更①】review_frequency / post_frequency の廃止（P0）

### 現状
- ✅ **実装済み**：`review_frequency` / `post_frequency` を完全に廃止
- ✅ **実装済み**：`monthly_review_count` / `monthly_post_count` を正式項目として追加

### 仕様定義

#### 廃止項目
- `review_frequency`（文字列型の頻度表現）
- `post_frequency`（文字列型の頻度表現）

#### 新規項目
- `monthly_review_count`（integer | null）：月間の口コミ数
- `monthly_post_count`（integer | null）：月間の投稿数

#### 入力仕様
- 週1回 → 4
- 月1回 → 1
- 不定期 → 0
- 未設定 → null（normalize()で`__MISSING__`に変換）

#### 統一ルール
- UIの入力欄：数値入力（type="number", min="0"）
- payload：integer型またはnull
- prompt：数値項目として明示

---

## 【変更②】normalize() の責務明確化（P0）

### 現状
- ✅ **実装済み**：数値項目を必ず`int`型に変換
- ✅ **実装済み**：`0`と`__MISSING__`を明確に区別

### 責務定義

#### normalize() の責務（限定）
1. **数値項目の型変換**
   - `review_count` → `int`
   - `photo_count` → `int`
   - `video_count` → `int`
   - `monthly_review_count` → `int`
   - `monthly_post_count` → `int`

2. **欠損値の正規化**
   - `null` / 空文字 → `__MISSING__`
   - `0` → `0`（実数0として保持）

3. **own_rank の処理**
   - `own`のみ保持、他は削除

#### normalize() の責務外（禁止事項）
- ❌ 優劣判断は一切しない
- ❌ ビジネスロジックの適用
- ❌ データの妥当性チェック（バリデーションは別メソッド）

### 実装コード（参考）
```php
private function normalize(array $data): array
{
    $numericFields = [
        'review_count',
        'photo_count',
        'video_count',
        'monthly_review_count',
        'monthly_post_count',
    ];
    
    foreach ($data['shops'] as &$shop) {
        foreach ($shop as $key => $value) {
            if (in_array($key, $numericFields)) {
                if ($value === '' || $value === null) {
                    $shop[$key] = '__MISSING__';
                } else {
                    $shop[$key] = (int)$value; // 必ずint型に変換
                }
            }
        }
    }
    return $data;
}
```

---

## 【変更③】数値比較ルールの完全明文化（P0）

### 現状
- ✅ **実装済み**：基本的な数値比較ルールをプロンプトに追加
- ⚠️ **要追加**：比較結果の確定タイミングの明示
- ⚠️ **要追加**：矛盾発生時のフォールバック処理の明示

### プロンプト内のルール定義

#### 純粋数値比較ルール
```
monthly_review_count / monthly_post_count は
純粋な数値比較項目として扱うこと。
```

#### 比較結果の扱い（3パターン）

**パターン1：自社 > 競合**
- 表現：「優位」「問題ではない」「順位低下要因ではない」
- 禁止表現：「不足」「弱い」「劣っている」等のネガティブ表現
- 使用可否：順位低下の原因として使用禁止

**パターン2：自社 = 競合**
- 表現：「同等」「影響は限定的」
- 使用可否：順位への影響は限定的と表現

**パターン3：自社 < 競合**
- 表現：「劣っている」「改善余地あり」
- 使用可否：順位低下要因として使用可能

#### 禁止事項
- 数値比較結果と矛盾する文章生成は禁止
- 自社が優れている項目を「不足」「課題」として表現することは禁止

---

## 【変更④】比較結果の確定タイミング（Critical）

### 現状
- ✅ **実装完了**：プロンプト内に明示的に追加済み

### 仕様定義

#### 必須ルール
```
monthly_review_count / monthly_post_count を含む
すべての数値比較項目について、
文章生成前に必ず比較結果を確定させること：

・自社 > 競合
・自社 = 競合
・自社 < 競合
```

#### 禁止事項
- 文章生成中に比較結果を変更・再解釈することは禁止
- 比較結果を後から変更することは禁止
- この比較結果は「確定値」であり、文章生成中に再解釈・変更することは禁止

#### プロンプトへの追加内容（実装済み）
```
【変更④】比較結果の確定タイミング（Critical）

▼ 比較結果の確定ルール（Critical）

monthly_review_count / monthly_post_count を含む
すべての数値比較項目について、
文章生成前に必ず以下の比較結果を確定させること：

・自社 > 競合
・自社 = 競合
・自社 < 競合

この比較結果は「確定値」であり、
文章生成中に再解釈・変更することは禁止。

文章は必ず
「確定した比較結果の理由説明」
としてのみ生成すること。

比較手順（必須）：
1. 自社の数値と競合の数値を数値型として比較
2. 比較結果（> / = / <）を確定
3. 確定した比較結果に基づいて文章を生成

禁止事項：
- 文章生成中に比較結果を変更・再解釈することは禁止
- 比較結果を後から変更することは禁止
- 数値比較と矛盾する文章を生成することは禁止
```

---

## 【変更⑤】矛盾発生時のフォールバック処理（P0）

### 現状
- ✅ **実装完了**：プロンプト内に明示的に追加済み

### 仕様定義

#### 矛盾の定義
```
以下のようなケースを「矛盾」と定義する：

- 数値比較結果が「自社 > 競合」なのに、
  文章内で「劣っている」「不足している」
  といったネガティブ表現が出る場合

- 数値比較結果が「自社 < 競合」なのに、
  根拠なく「問題ない」「影響はない」と書かれる場合
```

#### フォールバック処理
```
数値比較と文章内容が矛盾する場合：

・当該項目は
  「この項目は順位に影響していない」
  として処理すること。

矛盾したまま説明を続行することは禁止。
矛盾を"言い換え"で誤魔化す行為は禁止。
```

#### プロンプトへの追加内容（実装済み）
```
【変更⑤】矛盾発生時のフォールバック処理（Critical）

▼ 矛盾発生時の処理ルール（Critical）

以下のようなケースを「矛盾」と定義する：

- 数値比較結果が「自社 > 競合」なのに、
  文章内で「劣っている」「不足している」
  といったネガティブ表現が出る場合

- 数値比較結果が「自社 < 競合」なのに、
  根拠なく「問題ない」「影響はない」と書かれる場合

▼ 矛盾が発生した場合の処理：

- 当該項目は以下の定型表現で処理すること：

  「この項目は順位に影響していない」

- 矛盾したまま説明を継続することは禁止
- 矛盾を"言い換え"で誤魔化す行為は禁止

矛盾検出時の処理手順：
1. 矛盾を検出した時点で、当該項目の説明を停止
2. 当該項目は「この項目は順位に影響していない」として処理
3. 矛盾したまま説明を続行することは禁止

例：
- 自社の monthly_review_count が 4、競合が 1 なのに
  「自社は口コミ頻度で劣っている」と書くことは禁止
- この場合、「月間の口コミ数は順位に影響していない」と処理
```

---

## 【変更⑥】role 判別の安全設計（P0）

### 現状
- ✅ **実装済み**：`role='own'`が必ず1件のみ存在することを検証
- ✅ **実装済み**：`competitor1`/`competitor2`が複数ある場合の警告ログ

### 仕様定義

#### role='own' の検証
- **必須条件**：必ず1件のみ存在すること
- **エラー条件**：
  - 0件 → エラー（422）：`自社（role=own）の店舗データが存在しません。`
  - 複数件 → エラー（422）：`自社（role=own）の店舗データが複数存在します。1件のみ許可されています。`

#### role='competitor1' / 'competitor2' の扱い
- **許容条件**：0件でも可（任意）
- **複数存在時**：
  - 最初の1件のみ使用
  - 警告ログを出力（`[CompetitorAnalysis] multiple competitor1/2 shops detected`）

#### 実装コード（参考）
```php
// role='own' の検証
$ownShops = collect($validated['shops'])->where('role', 'own');
$ownCount = $ownShops->count();

if ($ownCount === 0) {
    return response()->json([
        'status' => 'error',
        'message' => '自社（role=own）の店舗データが存在しません。'
    ], 422);
}

if ($ownCount > 1) {
    return response()->json([
        'status' => 'error',
        'message' => '自社（role=own）の店舗データが複数存在します。1件のみ許可されています。'
    ], 422);
}
```

---

## 設計の妥当性確認

### 論理破綻の防止メカニズム

#### 1. データ構造レベル
- ✅ 頻度表現を数値に統一（曖昧さの排除）
- ✅ 数値項目を必ず`int`型に変換（型の統一）
- ✅ `0`と`__MISSING__`を明確に区別（意味の明確化）

#### 2. プロンプトレベル
- ✅ 数値比較ルールを明示（比較方法の明確化）
- ✅ 比較結果の確定タイミングを明示（実装完了）
- ✅ 矛盾発生時のフォールバック処理を明示（実装完了）

#### 3. 検証レベル
- ✅ role判別の安全設計（データの整合性保証）

### 想定される効果

#### 防止される論理破綻の例
**Before（問題のあるケース）：**
```
自社の monthly_review_count = 4
競合の monthly_review_count = 1

AI出力：「自社は口コミ頻度で劣っている」
→ 数値比較と矛盾（4 > 1 なのに「劣っている」）
```

**After（修正後）：**
```
自社の monthly_review_count = 4
競合の monthly_review_count = 1

比較結果の確定：自社 > 競合
→ 「月間の口コミ数は競合より多く、この点では優位であるため順位低下の要因ではない」
→ 数値比較と一致
```

### 設計の妥当性

#### ✅ 妥当な点
1. **データ構造の明確化**：頻度表現を数値に統一することで、比較の曖昧さを排除
2. **プロンプトの明示化**：数値比較ルールを明示することで、AIの解釈ブレを防止
3. **検証の強化**：role判別の安全設計により、データの整合性を保証

#### ✅ 実装完了
1. **比較結果の確定タイミング**：プロンプト内に明示的に追加済み
2. **矛盾発生時のフォールバック処理**：プロンプト内に明示的に追加済み

---

## 実装優先度

### P0（Critical）- 即座に実装
1. ✅ 変更①：review_frequency / post_frequency の廃止（完了）
2. ✅ 変更②：normalize() の責務明確化（完了）
3. ⚠️ 変更③：数値比較ルールの完全明文化（一部完了、要追加）
4. ⚠️ 変更④：比較結果の確定タイミング（未実装）
5. ⚠️ 変更⑤：矛盾発生時のフォールバック処理（未実装）
6. ✅ 変更⑥：role 判別の安全設計（完了）

---

## 次のステップ

### 実装が必要な項目
1. **変更④：比較結果の確定タイミング**
   - プロンプト内に「比較結果の確定タイミング」セクションを追加
   - 文章生成前に比較結果を確定させることを明示

2. **変更⑤：矛盾発生時のフォールバック処理**
   - プロンプト内に「矛盾発生時のフォールバック処理」セクションを追加
   - 矛盾が発生した場合の処理方法を明示

### 確認事項
- プロンプトの長さが適切か（OpenAIの制限内か）
- ルールが明確で、AIが理解しやすいか
- 実装後のテストケースが準備できているか

---

## まとめ

### 設計の妥当性
✅ **妥当**：この設計により、「自社の月間口コミ数が4、競合が1なのに『自社は口コミ頻度で劣っている』と書かれる」といった論理破綻は構造的に発生しなくなる。

### 実装状況
- ✅ データ構造の変更（完了）
- ✅ normalize() の責務明確化（完了）
- ✅ role判別の安全設計（完了）
- ✅ プロンプトの完全明文化（完了）

### 実装完了項目
- ✅ 変更④：比較結果の確定タイミングのプロンプト追加（完了）
- ✅ 変更⑤：矛盾発生時のフォールバック処理のプロンプト追加（完了）

