# キーワード順位トラッキング機能 実装状況調査結果

## ① キーワード登録機能の確認

### テーブル・カラム構造

**テーブル**: `meo_keywords`
- `id` (primary key)
- `shop_id` (foreign key, cascade delete)
- `keyword` (string)
- `created_at`, `updated_at` (timestamps)

**Eloquent モデル**: `App\Models\MeoKeyword`
```php
protected $fillable = [
    'shop_id',
    'keyword',
];
```

### 保存ロジック

**ファイル**: `app/Http/Controllers/ShopController.php`

**新規作成時** (`store` メソッド, 118-127行目):
```php
if ($request->has('meo_keywords')) {
    foreach ($request->meo_keywords as $keyword) {
        if (!empty(trim($keyword))) {
            MeoKeyword::create([
                'shop_id' => $shop->id,
                'keyword' => trim($keyword),
            ]);
        }
    }
}
```

**更新時** (`update` メソッド, 323-348行目):
```php
if ($request->has('meo_keywords')) {
    foreach ($request->meo_keywords as $keyword) {
        $trimmedKeyword = trim($keyword);
        if (!empty($trimmedKeyword)) {
            // 重複チェック
            $exists = $shop->meoKeywords()
                ->where('keyword', $trimmedKeyword)
                ->exists();
            
            if (!$exists) {
                MeoKeyword::create([...]);
            }
        }
    }
}
// リクエストに含まれない既存キーワードを削除
$shop->meoKeywords()
    ->whereNotIn('keyword', $requestKeywords)
    ->delete();
```

### 最大10件制限

**実装状況**: **フロントエンドのみで制限**

**ファイル**: 
- `resources/views/shops/create.blade.php` (237-246行目)
- `resources/views/shops/show.blade.php` (308-317行目)

```php
@for($i = 0; $i < 10; $i++)
    <input type="text" name="meo_keywords[]" ...>
@endfor
```

**バリデーション**: **存在しない**
- `ShopController::store()` のバリデーションルールに `meo_keywords` の件数制限はない
- `ShopController::update()` のバリデーションルールにも件数制限はない
- データベース制約もない（UNIQUE制約なし）

**結論**: フロントエンドで10件の入力欄を表示しているが、バックエンドで件数制限を強制していない。理論上は10件を超えるキーワードを登録可能。

### キーワードの有効/無効や表示順

**実装状況**: **存在しない**
- `meo_keywords` テーブルに `is_active` や `display_order` などのカラムはない
- モデルにも関連するフィールドはない
- 表示順は登録順（`id` 順）で取得されている

**取得クエリ例**:
```php
$shop->meoKeywords()  // HasMany リレーション、id順で取得
```

---

## ② 順位データの保存構造

### テーブル構造

**テーブル**: `meo_rank_logs`
- `id` (primary key)
- `meo_keyword_id` (foreign key, nullable, onDelete('set null'))
- `rank` (integer, nullable) - null=圏外
- `checked_at` (date)
- `created_at`, `updated_at` (timestamps)
- **UNIQUE制約**: `['meo_keyword_id', 'checked_at']` - 同じキーワードの同じ日付の重複を防ぐ

**Eloquent モデル**: `App\Models\MeoRankLog`
```php
protected $fillable = [
    'meo_keyword_id',
    'rank',
    'checked_at',
];

protected $casts = [
    'checked_at' => 'date',
];
```

### データ保存ロジック

**実装状況**: **完全に未実装**

**調査結果**:
- `MeoRankLog::create()` を呼び出しているコードは存在しない
- 順位を取得するAPI呼び出しも存在しない
- 順位をスクレイピングする処理も存在しない
- スケジューラで順位を取得するコマンドも存在しない

**結論**: テーブルとモデルは存在するが、実際にデータを保存する処理は一切実装されていない。**「枠だけ」の状態**。

---

## ③ 月次レポート側の取得ロジック

### コントローラー

**ファイル**: `app/Http/Controllers/ReportController.php`

**`show` メソッド** (169-217行目):
```php
$keywords = $shop->meoKeywords()
    ->with(['rankLogs' => function ($query) use ($fromStr, $toStr) {
        $query->where('checked_at', '>=', $fromStr)
              ->where('checked_at', '<=', $toStr)
              ->orderBy('checked_at');
    }])
    ->get()
    ->map(function ($keyword) use ($fromDate, $toDate) {
        $ranks = $keyword->rankLogs
            ->filter(function ($log) use ($fromDate, $toDate) {
                return $logDate->gte($fromDate) && $logDate->lte($toDate) && !is_null($log->rank);
            })
            ->pluck('rank');
        $keyword->average_rank = $ranks->isEmpty() ? null : $ranks->average();
        return $keyword;
    })
    ->sortBy(function ($keyword) {
        return $keyword->average_rank ?? 999;
    })
    ->values();

// 日付範囲の生成
$dates = [];
$currentDate = $fromDate->copy();
while ($currentDate <= $toDate) {
    $dates[] = $currentDate->format('Y-m-d');
    $currentDate->addDay();
}

// キーワードごとの日別順位データ
$rankData = [];
foreach ($keywords as $keyword) {
    $keywordRanks = [];
    foreach ($dates as $date) {
        $log = $keyword->rankLogs->first(function ($log) use ($date) {
            return $log->checked_at->format('Y-m-d') === $date;
        });
        $keywordRanks[$date] = $log ? $log->rank : null;
    }
    $rankData[$keyword->id] = [
        'keyword' => $keyword->keyword,
        'ranks' => $keywordRanks,
    ];
}
```

**`downloadPdf` メソッド** (1063-1104行目): 同様のロジック

### ビュー

**ファイル**: `resources/views/reports/show.blade.php`

**表示内容**:
- キーワード順位推移グラフ (Chart.js使用, 99-108行目)
- キーワード順位テーブル (110-149行目)
  - キーワード名 × 日付のマトリックス
  - 各セルに順位を表示（データがない場合は「—」）

**データ取得**:
```php
@foreach($keywords as $keyword)
    @foreach($dates as $date)
        @php
            $log = $keyword->rankLogs->first(function ($log) use ($date) {
                return $log->checked_at->format('Y-m-d') === $date;
            });
            $rank = $log ? $log->rank : null;
        @endphp
        @if($rank !== null)
            {{ $rank }}位
        @else
            —
        @endif
    @endforeach
@endforeach
```

### 現在の状態

**質問への回答**:
- **今は「0件」なのか**: はい。`meo_rank_logs` テーブルにデータが入っていないため、すべて「—」が表示される
- **ダミー値なのか**: いいえ。ダミー値は設定されていない
- **取得自体していないのか**: 取得ロジックは実装されているが、データが存在しないため常に `null` が返される

---

## ④ スケジューラ / バッチの有無

### 調査結果

**`app/Console/Commands/` 内のコマンド**:
- `CheckRankLogs.php` - 順位ログデータの**存在確認**のみ（取得処理なし）
- その他のコマンド: `CrawlAndPostBlogs.php`, `SendMonthlyReports.php` など（順位取得とは無関係）

**`routes/console.php`**:
```php
// 月初1日に前月分のレポートを自動送信
Schedule::command('reports:send-monthly')
    ->monthlyOn(1, '00:00')
    ->timezone('Asia/Tokyo');

// ブログ自動クロール・投稿（毎分実行）
Schedule::command('blog:crawl')
    ->everyMinute()
    ->timezone('Asia/Tokyo')
    ->withoutOverlapping();
```

**順位取得用のスケジュール**: **存在しない**

**`app/Console/Kernel.php`**: **存在しない**（Laravel 11では `routes/console.php` を使用）

### 結論

**質問への回答**:
- **すでに順位取得バッチの"骨"があるか**: いいえ。`CheckRankLogs.php` はデータ確認用のみで、取得処理は一切ない
- **完全に未実装か**: はい。順位を取得して `meo_rank_logs` に保存する処理は完全に未実装

---

## ⑤ 5000店舗想定での現実性

### 現状の設計分析

**データ量計算**:
- 5000店舗 × 最大10キーワード × 365日 = **18,250,000件/年**
- 1日あたり: 50,000件

### ボトルネック分析

#### 1. API制限

**現状**: Google検索順位を取得するAPIは実装されていない

**想定されるAPI選択肢**:
- **Google Custom Search API**: 1日100件まで（無料）、有料プランあり
- **SerpAPI / DataForSEO / Ahrefs API**: 有料、月額制限あり
- **スクレイピング**: Google利用規約違反のリスク、IPブロックのリスク

**問題点**:
- 50,000件/日を取得するには、有料APIの大量購入が必要
- 無料APIでは1日100件までしか取得できない（5000店舗×10キーワードには不十分）

#### 2. 実行時間

**現状**: 順位取得処理が未実装のため、実行時間は不明

**想定**:
- 1キーワードあたりの取得時間: 2-5秒（API呼び出し + レスポンス待機）
- 50,000件 × 3秒 = **150,000秒 = 約41.7時間**

**問題点**:
- 1日1回の実行では、1日以内に完了しない可能性が高い
- 並列処理が必要（複数プロセス/ワーカー）

#### 3. DBサイズ

**`meo_rank_logs` テーブル**:
- 1レコードあたり: 約50バイト（id, meo_keyword_id, rank, checked_at, timestamps）
- 18,250,000件/年 × 50バイト = **約912.5MB/年**

**問題点**: 比較的小さいが、長期間運用すると数GB規模になる

#### 4. 実装のボトルネック

**現状の設計の問題点**:
1. **キーワード件数制限がバックエンドで強制されていない**
   - 10件を超えるキーワードが登録される可能性
   - データ量が想定以上に増える

2. **順位取得処理が完全に未実装**
   - API選択、認証、エラーハンドリング、リトライ処理など、すべて未実装

3. **スケジューラが未設定**
   - 1日1回の自動実行が設定されていない

4. **並列処理の考慮がない**
   - 5000店舗×10キーワードを順次処理すると、実行時間が膨大

5. **エラーハンドリングがない**
   - API制限エラー、ネットワークエラー、タイムアウトなどの処理が未実装

---

## ⑥ 結論（設計せず事実だけ）

### すでに実装されている部分

1. **データベース構造**
   - `meo_keywords` テーブル（キーワード登録用）
   - `meo_rank_logs` テーブル（順位ログ保存用）
   - 外部キー制約、UNIQUE制約が適切に設定されている

2. **キーワード登録機能**
   - 店舗新規作成・編集画面でキーワードを入力可能
   - 最大10件の入力欄を表示（フロントエンド）
   - キーワードの保存・更新・削除ロジックが実装されている

3. **月次レポートの表示機能**
   - キーワード順位推移グラフ（Chart.js）
   - キーワード順位テーブル（日付×キーワードのマトリックス）
   - 平均順位の計算・ソート機能
   - PDF出力にも順位データが含まれる

4. **モデル・リレーション**
   - `Shop::meoKeywords()` - HasMany
   - `MeoKeyword::rankLogs()` - HasMany
   - `MeoKeyword::shop()` - BelongsTo
   - `MeoRankLog::meoKeyword()` - BelongsTo

5. **データ確認用コマンド**
   - `CheckRankLogs.php` - 順位ログの存在確認（デバッグ用）

### まだ存在しない部分

1. **順位取得処理**
   - Google検索順位を取得するAPI呼び出し
   - スクレイピング処理
   - 順位データの `MeoRankLog::create()` 呼び出し

2. **スケジューラ設定**
   - 1日1回の自動実行設定（`routes/console.php` に未追加）

3. **バリデーション**
   - キーワード最大10件のバックエンド制限
   - キーワードの重複チェック（店舗単位）

4. **エラーハンドリング**
   - API制限エラー処理
   - ネットワークエラー処理
   - リトライ処理

5. **並列処理**
   - 複数キーワードの並列取得
   - 複数店舗の並列処理

### 使えるもの（再利用できるもの）

1. **データベース構造**
   - `meo_keywords` テーブル
   - `meo_rank_logs` テーブル
   - 外部キー制約、UNIQUE制約

2. **モデル・リレーション**
   - `MeoKeyword` モデル
   - `MeoRankLog` モデル
   - 既存のリレーション定義

3. **月次レポートの表示ロジック**
   - `ReportController::show()` の順位データ取得ロジック
   - `ReportController::downloadPdf()` の順位データ取得ロジック
   - ビューの表示ロジック

4. **スケジューラ基盤**
   - `routes/console.php` のスケジューラ設定
   - `blog:crawl` の実装例（`withoutOverlapping()` の使用例）

### 完全にゼロから作る必要があるもの

1. **順位取得Artisanコマンド**
   - 新規作成: `app/Console/Commands/FetchKeywordRanks.php` など
   - 全店舗のキーワードを取得
   - Google検索順位を取得（APIまたはスクレイピング）
   - `MeoRankLog::create()` で保存

2. **順位取得サービス**
   - 新規作成: `app/Services/KeywordRankService.php` など
   - Google検索順位取得の実装
   - API認証・エラーハンドリング・リトライ処理

3. **スケジューラ設定**
   - `routes/console.php` に1日1回の実行設定を追加

4. **バリデーション強化**
   - `ShopController::store()` と `update()` にキーワード最大10件のバリデーション追加

5. **並列処理実装**
   - キューシステム（Laravel Queue）の活用
   - または並列実行の実装

---

## 補足: データベース構造の詳細

### meo_keywords テーブル
```sql
CREATE TABLE meo_keywords (
    id BIGINT PRIMARY KEY,
    shop_id BIGINT NOT NULL,
    keyword VARCHAR(255) NOT NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (shop_id) REFERENCES shops(id) ON DELETE CASCADE
);
```

### meo_rank_logs テーブル
```sql
CREATE TABLE meo_rank_logs (
    id BIGINT PRIMARY KEY,
    meo_keyword_id BIGINT NULLABLE,
    rank INTEGER NULLABLE,  -- null=圏外
    checked_at DATE NOT NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (meo_keyword_id) REFERENCES meo_keywords(id) ON DELETE SET NULL,
    UNIQUE(meo_keyword_id, checked_at)
);
```

**注意**: `meo_keyword_id` は `nullable` で、キーワード削除時は `SET NULL` になる（過去のログを保持するため）


## ① キーワード登録機能の確認

### テーブル・カラム構造

**テーブル**: `meo_keywords`
- `id` (primary key)
- `shop_id` (foreign key, cascade delete)
- `keyword` (string)
- `created_at`, `updated_at` (timestamps)

**Eloquent モデル**: `App\Models\MeoKeyword`
```php
protected $fillable = [
    'shop_id',
    'keyword',
];
```

### 保存ロジック

**ファイル**: `app/Http/Controllers/ShopController.php`

**新規作成時** (`store` メソッド, 118-127行目):
```php
if ($request->has('meo_keywords')) {
    foreach ($request->meo_keywords as $keyword) {
        if (!empty(trim($keyword))) {
            MeoKeyword::create([
                'shop_id' => $shop->id,
                'keyword' => trim($keyword),
            ]);
        }
    }
}
```

**更新時** (`update` メソッド, 323-348行目):
```php
if ($request->has('meo_keywords')) {
    foreach ($request->meo_keywords as $keyword) {
        $trimmedKeyword = trim($keyword);
        if (!empty($trimmedKeyword)) {
            // 重複チェック
            $exists = $shop->meoKeywords()
                ->where('keyword', $trimmedKeyword)
                ->exists();
            
            if (!$exists) {
                MeoKeyword::create([...]);
            }
        }
    }
}
// リクエストに含まれない既存キーワードを削除
$shop->meoKeywords()
    ->whereNotIn('keyword', $requestKeywords)
    ->delete();
```

### 最大10件制限

**実装状況**: **フロントエンドのみで制限**

**ファイル**: 
- `resources/views/shops/create.blade.php` (237-246行目)
- `resources/views/shops/show.blade.php` (308-317行目)

```php
@for($i = 0; $i < 10; $i++)
    <input type="text" name="meo_keywords[]" ...>
@endfor
```

**バリデーション**: **存在しない**
- `ShopController::store()` のバリデーションルールに `meo_keywords` の件数制限はない
- `ShopController::update()` のバリデーションルールにも件数制限はない
- データベース制約もない（UNIQUE制約なし）

**結論**: フロントエンドで10件の入力欄を表示しているが、バックエンドで件数制限を強制していない。理論上は10件を超えるキーワードを登録可能。

### キーワードの有効/無効や表示順

**実装状況**: **存在しない**
- `meo_keywords` テーブルに `is_active` や `display_order` などのカラムはない
- モデルにも関連するフィールドはない
- 表示順は登録順（`id` 順）で取得されている

**取得クエリ例**:
```php
$shop->meoKeywords()  // HasMany リレーション、id順で取得
```

---

## ② 順位データの保存構造

### テーブル構造

**テーブル**: `meo_rank_logs`
- `id` (primary key)
- `meo_keyword_id` (foreign key, nullable, onDelete('set null'))
- `rank` (integer, nullable) - null=圏外
- `checked_at` (date)
- `created_at`, `updated_at` (timestamps)
- **UNIQUE制約**: `['meo_keyword_id', 'checked_at']` - 同じキーワードの同じ日付の重複を防ぐ

**Eloquent モデル**: `App\Models\MeoRankLog`
```php
protected $fillable = [
    'meo_keyword_id',
    'rank',
    'checked_at',
];

protected $casts = [
    'checked_at' => 'date',
];
```

### データ保存ロジック

**実装状況**: **完全に未実装**

**調査結果**:
- `MeoRankLog::create()` を呼び出しているコードは存在しない
- 順位を取得するAPI呼び出しも存在しない
- 順位をスクレイピングする処理も存在しない
- スケジューラで順位を取得するコマンドも存在しない

**結論**: テーブルとモデルは存在するが、実際にデータを保存する処理は一切実装されていない。**「枠だけ」の状態**。

---

## ③ 月次レポート側の取得ロジック

### コントローラー

**ファイル**: `app/Http/Controllers/ReportController.php`

**`show` メソッド** (169-217行目):
```php
$keywords = $shop->meoKeywords()
    ->with(['rankLogs' => function ($query) use ($fromStr, $toStr) {
        $query->where('checked_at', '>=', $fromStr)
              ->where('checked_at', '<=', $toStr)
              ->orderBy('checked_at');
    }])
    ->get()
    ->map(function ($keyword) use ($fromDate, $toDate) {
        $ranks = $keyword->rankLogs
            ->filter(function ($log) use ($fromDate, $toDate) {
                return $logDate->gte($fromDate) && $logDate->lte($toDate) && !is_null($log->rank);
            })
            ->pluck('rank');
        $keyword->average_rank = $ranks->isEmpty() ? null : $ranks->average();
        return $keyword;
    })
    ->sortBy(function ($keyword) {
        return $keyword->average_rank ?? 999;
    })
    ->values();

// 日付範囲の生成
$dates = [];
$currentDate = $fromDate->copy();
while ($currentDate <= $toDate) {
    $dates[] = $currentDate->format('Y-m-d');
    $currentDate->addDay();
}

// キーワードごとの日別順位データ
$rankData = [];
foreach ($keywords as $keyword) {
    $keywordRanks = [];
    foreach ($dates as $date) {
        $log = $keyword->rankLogs->first(function ($log) use ($date) {
            return $log->checked_at->format('Y-m-d') === $date;
        });
        $keywordRanks[$date] = $log ? $log->rank : null;
    }
    $rankData[$keyword->id] = [
        'keyword' => $keyword->keyword,
        'ranks' => $keywordRanks,
    ];
}
```

**`downloadPdf` メソッド** (1063-1104行目): 同様のロジック

### ビュー

**ファイル**: `resources/views/reports/show.blade.php`

**表示内容**:
- キーワード順位推移グラフ (Chart.js使用, 99-108行目)
- キーワード順位テーブル (110-149行目)
  - キーワード名 × 日付のマトリックス
  - 各セルに順位を表示（データがない場合は「—」）

**データ取得**:
```php
@foreach($keywords as $keyword)
    @foreach($dates as $date)
        @php
            $log = $keyword->rankLogs->first(function ($log) use ($date) {
                return $log->checked_at->format('Y-m-d') === $date;
            });
            $rank = $log ? $log->rank : null;
        @endphp
        @if($rank !== null)
            {{ $rank }}位
        @else
            —
        @endif
    @endforeach
@endforeach
```

### 現在の状態

**質問への回答**:
- **今は「0件」なのか**: はい。`meo_rank_logs` テーブルにデータが入っていないため、すべて「—」が表示される
- **ダミー値なのか**: いいえ。ダミー値は設定されていない
- **取得自体していないのか**: 取得ロジックは実装されているが、データが存在しないため常に `null` が返される

---

## ④ スケジューラ / バッチの有無

### 調査結果

**`app/Console/Commands/` 内のコマンド**:
- `CheckRankLogs.php` - 順位ログデータの**存在確認**のみ（取得処理なし）
- その他のコマンド: `CrawlAndPostBlogs.php`, `SendMonthlyReports.php` など（順位取得とは無関係）

**`routes/console.php`**:
```php
// 月初1日に前月分のレポートを自動送信
Schedule::command('reports:send-monthly')
    ->monthlyOn(1, '00:00')
    ->timezone('Asia/Tokyo');

// ブログ自動クロール・投稿（毎分実行）
Schedule::command('blog:crawl')
    ->everyMinute()
    ->timezone('Asia/Tokyo')
    ->withoutOverlapping();
```

**順位取得用のスケジュール**: **存在しない**

**`app/Console/Kernel.php`**: **存在しない**（Laravel 11では `routes/console.php` を使用）

### 結論

**質問への回答**:
- **すでに順位取得バッチの"骨"があるか**: いいえ。`CheckRankLogs.php` はデータ確認用のみで、取得処理は一切ない
- **完全に未実装か**: はい。順位を取得して `meo_rank_logs` に保存する処理は完全に未実装

---

## ⑤ 5000店舗想定での現実性

### 現状の設計分析

**データ量計算**:
- 5000店舗 × 最大10キーワード × 365日 = **18,250,000件/年**
- 1日あたり: 50,000件

### ボトルネック分析

#### 1. API制限

**現状**: Google検索順位を取得するAPIは実装されていない

**想定されるAPI選択肢**:
- **Google Custom Search API**: 1日100件まで（無料）、有料プランあり
- **SerpAPI / DataForSEO / Ahrefs API**: 有料、月額制限あり
- **スクレイピング**: Google利用規約違反のリスク、IPブロックのリスク

**問題点**:
- 50,000件/日を取得するには、有料APIの大量購入が必要
- 無料APIでは1日100件までしか取得できない（5000店舗×10キーワードには不十分）

#### 2. 実行時間

**現状**: 順位取得処理が未実装のため、実行時間は不明

**想定**:
- 1キーワードあたりの取得時間: 2-5秒（API呼び出し + レスポンス待機）
- 50,000件 × 3秒 = **150,000秒 = 約41.7時間**

**問題点**:
- 1日1回の実行では、1日以内に完了しない可能性が高い
- 並列処理が必要（複数プロセス/ワーカー）

#### 3. DBサイズ

**`meo_rank_logs` テーブル**:
- 1レコードあたり: 約50バイト（id, meo_keyword_id, rank, checked_at, timestamps）
- 18,250,000件/年 × 50バイト = **約912.5MB/年**

**問題点**: 比較的小さいが、長期間運用すると数GB規模になる

#### 4. 実装のボトルネック

**現状の設計の問題点**:
1. **キーワード件数制限がバックエンドで強制されていない**
   - 10件を超えるキーワードが登録される可能性
   - データ量が想定以上に増える

2. **順位取得処理が完全に未実装**
   - API選択、認証、エラーハンドリング、リトライ処理など、すべて未実装

3. **スケジューラが未設定**
   - 1日1回の自動実行が設定されていない

4. **並列処理の考慮がない**
   - 5000店舗×10キーワードを順次処理すると、実行時間が膨大

5. **エラーハンドリングがない**
   - API制限エラー、ネットワークエラー、タイムアウトなどの処理が未実装

---

## ⑥ 結論（設計せず事実だけ）

### すでに実装されている部分

1. **データベース構造**
   - `meo_keywords` テーブル（キーワード登録用）
   - `meo_rank_logs` テーブル（順位ログ保存用）
   - 外部キー制約、UNIQUE制約が適切に設定されている

2. **キーワード登録機能**
   - 店舗新規作成・編集画面でキーワードを入力可能
   - 最大10件の入力欄を表示（フロントエンド）
   - キーワードの保存・更新・削除ロジックが実装されている

3. **月次レポートの表示機能**
   - キーワード順位推移グラフ（Chart.js）
   - キーワード順位テーブル（日付×キーワードのマトリックス）
   - 平均順位の計算・ソート機能
   - PDF出力にも順位データが含まれる

4. **モデル・リレーション**
   - `Shop::meoKeywords()` - HasMany
   - `MeoKeyword::rankLogs()` - HasMany
   - `MeoKeyword::shop()` - BelongsTo
   - `MeoRankLog::meoKeyword()` - BelongsTo

5. **データ確認用コマンド**
   - `CheckRankLogs.php` - 順位ログの存在確認（デバッグ用）

### まだ存在しない部分

1. **順位取得処理**
   - Google検索順位を取得するAPI呼び出し
   - スクレイピング処理
   - 順位データの `MeoRankLog::create()` 呼び出し

2. **スケジューラ設定**
   - 1日1回の自動実行設定（`routes/console.php` に未追加）

3. **バリデーション**
   - キーワード最大10件のバックエンド制限
   - キーワードの重複チェック（店舗単位）

4. **エラーハンドリング**
   - API制限エラー処理
   - ネットワークエラー処理
   - リトライ処理

5. **並列処理**
   - 複数キーワードの並列取得
   - 複数店舗の並列処理

### 使えるもの（再利用できるもの）

1. **データベース構造**
   - `meo_keywords` テーブル
   - `meo_rank_logs` テーブル
   - 外部キー制約、UNIQUE制約

2. **モデル・リレーション**
   - `MeoKeyword` モデル
   - `MeoRankLog` モデル
   - 既存のリレーション定義

3. **月次レポートの表示ロジック**
   - `ReportController::show()` の順位データ取得ロジック
   - `ReportController::downloadPdf()` の順位データ取得ロジック
   - ビューの表示ロジック

4. **スケジューラ基盤**
   - `routes/console.php` のスケジューラ設定
   - `blog:crawl` の実装例（`withoutOverlapping()` の使用例）

### 完全にゼロから作る必要があるもの

1. **順位取得Artisanコマンド**
   - 新規作成: `app/Console/Commands/FetchKeywordRanks.php` など
   - 全店舗のキーワードを取得
   - Google検索順位を取得（APIまたはスクレイピング）
   - `MeoRankLog::create()` で保存

2. **順位取得サービス**
   - 新規作成: `app/Services/KeywordRankService.php` など
   - Google検索順位取得の実装
   - API認証・エラーハンドリング・リトライ処理

3. **スケジューラ設定**
   - `routes/console.php` に1日1回の実行設定を追加

4. **バリデーション強化**
   - `ShopController::store()` と `update()` にキーワード最大10件のバリデーション追加

5. **並列処理実装**
   - キューシステム（Laravel Queue）の活用
   - または並列実行の実装

---

## 補足: データベース構造の詳細

### meo_keywords テーブル
```sql
CREATE TABLE meo_keywords (
    id BIGINT PRIMARY KEY,
    shop_id BIGINT NOT NULL,
    keyword VARCHAR(255) NOT NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (shop_id) REFERENCES shops(id) ON DELETE CASCADE
);
```

### meo_rank_logs テーブル
```sql
CREATE TABLE meo_rank_logs (
    id BIGINT PRIMARY KEY,
    meo_keyword_id BIGINT NULLABLE,
    rank INTEGER NULLABLE,  -- null=圏外
    checked_at DATE NOT NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (meo_keyword_id) REFERENCES meo_keywords(id) ON DELETE SET NULL,
    UNIQUE(meo_keyword_id, checked_at)
);
```

**注意**: `meo_keyword_id` は `nullable` で、キーワード削除時は `SET NULL` になる（過去のログを保持するため）


## ① キーワード登録機能の確認

### テーブル・カラム構造

**テーブル**: `meo_keywords`
- `id` (primary key)
- `shop_id` (foreign key, cascade delete)
- `keyword` (string)
- `created_at`, `updated_at` (timestamps)

**Eloquent モデル**: `App\Models\MeoKeyword`
```php
protected $fillable = [
    'shop_id',
    'keyword',
];
```

### 保存ロジック

**ファイル**: `app/Http/Controllers/ShopController.php`

**新規作成時** (`store` メソッド, 118-127行目):
```php
if ($request->has('meo_keywords')) {
    foreach ($request->meo_keywords as $keyword) {
        if (!empty(trim($keyword))) {
            MeoKeyword::create([
                'shop_id' => $shop->id,
                'keyword' => trim($keyword),
            ]);
        }
    }
}
```

**更新時** (`update` メソッド, 323-348行目):
```php
if ($request->has('meo_keywords')) {
    foreach ($request->meo_keywords as $keyword) {
        $trimmedKeyword = trim($keyword);
        if (!empty($trimmedKeyword)) {
            // 重複チェック
            $exists = $shop->meoKeywords()
                ->where('keyword', $trimmedKeyword)
                ->exists();
            
            if (!$exists) {
                MeoKeyword::create([...]);
            }
        }
    }
}
// リクエストに含まれない既存キーワードを削除
$shop->meoKeywords()
    ->whereNotIn('keyword', $requestKeywords)
    ->delete();
```

### 最大10件制限

**実装状況**: **フロントエンドのみで制限**

**ファイル**: 
- `resources/views/shops/create.blade.php` (237-246行目)
- `resources/views/shops/show.blade.php` (308-317行目)

```php
@for($i = 0; $i < 10; $i++)
    <input type="text" name="meo_keywords[]" ...>
@endfor
```

**バリデーション**: **存在しない**
- `ShopController::store()` のバリデーションルールに `meo_keywords` の件数制限はない
- `ShopController::update()` のバリデーションルールにも件数制限はない
- データベース制約もない（UNIQUE制約なし）

**結論**: フロントエンドで10件の入力欄を表示しているが、バックエンドで件数制限を強制していない。理論上は10件を超えるキーワードを登録可能。

### キーワードの有効/無効や表示順

**実装状況**: **存在しない**
- `meo_keywords` テーブルに `is_active` や `display_order` などのカラムはない
- モデルにも関連するフィールドはない
- 表示順は登録順（`id` 順）で取得されている

**取得クエリ例**:
```php
$shop->meoKeywords()  // HasMany リレーション、id順で取得
```

---

## ② 順位データの保存構造

### テーブル構造

**テーブル**: `meo_rank_logs`
- `id` (primary key)
- `meo_keyword_id` (foreign key, nullable, onDelete('set null'))
- `rank` (integer, nullable) - null=圏外
- `checked_at` (date)
- `created_at`, `updated_at` (timestamps)
- **UNIQUE制約**: `['meo_keyword_id', 'checked_at']` - 同じキーワードの同じ日付の重複を防ぐ

**Eloquent モデル**: `App\Models\MeoRankLog`
```php
protected $fillable = [
    'meo_keyword_id',
    'rank',
    'checked_at',
];

protected $casts = [
    'checked_at' => 'date',
];
```

### データ保存ロジック

**実装状況**: **完全に未実装**

**調査結果**:
- `MeoRankLog::create()` を呼び出しているコードは存在しない
- 順位を取得するAPI呼び出しも存在しない
- 順位をスクレイピングする処理も存在しない
- スケジューラで順位を取得するコマンドも存在しない

**結論**: テーブルとモデルは存在するが、実際にデータを保存する処理は一切実装されていない。**「枠だけ」の状態**。

---

## ③ 月次レポート側の取得ロジック

### コントローラー

**ファイル**: `app/Http/Controllers/ReportController.php`

**`show` メソッド** (169-217行目):
```php
$keywords = $shop->meoKeywords()
    ->with(['rankLogs' => function ($query) use ($fromStr, $toStr) {
        $query->where('checked_at', '>=', $fromStr)
              ->where('checked_at', '<=', $toStr)
              ->orderBy('checked_at');
    }])
    ->get()
    ->map(function ($keyword) use ($fromDate, $toDate) {
        $ranks = $keyword->rankLogs
            ->filter(function ($log) use ($fromDate, $toDate) {
                return $logDate->gte($fromDate) && $logDate->lte($toDate) && !is_null($log->rank);
            })
            ->pluck('rank');
        $keyword->average_rank = $ranks->isEmpty() ? null : $ranks->average();
        return $keyword;
    })
    ->sortBy(function ($keyword) {
        return $keyword->average_rank ?? 999;
    })
    ->values();

// 日付範囲の生成
$dates = [];
$currentDate = $fromDate->copy();
while ($currentDate <= $toDate) {
    $dates[] = $currentDate->format('Y-m-d');
    $currentDate->addDay();
}

// キーワードごとの日別順位データ
$rankData = [];
foreach ($keywords as $keyword) {
    $keywordRanks = [];
    foreach ($dates as $date) {
        $log = $keyword->rankLogs->first(function ($log) use ($date) {
            return $log->checked_at->format('Y-m-d') === $date;
        });
        $keywordRanks[$date] = $log ? $log->rank : null;
    }
    $rankData[$keyword->id] = [
        'keyword' => $keyword->keyword,
        'ranks' => $keywordRanks,
    ];
}
```

**`downloadPdf` メソッド** (1063-1104行目): 同様のロジック

### ビュー

**ファイル**: `resources/views/reports/show.blade.php`

**表示内容**:
- キーワード順位推移グラフ (Chart.js使用, 99-108行目)
- キーワード順位テーブル (110-149行目)
  - キーワード名 × 日付のマトリックス
  - 各セルに順位を表示（データがない場合は「—」）

**データ取得**:
```php
@foreach($keywords as $keyword)
    @foreach($dates as $date)
        @php
            $log = $keyword->rankLogs->first(function ($log) use ($date) {
                return $log->checked_at->format('Y-m-d') === $date;
            });
            $rank = $log ? $log->rank : null;
        @endphp
        @if($rank !== null)
            {{ $rank }}位
        @else
            —
        @endif
    @endforeach
@endforeach
```

### 現在の状態

**質問への回答**:
- **今は「0件」なのか**: はい。`meo_rank_logs` テーブルにデータが入っていないため、すべて「—」が表示される
- **ダミー値なのか**: いいえ。ダミー値は設定されていない
- **取得自体していないのか**: 取得ロジックは実装されているが、データが存在しないため常に `null` が返される

---

## ④ スケジューラ / バッチの有無

### 調査結果

**`app/Console/Commands/` 内のコマンド**:
- `CheckRankLogs.php` - 順位ログデータの**存在確認**のみ（取得処理なし）
- その他のコマンド: `CrawlAndPostBlogs.php`, `SendMonthlyReports.php` など（順位取得とは無関係）

**`routes/console.php`**:
```php
// 月初1日に前月分のレポートを自動送信
Schedule::command('reports:send-monthly')
    ->monthlyOn(1, '00:00')
    ->timezone('Asia/Tokyo');

// ブログ自動クロール・投稿（毎分実行）
Schedule::command('blog:crawl')
    ->everyMinute()
    ->timezone('Asia/Tokyo')
    ->withoutOverlapping();
```

**順位取得用のスケジュール**: **存在しない**

**`app/Console/Kernel.php`**: **存在しない**（Laravel 11では `routes/console.php` を使用）

### 結論

**質問への回答**:
- **すでに順位取得バッチの"骨"があるか**: いいえ。`CheckRankLogs.php` はデータ確認用のみで、取得処理は一切ない
- **完全に未実装か**: はい。順位を取得して `meo_rank_logs` に保存する処理は完全に未実装

---

## ⑤ 5000店舗想定での現実性

### 現状の設計分析

**データ量計算**:
- 5000店舗 × 最大10キーワード × 365日 = **18,250,000件/年**
- 1日あたり: 50,000件

### ボトルネック分析

#### 1. API制限

**現状**: Google検索順位を取得するAPIは実装されていない

**想定されるAPI選択肢**:
- **Google Custom Search API**: 1日100件まで（無料）、有料プランあり
- **SerpAPI / DataForSEO / Ahrefs API**: 有料、月額制限あり
- **スクレイピング**: Google利用規約違反のリスク、IPブロックのリスク

**問題点**:
- 50,000件/日を取得するには、有料APIの大量購入が必要
- 無料APIでは1日100件までしか取得できない（5000店舗×10キーワードには不十分）

#### 2. 実行時間

**現状**: 順位取得処理が未実装のため、実行時間は不明

**想定**:
- 1キーワードあたりの取得時間: 2-5秒（API呼び出し + レスポンス待機）
- 50,000件 × 3秒 = **150,000秒 = 約41.7時間**

**問題点**:
- 1日1回の実行では、1日以内に完了しない可能性が高い
- 並列処理が必要（複数プロセス/ワーカー）

#### 3. DBサイズ

**`meo_rank_logs` テーブル**:
- 1レコードあたり: 約50バイト（id, meo_keyword_id, rank, checked_at, timestamps）
- 18,250,000件/年 × 50バイト = **約912.5MB/年**

**問題点**: 比較的小さいが、長期間運用すると数GB規模になる

#### 4. 実装のボトルネック

**現状の設計の問題点**:
1. **キーワード件数制限がバックエンドで強制されていない**
   - 10件を超えるキーワードが登録される可能性
   - データ量が想定以上に増える

2. **順位取得処理が完全に未実装**
   - API選択、認証、エラーハンドリング、リトライ処理など、すべて未実装

3. **スケジューラが未設定**
   - 1日1回の自動実行が設定されていない

4. **並列処理の考慮がない**
   - 5000店舗×10キーワードを順次処理すると、実行時間が膨大

5. **エラーハンドリングがない**
   - API制限エラー、ネットワークエラー、タイムアウトなどの処理が未実装

---

## ⑥ 結論（設計せず事実だけ）

### すでに実装されている部分

1. **データベース構造**
   - `meo_keywords` テーブル（キーワード登録用）
   - `meo_rank_logs` テーブル（順位ログ保存用）
   - 外部キー制約、UNIQUE制約が適切に設定されている

2. **キーワード登録機能**
   - 店舗新規作成・編集画面でキーワードを入力可能
   - 最大10件の入力欄を表示（フロントエンド）
   - キーワードの保存・更新・削除ロジックが実装されている

3. **月次レポートの表示機能**
   - キーワード順位推移グラフ（Chart.js）
   - キーワード順位テーブル（日付×キーワードのマトリックス）
   - 平均順位の計算・ソート機能
   - PDF出力にも順位データが含まれる

4. **モデル・リレーション**
   - `Shop::meoKeywords()` - HasMany
   - `MeoKeyword::rankLogs()` - HasMany
   - `MeoKeyword::shop()` - BelongsTo
   - `MeoRankLog::meoKeyword()` - BelongsTo

5. **データ確認用コマンド**
   - `CheckRankLogs.php` - 順位ログの存在確認（デバッグ用）

### まだ存在しない部分

1. **順位取得処理**
   - Google検索順位を取得するAPI呼び出し
   - スクレイピング処理
   - 順位データの `MeoRankLog::create()` 呼び出し

2. **スケジューラ設定**
   - 1日1回の自動実行設定（`routes/console.php` に未追加）

3. **バリデーション**
   - キーワード最大10件のバックエンド制限
   - キーワードの重複チェック（店舗単位）

4. **エラーハンドリング**
   - API制限エラー処理
   - ネットワークエラー処理
   - リトライ処理

5. **並列処理**
   - 複数キーワードの並列取得
   - 複数店舗の並列処理

### 使えるもの（再利用できるもの）

1. **データベース構造**
   - `meo_keywords` テーブル
   - `meo_rank_logs` テーブル
   - 外部キー制約、UNIQUE制約

2. **モデル・リレーション**
   - `MeoKeyword` モデル
   - `MeoRankLog` モデル
   - 既存のリレーション定義

3. **月次レポートの表示ロジック**
   - `ReportController::show()` の順位データ取得ロジック
   - `ReportController::downloadPdf()` の順位データ取得ロジック
   - ビューの表示ロジック

4. **スケジューラ基盤**
   - `routes/console.php` のスケジューラ設定
   - `blog:crawl` の実装例（`withoutOverlapping()` の使用例）

### 完全にゼロから作る必要があるもの

1. **順位取得Artisanコマンド**
   - 新規作成: `app/Console/Commands/FetchKeywordRanks.php` など
   - 全店舗のキーワードを取得
   - Google検索順位を取得（APIまたはスクレイピング）
   - `MeoRankLog::create()` で保存

2. **順位取得サービス**
   - 新規作成: `app/Services/KeywordRankService.php` など
   - Google検索順位取得の実装
   - API認証・エラーハンドリング・リトライ処理

3. **スケジューラ設定**
   - `routes/console.php` に1日1回の実行設定を追加

4. **バリデーション強化**
   - `ShopController::store()` と `update()` にキーワード最大10件のバリデーション追加

5. **並列処理実装**
   - キューシステム（Laravel Queue）の活用
   - または並列実行の実装

---

## 補足: データベース構造の詳細

### meo_keywords テーブル
```sql
CREATE TABLE meo_keywords (
    id BIGINT PRIMARY KEY,
    shop_id BIGINT NOT NULL,
    keyword VARCHAR(255) NOT NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (shop_id) REFERENCES shops(id) ON DELETE CASCADE
);
```

### meo_rank_logs テーブル
```sql
CREATE TABLE meo_rank_logs (
    id BIGINT PRIMARY KEY,
    meo_keyword_id BIGINT NULLABLE,
    rank INTEGER NULLABLE,  -- null=圏外
    checked_at DATE NOT NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (meo_keyword_id) REFERENCES meo_keywords(id) ON DELETE SET NULL,
    UNIQUE(meo_keyword_id, checked_at)
);
```

**注意**: `meo_keyword_id` は `nullable` で、キーワード削除時は `SET NULL` になる（過去のログを保持するため）


## ① キーワード登録機能の確認

### テーブル・カラム構造

**テーブル**: `meo_keywords`
- `id` (primary key)
- `shop_id` (foreign key, cascade delete)
- `keyword` (string)
- `created_at`, `updated_at` (timestamps)

**Eloquent モデル**: `App\Models\MeoKeyword`
```php
protected $fillable = [
    'shop_id',
    'keyword',
];
```

### 保存ロジック

**ファイル**: `app/Http/Controllers/ShopController.php`

**新規作成時** (`store` メソッド, 118-127行目):
```php
if ($request->has('meo_keywords')) {
    foreach ($request->meo_keywords as $keyword) {
        if (!empty(trim($keyword))) {
            MeoKeyword::create([
                'shop_id' => $shop->id,
                'keyword' => trim($keyword),
            ]);
        }
    }
}
```

**更新時** (`update` メソッド, 323-348行目):
```php
if ($request->has('meo_keywords')) {
    foreach ($request->meo_keywords as $keyword) {
        $trimmedKeyword = trim($keyword);
        if (!empty($trimmedKeyword)) {
            // 重複チェック
            $exists = $shop->meoKeywords()
                ->where('keyword', $trimmedKeyword)
                ->exists();
            
            if (!$exists) {
                MeoKeyword::create([...]);
            }
        }
    }
}
// リクエストに含まれない既存キーワードを削除
$shop->meoKeywords()
    ->whereNotIn('keyword', $requestKeywords)
    ->delete();
```

### 最大10件制限

**実装状況**: **フロントエンドのみで制限**

**ファイル**: 
- `resources/views/shops/create.blade.php` (237-246行目)
- `resources/views/shops/show.blade.php` (308-317行目)

```php
@for($i = 0; $i < 10; $i++)
    <input type="text" name="meo_keywords[]" ...>
@endfor
```

**バリデーション**: **存在しない**
- `ShopController::store()` のバリデーションルールに `meo_keywords` の件数制限はない
- `ShopController::update()` のバリデーションルールにも件数制限はない
- データベース制約もない（UNIQUE制約なし）

**結論**: フロントエンドで10件の入力欄を表示しているが、バックエンドで件数制限を強制していない。理論上は10件を超えるキーワードを登録可能。

### キーワードの有効/無効や表示順

**実装状況**: **存在しない**
- `meo_keywords` テーブルに `is_active` や `display_order` などのカラムはない
- モデルにも関連するフィールドはない
- 表示順は登録順（`id` 順）で取得されている

**取得クエリ例**:
```php
$shop->meoKeywords()  // HasMany リレーション、id順で取得
```

---

## ② 順位データの保存構造

### テーブル構造

**テーブル**: `meo_rank_logs`
- `id` (primary key)
- `meo_keyword_id` (foreign key, nullable, onDelete('set null'))
- `rank` (integer, nullable) - null=圏外
- `checked_at` (date)
- `created_at`, `updated_at` (timestamps)
- **UNIQUE制約**: `['meo_keyword_id', 'checked_at']` - 同じキーワードの同じ日付の重複を防ぐ

**Eloquent モデル**: `App\Models\MeoRankLog`
```php
protected $fillable = [
    'meo_keyword_id',
    'rank',
    'checked_at',
];

protected $casts = [
    'checked_at' => 'date',
];
```

### データ保存ロジック

**実装状況**: **完全に未実装**

**調査結果**:
- `MeoRankLog::create()` を呼び出しているコードは存在しない
- 順位を取得するAPI呼び出しも存在しない
- 順位をスクレイピングする処理も存在しない
- スケジューラで順位を取得するコマンドも存在しない

**結論**: テーブルとモデルは存在するが、実際にデータを保存する処理は一切実装されていない。**「枠だけ」の状態**。

---

## ③ 月次レポート側の取得ロジック

### コントローラー

**ファイル**: `app/Http/Controllers/ReportController.php`

**`show` メソッド** (169-217行目):
```php
$keywords = $shop->meoKeywords()
    ->with(['rankLogs' => function ($query) use ($fromStr, $toStr) {
        $query->where('checked_at', '>=', $fromStr)
              ->where('checked_at', '<=', $toStr)
              ->orderBy('checked_at');
    }])
    ->get()
    ->map(function ($keyword) use ($fromDate, $toDate) {
        $ranks = $keyword->rankLogs
            ->filter(function ($log) use ($fromDate, $toDate) {
                return $logDate->gte($fromDate) && $logDate->lte($toDate) && !is_null($log->rank);
            })
            ->pluck('rank');
        $keyword->average_rank = $ranks->isEmpty() ? null : $ranks->average();
        return $keyword;
    })
    ->sortBy(function ($keyword) {
        return $keyword->average_rank ?? 999;
    })
    ->values();

// 日付範囲の生成
$dates = [];
$currentDate = $fromDate->copy();
while ($currentDate <= $toDate) {
    $dates[] = $currentDate->format('Y-m-d');
    $currentDate->addDay();
}

// キーワードごとの日別順位データ
$rankData = [];
foreach ($keywords as $keyword) {
    $keywordRanks = [];
    foreach ($dates as $date) {
        $log = $keyword->rankLogs->first(function ($log) use ($date) {
            return $log->checked_at->format('Y-m-d') === $date;
        });
        $keywordRanks[$date] = $log ? $log->rank : null;
    }
    $rankData[$keyword->id] = [
        'keyword' => $keyword->keyword,
        'ranks' => $keywordRanks,
    ];
}
```

**`downloadPdf` メソッド** (1063-1104行目): 同様のロジック

### ビュー

**ファイル**: `resources/views/reports/show.blade.php`

**表示内容**:
- キーワード順位推移グラフ (Chart.js使用, 99-108行目)
- キーワード順位テーブル (110-149行目)
  - キーワード名 × 日付のマトリックス
  - 各セルに順位を表示（データがない場合は「—」）

**データ取得**:
```php
@foreach($keywords as $keyword)
    @foreach($dates as $date)
        @php
            $log = $keyword->rankLogs->first(function ($log) use ($date) {
                return $log->checked_at->format('Y-m-d') === $date;
            });
            $rank = $log ? $log->rank : null;
        @endphp
        @if($rank !== null)
            {{ $rank }}位
        @else
            —
        @endif
    @endforeach
@endforeach
```

### 現在の状態

**質問への回答**:
- **今は「0件」なのか**: はい。`meo_rank_logs` テーブルにデータが入っていないため、すべて「—」が表示される
- **ダミー値なのか**: いいえ。ダミー値は設定されていない
- **取得自体していないのか**: 取得ロジックは実装されているが、データが存在しないため常に `null` が返される

---

## ④ スケジューラ / バッチの有無

### 調査結果

**`app/Console/Commands/` 内のコマンド**:
- `CheckRankLogs.php` - 順位ログデータの**存在確認**のみ（取得処理なし）
- その他のコマンド: `CrawlAndPostBlogs.php`, `SendMonthlyReports.php` など（順位取得とは無関係）

**`routes/console.php`**:
```php
// 月初1日に前月分のレポートを自動送信
Schedule::command('reports:send-monthly')
    ->monthlyOn(1, '00:00')
    ->timezone('Asia/Tokyo');

// ブログ自動クロール・投稿（毎分実行）
Schedule::command('blog:crawl')
    ->everyMinute()
    ->timezone('Asia/Tokyo')
    ->withoutOverlapping();
```

**順位取得用のスケジュール**: **存在しない**

**`app/Console/Kernel.php`**: **存在しない**（Laravel 11では `routes/console.php` を使用）

### 結論

**質問への回答**:
- **すでに順位取得バッチの"骨"があるか**: いいえ。`CheckRankLogs.php` はデータ確認用のみで、取得処理は一切ない
- **完全に未実装か**: はい。順位を取得して `meo_rank_logs` に保存する処理は完全に未実装

---

## ⑤ 5000店舗想定での現実性

### 現状の設計分析

**データ量計算**:
- 5000店舗 × 最大10キーワード × 365日 = **18,250,000件/年**
- 1日あたり: 50,000件

### ボトルネック分析

#### 1. API制限

**現状**: Google検索順位を取得するAPIは実装されていない

**想定されるAPI選択肢**:
- **Google Custom Search API**: 1日100件まで（無料）、有料プランあり
- **SerpAPI / DataForSEO / Ahrefs API**: 有料、月額制限あり
- **スクレイピング**: Google利用規約違反のリスク、IPブロックのリスク

**問題点**:
- 50,000件/日を取得するには、有料APIの大量購入が必要
- 無料APIでは1日100件までしか取得できない（5000店舗×10キーワードには不十分）

#### 2. 実行時間

**現状**: 順位取得処理が未実装のため、実行時間は不明

**想定**:
- 1キーワードあたりの取得時間: 2-5秒（API呼び出し + レスポンス待機）
- 50,000件 × 3秒 = **150,000秒 = 約41.7時間**

**問題点**:
- 1日1回の実行では、1日以内に完了しない可能性が高い
- 並列処理が必要（複数プロセス/ワーカー）

#### 3. DBサイズ

**`meo_rank_logs` テーブル**:
- 1レコードあたり: 約50バイト（id, meo_keyword_id, rank, checked_at, timestamps）
- 18,250,000件/年 × 50バイト = **約912.5MB/年**

**問題点**: 比較的小さいが、長期間運用すると数GB規模になる

#### 4. 実装のボトルネック

**現状の設計の問題点**:
1. **キーワード件数制限がバックエンドで強制されていない**
   - 10件を超えるキーワードが登録される可能性
   - データ量が想定以上に増える

2. **順位取得処理が完全に未実装**
   - API選択、認証、エラーハンドリング、リトライ処理など、すべて未実装

3. **スケジューラが未設定**
   - 1日1回の自動実行が設定されていない

4. **並列処理の考慮がない**
   - 5000店舗×10キーワードを順次処理すると、実行時間が膨大

5. **エラーハンドリングがない**
   - API制限エラー、ネットワークエラー、タイムアウトなどの処理が未実装

---

## ⑥ 結論（設計せず事実だけ）

### すでに実装されている部分

1. **データベース構造**
   - `meo_keywords` テーブル（キーワード登録用）
   - `meo_rank_logs` テーブル（順位ログ保存用）
   - 外部キー制約、UNIQUE制約が適切に設定されている

2. **キーワード登録機能**
   - 店舗新規作成・編集画面でキーワードを入力可能
   - 最大10件の入力欄を表示（フロントエンド）
   - キーワードの保存・更新・削除ロジックが実装されている

3. **月次レポートの表示機能**
   - キーワード順位推移グラフ（Chart.js）
   - キーワード順位テーブル（日付×キーワードのマトリックス）
   - 平均順位の計算・ソート機能
   - PDF出力にも順位データが含まれる

4. **モデル・リレーション**
   - `Shop::meoKeywords()` - HasMany
   - `MeoKeyword::rankLogs()` - HasMany
   - `MeoKeyword::shop()` - BelongsTo
   - `MeoRankLog::meoKeyword()` - BelongsTo

5. **データ確認用コマンド**
   - `CheckRankLogs.php` - 順位ログの存在確認（デバッグ用）

### まだ存在しない部分

1. **順位取得処理**
   - Google検索順位を取得するAPI呼び出し
   - スクレイピング処理
   - 順位データの `MeoRankLog::create()` 呼び出し

2. **スケジューラ設定**
   - 1日1回の自動実行設定（`routes/console.php` に未追加）

3. **バリデーション**
   - キーワード最大10件のバックエンド制限
   - キーワードの重複チェック（店舗単位）

4. **エラーハンドリング**
   - API制限エラー処理
   - ネットワークエラー処理
   - リトライ処理

5. **並列処理**
   - 複数キーワードの並列取得
   - 複数店舗の並列処理

### 使えるもの（再利用できるもの）

1. **データベース構造**
   - `meo_keywords` テーブル
   - `meo_rank_logs` テーブル
   - 外部キー制約、UNIQUE制約

2. **モデル・リレーション**
   - `MeoKeyword` モデル
   - `MeoRankLog` モデル
   - 既存のリレーション定義

3. **月次レポートの表示ロジック**
   - `ReportController::show()` の順位データ取得ロジック
   - `ReportController::downloadPdf()` の順位データ取得ロジック
   - ビューの表示ロジック

4. **スケジューラ基盤**
   - `routes/console.php` のスケジューラ設定
   - `blog:crawl` の実装例（`withoutOverlapping()` の使用例）

### 完全にゼロから作る必要があるもの

1. **順位取得Artisanコマンド**
   - 新規作成: `app/Console/Commands/FetchKeywordRanks.php` など
   - 全店舗のキーワードを取得
   - Google検索順位を取得（APIまたはスクレイピング）
   - `MeoRankLog::create()` で保存

2. **順位取得サービス**
   - 新規作成: `app/Services/KeywordRankService.php` など
   - Google検索順位取得の実装
   - API認証・エラーハンドリング・リトライ処理

3. **スケジューラ設定**
   - `routes/console.php` に1日1回の実行設定を追加

4. **バリデーション強化**
   - `ShopController::store()` と `update()` にキーワード最大10件のバリデーション追加

5. **並列処理実装**
   - キューシステム（Laravel Queue）の活用
   - または並列実行の実装

---

## 補足: データベース構造の詳細

### meo_keywords テーブル
```sql
CREATE TABLE meo_keywords (
    id BIGINT PRIMARY KEY,
    shop_id BIGINT NOT NULL,
    keyword VARCHAR(255) NOT NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (shop_id) REFERENCES shops(id) ON DELETE CASCADE
);
```

### meo_rank_logs テーブル
```sql
CREATE TABLE meo_rank_logs (
    id BIGINT PRIMARY KEY,
    meo_keyword_id BIGINT NULLABLE,
    rank INTEGER NULLABLE,  -- null=圏外
    checked_at DATE NOT NULL,
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    FOREIGN KEY (meo_keyword_id) REFERENCES meo_keywords(id) ON DELETE SET NULL,
    UNIQUE(meo_keyword_id, checked_at)
);
```

**注意**: `meo_keyword_id` は `nullable` で、キーワード削除時は `SET NULL` になる（過去のログを保持するため）














