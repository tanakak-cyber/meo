# ユーザー・権限・顧客（Shop）構造 調査結果

## ① Userモデルの構造

### app/Models/User.php

**カラム一覧（fillable）:**
- `name` - ユーザー名
- `email` - メールアドレス（unique）
- `password` - ハッシュ化されたパスワード
- `password_plain` - 平文パスワード（管理者画面表示用）
- `permissions` - 権限配列（JSON形式）
- `is_admin` - 管理者フラグ（boolean）
- `operator_id` - オペレーターID（nullable, foreign key to operation_persons）

**カラム定義（casts）:**
- `email_verified_at` - datetime
- `password` - hashed
- `permissions` - array（JSONから配列に自動変換）
- `is_admin` - boolean

**マイグレーション:**
- `0001_01_01_000000_create_users_table.php` - 基本テーブル作成
- `2026_01_31_000008_add_permissions_and_password_plain_to_users_table.php` - permissions, password_plain追加
- `2026_02_01_000002_add_is_admin_and_operator_id_to_users_table.php` - is_admin, operator_id追加

**権限管理の実装:**
- `hasPermission(string $permission): bool` メソッドで権限チェック
- `permissions` は配列形式で保存（例: `['dashboard', 'shops.index', 'masters.index']`）
- `is_admin` で管理者判定

---

## ② Shopモデル（顧客）の構造

### app/Models/Shop.php

**カラム一覧（fillable）:**
- 基本情報: `name`, `plan_id`, `sales_person_id`, `operation_person_id`
- 連絡先: `shop_contact_name`, `shop_contact_phone`
- 契約情報: `price`, `contract_date`, `contract_end_date`
- GBP情報: `gbp_location_id`, `gbp_account_id`, `gbp_refresh_token`, `gbp_access_token`, `gbp_name`
- その他: `blog_option`, `review_monthly_target`, `photo_monthly_target`, `video_monthly_target`, `memo`, `ai_reply_keywords`, `low_rating_response`, `google_place_id`
- レポート送信先: `report_email_1` ~ `report_email_5`

**重要: `created_by` カラムは存在しない**
- `shops` テーブルには「誰が登録したか」を示すカラムが**存在しない**
- `user_id`, `owner_id`, `created_by` などのカラムも**存在しない**

**リレーション:**
- `plan()` - BelongsTo Plan
- `salesPerson()` - BelongsTo SalesPerson
- `operationPerson()` - BelongsTo OperationPerson
- `reviews()`, `photos()`, `posts()`, `meoKeywords()`, `contactLogs()`, `mediaAssets()` - HasMany

---

## ③ 現在の顧客一覧取得ロジック

### app/Http/Controllers/ShopController.php

**`index()` メソッド（36-84行目）:**

```php
public function index(Request $request)
{
    $query = Shop::query();
    
    // 店舗ステータスで絞り込み（active/expired/all）
    // 営業担当で絞り込み（sales_person_id）
    // オペレーション担当で絞り込み（operation_person_id）
    
    $shops = $query->with('plan', 'salesPerson', 'operationPerson')
        ->orderBy('name')
        ->get();
}
```

**問題点:**
- **ユーザーによるフィルタリングが一切ない**
- `Shop::all()` 相当の処理（フィルタ条件のみ）
- 管理者・一般ユーザー問わず、**全顧客が表示される**

**`store()` メソッド（96-136行目）:**
- 顧客登録時に `created_by` などの記録を**行っていない**
- `Shop::create($validated)` のみ

---

## ④ 管理者の定義

**管理者判定方法:**
- `$user->is_admin === true` で判定
- `is_admin` カラムは `boolean` 型、デフォルト値は `false`

**使用箇所:**
- `app/Http/Controllers/ReportController.php` - 複数箇所で `!$user->is_admin` チェック
- `app/Http/Controllers/ReviewsController.php` - 複数箇所で `!$user->is_admin` チェック

**権限管理:**
- `permissions` 配列で細かい権限制御
- 例: `['dashboard', 'shops.index', 'masters.index']`
- `hasPermission()` メソッドでチェック

**オペレーターとの関係:**
- `operator_id` カラムでオペレーターと紐付け可能
- オペレーターは `operation_persons` テーブルに存在
- オペレーターは `operator_shops` テーブルで担当店舗を管理

---

## ⑤ 現在のアクセス制御

**Policy:**
- **存在しない**（`app/Policies/` ディレクトリにファイルなし）

**Gate:**
- **定義されていない**（`app/Providers/AuthServiceProvider.php` を確認していないが、使用箇所なし）

**Middleware:**
- `auth` ミドルウェアで認証チェック
- `operator.auth` ミドルウェアでオペレーター認証チェック
- **管理者専用のミドルウェアは存在しない**

**現在の制御方法:**
- Controller内で直接 `$user->is_admin` をチェック
- 例:
  ```php
  if (!$user || !$user->is_admin) {
      // オペレーター処理
  }
  ```

---

## 📊 現在のテーブル構造まとめ

### users テーブル
```
- id
- name
- email (unique)
- email_verified_at
- password
- password_plain
- permissions (JSON, nullable)
- is_admin (boolean, default: false)
- operator_id (nullable, FK to operation_persons)
- remember_token
- created_at
- updated_at
```

### shops テーブル
```
- id
- name (unique)
- plan_id (nullable, FK to plans)
- sales_person_id (nullable, FK to sales_persons)
- operation_person_id (nullable, FK to operation_persons)
- shop_contact_name
- shop_contact_phone
- price
- contract_date
- contract_end_date
- ... (その他多数のカラム)
- created_at
- updated_at
```

**重要: `created_by`, `user_id`, `owner_id` などのカラムは存在しない**

---

## 🔗 顧客とユーザーの紐付け有無

**現状: 紐付けなし**
- `shops` テーブルにユーザーを識別するカラムが存在しない
- 誰が顧客を登録したか記録されていない
- 顧客一覧は全ユーザー共通で表示される

---

## 🎯 現在の権限制御の方式

1. **認証:**
   - `auth` ミドルウェアでログインチェック

2. **管理者判定:**
   - `$user->is_admin === true` で判定
   - Controller内で直接チェック

3. **権限チェック:**
   - `$user->hasPermission($permission)` メソッド
   - `permissions` 配列に権限名が含まれているかチェック

4. **オペレーター制御:**
   - `operator_id` でオペレーターと紐付け
   - `operator_shops` テーブルで担当店舗を管理
   - オペレーターは担当店舗のみ閲覧可能

---

## ⚠️ 問題点の整理

### 1. 顧客登録者の記録がない
- **問題:** `shops` テーブルに `created_by` カラムが存在しない
- **影響:** 誰が顧客を登録したか分からない
- **対応必要:** `created_by` カラムの追加と、登録時の記録処理

### 2. 顧客一覧のフィルタリングがない
- **問題:** `ShopController::index()` でユーザーによるフィルタリングが一切ない
- **影響:** 全管理者が全顧客を閲覧できる
- **対応必要:** 管理者ごとに「自分が登録した顧客のみ」または「全顧客」を選択できる機能

### 3. アクセス制御が統一されていない
- **問題:** Policy/Gate を使用せず、Controller内で直接チェック
- **影響:** コードの重複、保守性の低下
- **対応推奨:** Policy または Gate による統一的なアクセス制御

### 4. 管理者の権限設定が不明確
- **問題:** `is_admin` と `permissions` の関係が不明確
- **影響:** 管理者が全権限を持つのか、`permissions` で制限されるのか不明
- **対応推奨:** 仕様の明確化

---

## 🚀 実装が必要な機能

### 1. `created_by` カラムの追加
```php
// マイグレーション
$table->foreignId('created_by')->nullable()
    ->after('id')
    ->constrained('users')
    ->onDelete('set null');
```

### 2. 顧客登録時の記録
```php
// ShopController::store()
$shop = Shop::create(array_merge($validated, [
    'created_by' => Auth::id(),
]));
```

### 3. 顧客一覧のフィルタリング
```php
// ShopController::index()
$user = Auth::user();

if ($user->is_admin) {
    // 管理者の場合
    $viewMode = $request->get('view_mode', 'all'); // 'all' or 'mine'
    
    if ($viewMode === 'mine') {
        $query->where('created_by', $user->id);
    }
    // 'all' の場合はフィルタリングなし
} else {
    // 一般ユーザーの場合は自分の顧客のみ
    $query->where('created_by', $user->id);
}
```

### 4. ビューでの切り替えUI
- 管理者用に「全顧客 / 自分の顧客」切り替えボタン
- セッションまたはリクエストパラメータで状態管理

---

## 📝 まとめ

**現状:**
- ユーザーは `is_admin` と `permissions` で管理
- 顧客（Shop）には登録者情報が記録されていない
- 顧客一覧は全ユーザー共通で全顧客が表示される
- Policy/Gate による統一的なアクセス制御は未実装

**必要な対応:**
1. `shops` テーブルに `created_by` カラムを追加
2. 顧客登録時に `created_by` を記録
3. 顧客一覧で管理者ごとにフィルタリング機能を実装
4. ビューで「全顧客 / 自分の顧客」切り替えUIを追加







