# 同期ボタン処理の全体像調査結果

## 1) 同期ボタンのエントリポイント

### ルーティング

**ファイル**: `routes/web.php`

```php
// 管理者用
Route::post('/reports/sync-all', [ReportController::class, 'syncAll'])->name('reports.sync-all');
Route::post('/reports/{shop}/sync', [ReportController::class, 'sync'])->name('reports.sync');

// オペレーター用
Route::post('/reports/sync-all', [ReportController::class, 'syncAll'])->name('reports.sync-all');
Route::post('/reports/{shop}/sync', [ReportController::class, 'sync'])->name('reports.sync');
```

### Controller / Action

**ファイル**: `app/Http/Controllers/ReportController.php`

- **`syncAll()`** (499-684行目): 全店舗または指定店舗の一括同期
- **`sync()`** (686-825行目): 個別店舗の同期

### Service / Job

- **`GoogleBusinessProfileService`** (`app/Services/GoogleBusinessProfileService.php`): Google API呼び出しを担当
- **非同期処理（Queue）**: ❌ NO（同期処理）

### 処理フロー

```
同期ボタン押下
  ↓
ReportController::sync() または syncAll()
  ↓
GoogleBusinessProfileService::getAccessToken() (アクセストークン取得)
  ↓
GbpSnapshot::create() (スナップショット作成)
  ↓
syncReviews() (口コミ同期)
  ↓
syncPhotos() (写真同期)
  ↓
syncLocalPosts() (投稿件数取得)
  ↓
GbpSnapshot::update() (件数を更新)
```

---

## 2) 同期処理で取得しているデータ一覧

| データ種別 | Google APIエンドポイント | 取得件数 | 保存先テーブル | コード箇所 |
|-----------|------------------------|---------|--------------|----------|
| **口コミ（Reviews）** | `GET /v4/accounts/{accountId}/locations/{locationId}/reviews` | **全件**（期間指定可） | `reviews` | `syncReviews()` (830-976行目) |
| **写真（Photos）** | `GET /v4/accounts/{accountId}/locations/{locationId}/media` | **全件**（期間指定可、PHOTOのみ） | `photos` | `syncPhotos()` (982-1147行目) |
| **投稿（Posts）** | `GET /v4/accounts/{accountId}/locations/{locationId}/localPosts` | **全件**（件数のみ保存） | `gbp_snapshots.posts_count` | `syncLocalPosts()` (1454行目以降) |
| **インサイト（Impressions/Clicks等）** | ❌ **取得していない** | - | `gbp_insights`（別途CSVインポート） | - |
| **評価平均値** | ❌ **取得していない**（口コミから計算） | - | - | - |
| **総口コミ数** | ❌ **取得していない**（口コミから計算） | - | `gbp_snapshots.reviews_count` | - |
| **営業時間** | ❌ **取得していない** | - | - | - |

### 詳細

#### 口コミ（Reviews）

**APIエンドポイント**: 
```
GET https://mybusiness.googleapis.com/v4/accounts/{accountId}/locations/{locationId}/reviews
```

**コード**: `app/Services/GoogleBusinessProfileService.php` (443-516行目)

**取得データ**:
- `reviewId` → `gbp_review_id`
- `reviewer.displayName` → `author_name`
- `starRating` → `rating`
- `comment` → `comment`
- `createTime` → `create_time`
- `reviewReply.comment` → `reply_text`
- `reviewReply.updateTime` → `replied_at`

**期間フィルタリング**: `createTime` で `startDate` / `endDate` をチェック（882-897行目）

**保存先**: `reviews` テーブル

---

#### 写真（Photos）

**APIエンドポイント**: 
```
GET https://mybusiness.googleapis.com/v4/accounts/{accountId}/locations/{locationId}/media
```

**コード**: `app/Services/GoogleBusinessProfileService.php` (527-582行目)

**取得データ**:
- `name` → `gbp_media_name` / `gbp_media_id`
- `mediaFormat` → `media_format` (PHOTOのみ処理)
- `googleUrl` → `google_url`
- `thumbnailUrl` → `thumbnail_url`
- `createTime` → `create_time`
- `dimensions.widthPixels` → `width_pixels`
- `dimensions.heightPixels` → `height_pixels`
- `locationAssociation.category` → `location_association_category`

**期間フィルタリング**: `createTime` で `startDate` / `endDate` をチェック（1051-1068行目）

**保存先**: `photos` テーブル

---

#### 投稿（Posts）

**APIエンドポイント**: 
```
GET https://mybusiness.googleapis.com/v4/accounts/{accountId}/locations/{locationId}/localPosts
```

**コード**: `app/Services/GoogleBusinessProfileService.php` (913-993行目)

**取得データ**: 
- **件数のみ**を取得（`localPosts` 配列の `count()`）
- 投稿の詳細データは保存しない

**保存先**: `gbp_snapshots.posts_count`（件数のみ）

**コード**: `app/Http/Controllers/ReportController.php` (1454行目以降)

---

## 3) 保存ロジックの種類

### 口コミ（Reviews）

**保存方式**: **updateOrCreate（snapshot方式）**

**コード**: `app/Http/Controllers/ReportController.php` (948-962行目)

```php
Review::updateOrCreate(
    [
        'snapshot_id' => $snapshotId,
        'gbp_review_id' => $gbpReviewIdClean,
    ],
    [
        'shop_id' => $shop->id,
        'author_name' => $authorName,
        'rating' => $rating,
        'comment' => $comment,
        'create_time' => $createTime,
        'reply_text' => $replyText,
        'replied_at' => $repliedAt,
    ]
);
```

**重複防止**: `['snapshot_id', 'gbp_review_id']` のユニーク制約

**動作**:
- 同じ `snapshot_id` + `gbp_review_id` の組み合わせが存在する場合は **UPDATE**
- 存在しない場合は **INSERT**

---

### 写真（Photos）

**保存方式**: **updateOrCreate（snapshot方式）**

**コード**: `app/Http/Controllers/ReportController.php` (1087-1103行目)

```php
$photo = Photo::updateOrCreate(
    [
        'snapshot_id' => $snapshotId,
        'gbp_media_id' => $gbpMediaId,
    ],
    [
        'shop_id' => $shop->id,
        'gbp_media_name' => $gbpMediaName,
        'media_format' => $mediaFormat,
        'google_url' => $mediaItem['googleUrl'] ?? null,
        'thumbnail_url' => $mediaItem['thumbnailUrl'] ?? null,
        'create_time' => isset($mediaItem['createTime']) ? Carbon::parse($mediaItem['createTime']) : now(),
        'width_pixels' => $mediaItem['dimensions']['widthPixels'] ?? null,
        'height_pixels' => $mediaItem['dimensions']['heightPixels'] ?? null,
        'location_association_category' => $mediaItem['locationAssociation']['category'] ?? null,
    ]
);
```

**重複防止**: `['snapshot_id', 'gbp_media_id']` のユニーク制約

**動作**:
- 同じ `snapshot_id` + `gbp_media_id` の組み合わせが存在する場合は **UPDATE**
- 存在しない場合は **INSERT**
- `wasRecentlyCreated` で新規作成か更新かを判定（1105行目）

---

### 投稿（Posts）

**保存方式**: **件数のみ保存（snapshot方式）**

**コード**: `app/Http/Controllers/ReportController.php` (1454行目以降)

```php
$localPosts = $googleService->listLocalPosts($accessToken, $shop->gbp_account_id, $shop->gbp_location_id);
$postsCount = count($localPosts);

// スナップショットに件数のみ保存
$snapshot->update([
    'posts_count' => $postsCount,
]);
```

**重複防止**: なし（件数のみで、個別レコードは保存しない）

**動作**:
- 投稿の詳細データは保存しない
- `gbp_snapshots.posts_count` に件数のみ保存

---

### スナップショット（GbpSnapshot）

**保存方式**: **INSERT（毎回新規作成）**

**コード**: `app/Http/Controllers/ReportController.php` (613-623行目, 762-772行目)

```php
$snapshot = GbpSnapshot::create([
    'shop_id' => $shop->id,
    'user_id' => $currentUserId,
    'synced_by_operator_id' => $operatorId,
    'synced_at' => now(),
    'sync_params' => [
        'start_date' => $startDateCarbon?->format('Y-m-d'),
        'end_date' => $endDateCarbon?->format('Y-m-d'),
    ],
]);
```

**重複防止**: なし（毎回新規作成）

**動作**:
- 同期のたびに新しいスナップショットを作成
- `user_id` でユーザー別に分離

---

## 4) テーブル構造とUNIQUE制約

### gbp_snapshots テーブル

**UNIQUE制約**: ❌ **なし**

**カラム**:
- `id` (PK)
- `shop_id` (FK)
- `user_id` (FK)
- `synced_by_operator_id` (FK, nullable)
- `synced_at` (timestamp)
- `photos_count`, `reviews_count`, `posts_count`
- `sync_params` (JSON)

**インデックス**: `['shop_id', 'user_id', 'synced_at']`

**重複リスク**: ✅ **低い**（毎回新規作成、`user_id` で分離）

---

### reviews テーブル

**UNIQUE制約**: ✅ **あり** `['snapshot_id', 'gbp_review_id']`

**マイグレーション**: `database/migrations/2026_01_31_000004_add_snapshot_id_to_reviews_table.php` (37行目)

```php
$table->unique(['snapshot_id', 'gbp_review_id']);
```

**重複リスク**: ✅ **なし**（UNIQUE制約で防止）

**snapshotとの関係**: 
- `snapshot_id` (FK → `gbp_snapshots`)
- 同じ `gbp_review_id` でも異なる `snapshot_id` なら別レコードとして保存可能

---

### photos テーブル

**UNIQUE制約**: ✅ **あり** `['snapshot_id', 'gbp_media_id']`

**マイグレーション**: `database/migrations/2026_01_31_000003_add_snapshot_id_to_photos_table.php` (34行目)

```php
$table->unique(['snapshot_id', 'gbp_media_id']);
```

**重複リスク**: ✅ **なし**（UNIQUE制約で防止）

**snapshotとの関係**: 
- `snapshot_id` (FK → `gbp_snapshots`)
- 同じ `gbp_media_id` でも異なる `snapshot_id` なら別レコードとして保存可能

---

### gbp_posts テーブル

**UNIQUE制約**: 要確認（マイグレーションファイルを確認する必要あり）

**snapshotとの関係**: 
- `snapshot_id` (FK → `gbp_snapshots`) が存在する可能性

**注意**: 現在の同期処理では投稿の詳細データは保存していない（件数のみ）

---

## 5) 同期1回で何レコード増える可能性があるか？

### 既存データがあっても毎回増える設計か？

**結論**: ✅ **YES（snapshot方式のため）**

### 詳細

#### スナップショット（GbpSnapshot）

**毎回増える**: ✅ **YES**
- 同期のたびに新しいスナップショットを作成
- 既存のスナップショットは削除されない

**増加数**: **1レコード/同期**

---

#### 口コミ（Reviews）

**毎回増える可能性**: ✅ **YES（同じ口コミでも異なるsnapshot_idなら別レコード）**

**増加数**: 
- 全件取得の場合: **全口コミ数/同期**
- 期間指定の場合: **該当期間の口コミ数/同期**

**例**:
- 1回目: 100件の口コミ → 100レコード
- 2回目（全件）: 同じ100件 → 100レコード（別のsnapshot_id）→ **合計200レコード**

**重複防止**: 
- 同じ `snapshot_id` 内では `gbp_review_id` で重複防止
- 異なる `snapshot_id` では同じ `gbp_review_id` でも別レコード

---

#### 写真（Photos）

**毎回増える可能性**: ✅ **YES（同じ写真でも異なるsnapshot_idなら別レコード）**

**増加数**: 
- 全件取得の場合: **全写真数/同期**
- 期間指定の場合: **該当期間の写真数/同期**

**例**:
- 1回目: 50件の写真 → 50レコード
- 2回目（全件）: 同じ50件 → 50レコード（別のsnapshot_id）→ **合計100レコード**

**重複防止**: 
- 同じ `snapshot_id` 内では `gbp_media_id` で重複防止
- 異なる `snapshot_id` では同じ `gbp_media_id` でも別レコード

---

#### 投稿（Posts）

**毎回増える**: ❌ **NO（件数のみ保存）**

**増加数**: **0レコード**（`gbp_snapshots.posts_count` を更新するのみ）

---

## 6) 同期処理の問題点を列挙

### 問題点1: 重複発生リスク

**リスク**: ⚠️ **中程度**

**詳細**:
- 同じ口コミ・写真が異なる `snapshot_id` で重複保存される
- 表示時に `snapshot_id` でフィルタリングするため、重複は表示に影響しない
- ただし、DB容量が無駄に増加する

**根拠**:
- `reviews` テーブル: `['snapshot_id', 'gbp_review_id']` のUNIQUE制約
- `photos` テーブル: `['snapshot_id', 'gbp_media_id']` のUNIQUE制約
- 異なる `snapshot_id` では同じ `gbp_review_id` / `gbp_media_id` でも別レコード

**改善案**:
- 古いスナップショットの物理削除（cron job）
- または、表示時に `gbp_review_id` / `gbp_media_id` でユニーク化

---

### 問題点2: データ上書きリスク

**リスク**: ✅ **低い**

**詳細**:
- `updateOrCreate` を使用しているため、同じ `snapshot_id` 内では上書きされる
- ただし、異なる `snapshot_id` では上書きされない

**根拠**:
```php
Review::updateOrCreate(
    ['snapshot_id' => $snapshotId, 'gbp_review_id' => $gbpReviewIdClean],
    [...]
);
```

---

### 問題点3: snapshot混在リスク

**リスク**: ⚠️ **中程度**

**詳細**:
- 複数のユーザーが同じ店舗を同期すると、異なる `user_id` のスナップショットが混在
- 表示時に `user_id` でフィルタリングするため、混在は表示に影響しない
- ただし、DB容量が無駄に増加する

**根拠**:
- `GbpSnapshot` は `user_id` で分離されている
- 表示時に `where('user_id', $currentUserId)` でフィルタリング（229-234行目）

---

### 問題点4: ユーザー別分離問題

**リスク**: ✅ **解決済み**

**詳細**:
- `GbpSnapshot` は `user_id` で分離されている
- `Review` と `Photo` は `snapshot_id` で間接的に `user_id` で分離されている

**根拠**:
- `GbpSnapshot::create()` で `user_id` を保存（616行目, 765行目）
- 表示時に `where('user_id', $currentUserId)` でフィルタリング（229-234行目）

---

### 問題点5: API制限リスク

**リスク**: ⚠️ **中程度**

**詳細**:
- Google Business Profile API にはレート制限がある
- 全店舗同期（`syncAll`）で大量のAPIリクエストが発生する可能性

**根拠**:
- `syncAll()` で複数店舗をループ処理（590-664行目）
- 各店舗で3つのAPI呼び出し（reviews, photos, localPosts）

**改善案**:
- レート制限対応（リトライ、スロットリング）
- 非同期処理（Queue）への移行

---

### 問題点6: 投稿の詳細データを保存していない

**リスク**: ⚠️ **低い（設計上の意図）**

**詳細**:
- 投稿の詳細データ（本文、画像URL等）は保存していない
- 件数のみを `gbp_snapshots.posts_count` に保存

**根拠**:
```php
$localPosts = $googleService->listLocalPosts(...);
$postsCount = count($localPosts);
$snapshot->update(['posts_count' => $postsCount]);
```

**改善案**:
- 投稿の詳細データも保存する場合は、`gbp_posts` テーブルに保存する設計に変更

---

### 問題点7: インサイトデータを取得していない

**リスク**: ⚠️ **低い（別途CSVインポート）**

**詳細**:
- 同期処理ではインサイトデータ（Impressions, Clicks等）を取得していない
- `gbp_insights` テーブルは別途CSVインポートで保存

**根拠**:
- `sync()` / `syncAll()` にインサイト取得処理がない

---

## まとめ

### 同期ボタンを押すと「〇〇→〇〇→〇〇」の順で処理される

```
同期ボタン押下
  ↓
ReportController::sync() または syncAll()
  ↓
GoogleBusinessProfileService::getAccessToken() (アクセストークン取得・リフレッシュ)
  ↓
GbpSnapshot::create() (スナップショット作成、user_idで分離)
  ↓
GoogleBusinessProfileService::listReviews() (口コミ全件取得)
  ↓
Review::updateOrCreate() (snapshot_id + gbp_review_idで重複防止)
  ↓
GoogleBusinessProfileService::listMedia() (写真全件取得)
  ↓
Photo::updateOrCreate() (snapshot_id + gbp_media_idで重複防止)
  ↓
GoogleBusinessProfileService::listLocalPosts() (投稿全件取得)
  ↓
GbpSnapshot::update() (posts_countに件数のみ保存)
```

---

### 取得データ一覧（表形式）

| データ種別 | APIエンドポイント | 取得件数 | 保存先 | 重複防止 |
|-----------|------------------|---------|--------|---------|
| 口コミ | `/v4/.../reviews` | 全件（期間指定可） | `reviews` | `['snapshot_id', 'gbp_review_id']` |
| 写真 | `/v4/.../media` | 全件（期間指定可、PHOTOのみ） | `photos` | `['snapshot_id', 'gbp_media_id']` |
| 投稿 | `/v4/.../localPosts` | 全件（件数のみ） | `gbp_snapshots.posts_count` | なし |
| インサイト | ❌ 取得しない | - | `gbp_insights`（別途CSV） | - |

---

### 保存方式一覧

| データ種別 | 保存方式 | 重複防止 | snapshotとの関係 |
|-----------|---------|---------|-----------------|
| **GbpSnapshot** | INSERT（毎回新規） | なし | - |
| **Review** | updateOrCreate（snapshot方式） | `['snapshot_id', 'gbp_review_id']` | `snapshot_id` (FK) |
| **Photo** | updateOrCreate（snapshot方式） | `['snapshot_id', 'gbp_media_id']` | `snapshot_id` (FK) |
| **Post** | 件数のみ（snapshot方式） | なし | `gbp_snapshots.posts_count` |

---

### 重複リスク：YES / NO（理由付き）

**重複リスク**: ⚠️ **YES（中程度）**

**理由**:
1. **同じ口コミ・写真が異なるsnapshot_idで重複保存される**
   - 同じ `gbp_review_id` でも異なる `snapshot_id` なら別レコード
   - 表示時は `snapshot_id` でフィルタリングするため影響なし
   - ただし、DB容量が無駄に増加

2. **複数ユーザーが同じ店舗を同期すると、異なるuser_idのスナップショットが混在**
   - 表示時は `user_id` でフィルタリングするため影響なし
   - ただし、DB容量が無駄に増加

3. **同じsnapshot_id内では重複防止されている**
   - `['snapshot_id', 'gbp_review_id']` / `['snapshot_id', 'gbp_media_id']` のUNIQUE制約

---

### 根本設計の問題点まとめ

1. **DB容量の無駄増加**
   - 同じ口コミ・写真が異なる `snapshot_id` で重複保存
   - 古いスナップショットの物理削除機能がない

2. **API制限リスク**
   - 全店舗同期で大量のAPIリクエストが発生
   - レート制限対応がない

3. **投稿の詳細データを保存していない**
   - 件数のみ保存（設計上の意図かもしれないが、将来的に詳細が必要になる可能性）

4. **インサイトデータを取得していない**
   - 別途CSVインポートが必要（設計上の意図かもしれない）

5. **同期処理が同期（ブロッキング）**
   - 大量の店舗を同期するとタイムアウトのリスク
   - 非同期処理（Queue）への移行を検討すべき

---

## コード参照箇所まとめ

### エントリポイント
- `routes/web.php` (67-68行目, 151-152行目)
- `app/Http/Controllers/ReportController.php` (499-684行目: syncAll, 686-825行目: sync)

### 同期処理
- `app/Http/Controllers/ReportController.php` (830-976行目: syncReviews)
- `app/Http/Controllers/ReportController.php` (982-1147行目: syncPhotos)
- `app/Http/Controllers/ReportController.php` (1454行目以降: syncLocalPosts)

### API呼び出し
- `app/Services/GoogleBusinessProfileService.php` (443-516行目: listReviews)
- `app/Services/GoogleBusinessProfileService.php` (527-582行目: listMedia)
- `app/Services/GoogleBusinessProfileService.php` (913-993行目: listLocalPosts)

### テーブル構造
- `database/migrations/2026_01_31_000004_add_snapshot_id_to_reviews_table.php` (37行目: UNIQUE制約)
- `database/migrations/2026_01_31_000003_add_snapshot_id_to_photos_table.php` (34行目: UNIQUE制約)
- `database/migrations/2026_02_02_000001_add_user_id_to_gbp_snapshots_table.php` (17行目: user_id追加)









