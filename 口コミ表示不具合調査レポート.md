# 口コミ表示不具合調査レポート

## 問題の概要

レビュー回りのDB構成変更（UTC保存への統一）に伴い、以下の2つの問題が発生：

1. **口コミ管理画面** (`http://127.0.0.1:8000/reviews`)
   - 口コミおよび返信が表示されない

2. **スケジュール画面** (`http://127.0.0.1:8000/shops/schedule?year=2026&month=2`)
   - 口コミの投稿があってもカレンダー部分に数値が反映しない

---

## 原因分析

### 【問題1】口コミ管理画面で口コミが表示されない

#### 原因箇所

**ファイル**: `app/Http/Controllers/ReviewsController.php`

**行151-156**: 日付フィルタリング
```php
// 開始日
if ($request->filled('start_date')) {
    $query->whereDate('create_time', '>=', $request->start_date);
}

// 終了日
if ($request->filled('end_date')) {
    $query->whereDate('create_time', '<=', $request->end_date);
}
```

#### 問題の詳細

1. **タイムゾーンの不一致**
   - `create_time` は **UTC** で保存されている（`ReviewSyncService` で `format('Y-m-d H:i:s')` でUTCとして保存）
   - `whereDate()` は **デフォルトタイムゾーン（JST）** で比較する
   - そのため、UTCとJSTの9時間の差で日付がずれる

2. **具体例**
   - DBに保存されている値: `2026-02-01 15:00:00` (UTC)
   - ユーザーが検索する日付: `2026-02-01` (JST)
   - `whereDate('create_time', '>=', '2026-02-01')` は JST の `2026-02-01 00:00:00` と比較
   - UTC の `2026-02-01 15:00:00` は JST の `2026-02-02 00:00:00` に相当
   - そのため、`2026-02-01` の検索では該当しない

3. **デフォルト値の問題**
   - 行219-220: `$startDate` と `$endDate` のデフォルト値が設定されている
   - これらもJSTで作成されているため、UTCのデータと一致しない

#### その他の問題箇所

**行217**: ソート
```php
$reviews = $query->orderBy('create_time', 'desc')->paginate(20);
```
- これは問題ない（UTCのままソートしても問題なし）

**行208-214**: 重複除外ロジック
```php
$latestReviewIds = DB::table('reviews')
    ->whereIn('snapshot_id', $latestSnapshotIds)
    ->select(DB::raw('MAX(id) as id'))
    ->groupBy('shop_id', 'gbp_review_id')
    ->pluck('id');

$query->whereIn('id', $latestReviewIds);
```
- これは問題ない（IDベースのフィルタリング）

---

### 【問題2】スケジュール画面で口コミ数が表示されない

#### 原因箇所

**ファイル**: `app/Http/Controllers/ShopController.php`

**行566-580**: 日付範囲の作成とクエリ
```php
$startDate = Carbon::create($year, $month, 1)->startOfDay();
$endDate = Carbon::create($year, $month, $daysInMonth)->endOfDay();

// 指定された年月の口コミを取得（最新スナップショットのもの）
$reviewsQuery = Review::where('shop_id', $shop->id)
    ->whereBetween('create_time', [$startDate, $endDate]);
```

**行613-618**: 日別フィルタリング
```php
$reviewCount = $reviews->filter(function ($review) use ($dayStart, $dayEnd) {
    $reviewDate = $review->create_time instanceof Carbon 
        ? $review->create_time 
        : Carbon::parse($review->create_time);
    return $reviewDate->between($dayStart, $dayEnd);
})->count();
```

#### 問題の詳細

1. **タイムゾーンの不一致**
   - `$startDate` と `$endDate` は **デフォルトタイムゾーン（JST）** で作成される
   - `create_time` は **UTC** で保存されている
   - `whereBetween('create_time', [$startDate, $endDate])` は、JSTの日付範囲とUTCのデータを比較するため、9時間のずれが発生

2. **具体例**
   - 検索対象: 2026年2月
   - `$startDate`: `2026-02-01 00:00:00` (JST) = `2026-01-31 15:00:00` (UTC)
   - `$endDate`: `2026-02-28 23:59:59` (JST) = `2026-02-28 14:59:59` (UTC)
   - DBに保存されている値: `2026-02-01 15:00:00` (UTC) = `2026-02-02 00:00:00` (JST)
   - そのため、`whereBetween` で取得できない

3. **日別フィルタリングの問題**
   - `$dayStart` と `$dayEnd` もJSTで作成されている
   - `$review->create_time` を `Carbon::parse()` でパースすると、デフォルトタイムゾーン（JST）として解釈される可能性がある
   - しかし、DBから取得した `create_time` はUTCの文字列なので、パース時にJSTとして解釈されると9時間ずれる

---

## 対策

### 【対策1】口コミ管理画面の修正

#### 修正箇所1: 日付フィルタリング

**ファイル**: `app/Http/Controllers/ReviewsController.php`

**修正前**:
```php
// 開始日
if ($request->filled('start_date')) {
    $query->whereDate('create_time', '>=', $request->start_date);
}

// 終了日
if ($request->filled('end_date')) {
    $query->whereDate('create_time', '<=', $request->end_date);
}
```

**修正後**:
```php
// 開始日（JSTの日付をUTCの日付範囲に変換）
if ($request->filled('start_date')) {
    $startDateJst = Carbon::parse($request->start_date, 'Asia/Tokyo')->startOfDay();
    $startDateUtc = $startDateJst->copy()->utc();
    $query->where('create_time', '>=', $startDateUtc);
}

// 終了日（JSTの日付をUTCの日付範囲に変換）
if ($request->filled('end_date')) {
    $endDateJst = Carbon::parse($request->end_date, 'Asia/Tokyo')->endOfDay();
    $endDateUtc = $endDateJst->copy()->utc();
    $query->where('create_time', '<=', $endDateUtc);
}
```

#### 修正箇所2: デフォルト値の修正

**修正前**:
```php
$startDate = $request->start_date ?? now()->subMonth()->format('Y-m-d');
$endDate = $request->end_date ?? now()->format('Y-m-d');
```

**修正後**:
```php
$startDate = $request->start_date ?? now('Asia/Tokyo')->subMonth()->format('Y-m-d');
$endDate = $request->end_date ?? now('Asia/Tokyo')->format('Y-m-d');
```

---

### 【対策2】スケジュール画面の修正

#### 修正箇所1: 日付範囲の作成

**ファイル**: `app/Http/Controllers/ShopController.php`

**修正前**:
```php
$startDate = Carbon::create($year, $month, 1)->startOfDay();
$endDate = Carbon::create($year, $month, $daysInMonth)->endOfDay();

$reviewsQuery = Review::where('shop_id', $shop->id)
    ->whereBetween('create_time', [$startDate, $endDate]);
```

**修正後**:
```php
// JSTの日付範囲をUTCに変換
$startDateJst = Carbon::create($year, $month, 1, 0, 0, 0, 'Asia/Tokyo')->startOfDay();
$endDateJst = Carbon::create($year, $month, $daysInMonth, 23, 59, 59, 'Asia/Tokyo')->endOfDay();
$startDateUtc = $startDateJst->copy()->utc();
$endDateUtc = $endDateJst->copy()->utc();

$reviewsQuery = Review::where('shop_id', $shop->id)
    ->whereBetween('create_time', [$startDateUtc, $endDateUtc]);
```

#### 修正箇所2: 日別フィルタリング

**修正前**:
```php
$reviewCount = $reviews->filter(function ($review) use ($dayStart, $dayEnd) {
    $reviewDate = $review->create_time instanceof Carbon 
        ? $review->create_time 
        : Carbon::parse($review->create_time);
    return $reviewDate->between($dayStart, $dayEnd);
})->count();
```

**修正後**:
```php
$reviewCount = $reviews->filter(function ($review) use ($dayStart, $dayEnd) {
    // create_time はUTCで保存されているので、UTCとしてパース
    $reviewDate = $review->create_time instanceof Carbon 
        ? $review->create_time->utc()
        : Carbon::parse($review->create_time, 'UTC');
    
    // dayStart と dayEnd をUTCに変換
    $dayStartUtc = $dayStart->copy()->utc();
    $dayEndUtc = $dayEnd->copy()->utc();
    
    return $reviewDate->between($dayStartUtc, $dayEndUtc);
})->count();
```

#### 修正箇所3: 日付の作成

**修正前**:
```php
for ($day = 1; $day <= $daysInMonth; $day++) {
    $date = Carbon::create($year, $month, $day);
    $dayStart = $date->copy()->startOfDay();
    $dayEnd = $date->copy()->endOfDay();
```

**修正後**:
```php
for ($day = 1; $day <= $daysInMonth; $day++) {
    $date = Carbon::create($year, $month, $day, 0, 0, 0, 'Asia/Tokyo');
    $dayStart = $date->copy()->startOfDay();
    $dayEnd = $date->copy()->endOfDay();
```

---

## その他の確認事項

### Blade表示の確認

**ファイル**: `resources/views/reviews/index.blade.php` (行290)
```php
{{ $review->create_time->timezone('Asia/Tokyo')->format('Y/m/d H:i') }}
```

**ファイル**: `resources/views/reviews/show.blade.php` (行80, 93)
```php
{{ $review->create_time->timezone('Asia/Tokyo')->format('Y年m月d日 H:i') }}
{{ $review->replied_at->timezone('Asia/Tokyo')->format('Y年m月d日 H:i') }}
```

**確認結果**: ✅ 問題なし
- `create_time` が `datetime` キャストされているため、Carbonオブジェクトとして取得できる
- `timezone('Asia/Tokyo')` でJSTに変換して表示している
- ただし、`create_time` が `null` の場合はエラーになる可能性がある（`null` チェックが必要かも）

---

## 修正の優先順位

1. **P0（最優先）**: スケジュール画面の日付範囲クエリ修正
   - カレンダーに数値が表示されない問題を解決

2. **P0（最優先）**: 口コミ管理画面の日付フィルタリング修正
   - 口コミが表示されない問題を解決

3. **P1（高優先）**: デフォルト値の修正
   - ユーザーが日付を指定しない場合の動作を修正

4. **P2（中優先）**: null チェックの追加
   - Blade表示で `create_time` が `null` の場合のエラーを防止

---

## まとめ

### 根本原因

**タイムゾーンの不一致**
- DBの `create_time` は **UTC** で保存されている
- コントローラーでの日付比較は **JST（デフォルトタイムゾーン）** で行われている
- そのため、9時間のずれが発生し、データが取得できない

### 解決策

1. **日付範囲の作成時にタイムゾーンを明示**
   - JSTで日付範囲を作成し、UTCに変換してからクエリに使用

2. **whereDate() の使用を避ける**
   - `whereDate()` はデフォルトタイムゾーンで比較するため、`where()` と `>=` / `<=` を使用

3. **Carbon のパース時にタイムゾーンを明示**
   - `Carbon::parse($value, 'UTC')` のように、第二引数でタイムゾーンを指定

### 影響範囲

- ✅ **口コミ管理画面**: 日付フィルタリングが機能しない
- ✅ **スケジュール画面**: カレンダーに口コミ数が表示されない
- ⚠️ **その他の画面**: 日付比較を行っている箇所があれば同様の問題が発生する可能性がある








