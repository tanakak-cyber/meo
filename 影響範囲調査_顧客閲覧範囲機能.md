# 影響範囲調査レポート：顧客閲覧範囲機能の実装

## 📋 調査目的

管理者に「顧客閲覧範囲」を持たせる機能を実装する前提で、影響範囲を調査。

**設計案:**
1. `shops` テーブルに `created_by` (unsignedBigInteger nullable) を追加
2. `users` テーブルに `customer_scope` (string default 'own') を追加
   - 値は `'own'` または `'all'`

---

## ① Shop作成処理の場所

### 主要な作成処理

**ファイル:** `app/Http/Controllers/ShopController.php`

**メソッド:** `store()` (96-150行目)

**現在の実装:**
```php
public function store(Request $request)
{
    $validated = $request->validate([...]);
    
    // review_monthly_target, photo_monthly_target, video_monthly_target の処理
    
    $shop = Shop::create($validated);  // ← ここで作成
    
    // MEOキーワードの保存
    if ($request->has('meo_keywords')) {
        foreach ($request->meo_keywords as $keyword) {
            if (!empty(trim($keyword))) {
                MeoKeyword::create([
                    'shop_id' => $shop->id,
                    'keyword' => trim($keyword),
                ]);
            }
        }
    }
    
    // レポート送信先メールアドレスの保存処理
    
    return redirect()->route('shops.show', $shop)
        ->with('success', '店舗を登録しました。');
}
```

**影響箇所:**
- **136行目**: `Shop::create($validated)` の前に `created_by` を追加する必要がある
- **バリデーション**: `created_by` はバリデーション不要（自動設定）

**修正が必要な箇所:**
```php
// 修正案
$shop = Shop::create(array_merge($validated, [
    'created_by' => Auth::id(),
]));
```

**ルート:**
- `POST /shops` → `shops.store` (routes/web.php 117行目)
- ミドルウェア: `admin.permission:shops.index`

---

## ② Shop一覧取得の場所

### 主要な一覧取得処理

**ファイル:** `app/Http/Controllers/ShopController.php`

**メソッド:** `index()` (36-84行目)

**現在の実装:**
```php
public function index(Request $request)
{
    $query = Shop::query();
    
    // 店舗ステータスで絞り込み（active/expired/all）
    // 営業担当で絞り込み（sales_person_id）
    // オペレーション担当で絞り込み（operation_person_id）
    
    $shops = $query->with('plan', 'salesPerson', 'operationPerson')
        ->orderBy('name')
        ->get();
    
    return view('shops.index', compact('shops', ...));
}
```

**影響箇所:**
- **38行目**: `Shop::query()` の後に、ユーザーの `customer_scope` に基づくフィルタリングを追加
- **77行目**: `get()` の前にフィルタリング条件を適用

**修正が必要な箇所:**
```php
// 修正案
$user = Auth::user();

if ($user && $user->is_admin) {
    // 管理者の場合
    if ($user->customer_scope === 'own') {
        $query->where('created_by', $user->id);
    }
    // 'all' の場合はフィルタリングなし
} else {
    // 一般ユーザー（非管理者）の場合は自分の顧客のみ
    $query->where('created_by', $user->id);
}
```

**ルート:**
- `GET /shops` → `shops.index` (routes/web.php 117行目)
- ミドルウェア: `admin.permission:shops.index`

### その他の一覧取得箇所

#### 1. ReportController::index() (30-189行目)
- **用途**: レポート画面での店舗一覧取得
- **現在**: オペレーターの場合は `operator_shops` テーブルでフィルタリング
- **影響**: 管理者の場合に `customer_scope` によるフィルタリングを追加

#### 2. ReportController::syncAll() (105-145行目)
- **用途**: 全店舗同期処理
- **現在**: `Shop::whereNotNull('gbp_location_id')` で取得
- **影響**: 管理者の場合に `customer_scope` によるフィルタリングを追加

#### 3. ReportController::show() (515-561行目)
- **用途**: レポート詳細画面での店舗一覧取得
- **影響**: 管理者の場合に `customer_scope` によるフィルタリングを追加

#### 4. ReviewsController::index() (38-356行目)
- **用途**: 口コミ管理画面での店舗一覧取得
- **現在**: `Shop::whereNotNull('gbp_location_id')` で取得
- **影響**: 管理者の場合に `customer_scope` によるフィルタリングを追加

#### 5. ShopController::schedule() (412-500行目)
- **用途**: スケジュール画面での店舗一覧取得
- **現在**: オペレーターの場合は `operator_shops` テーブルでフィルタリング
- **影響**: 管理者の場合に `customer_scope` によるフィルタリングを追加

#### 6. routes/web.php (32行目)
- **用途**: オペレーターダッシュボード
- **現在**: `Shop::where('operation_person_id', $operatorId)->get()`
- **影響**: オペレーター用なので影響なし（管理者は使用しない）

---

## ③ Shop更新・削除処理の場所

### 更新処理

**ファイル:** `app/Http/Controllers/ShopController.php`

**メソッド:** `update()` (209-400行目)

**現在の実装:**
```php
public function update(Request $request, Shop $shop)
{
    $validated = $request->validate([...]);
    
    // 各種バリデーション後の処理
    
    $shop->update($validated);
    
    // MEOキーワードの更新処理
    
    return redirect()->route('shops.show', $shop)
        ->with('success', '店舗情報を更新しました。');
}
```

**影響箇所:**
- **320行目**: `$shop->update($validated)` の前に、アクセス権限チェックを追加
- **created_by** は更新しない（作成者の変更は許可しない）

**修正が必要な箇所:**
```php
// 修正案（アクセス権限チェック）
$user = Auth::user();

if ($user && $user->is_admin) {
    if ($user->customer_scope === 'own' && $shop->created_by !== $user->id) {
        abort(403, 'この店舗を編集する権限がありません。');
    }
} else {
    if ($shop->created_by !== $user->id) {
        abort(403, 'この店舗を編集する権限がありません。');
    }
}
```

**ルート:**
- `PUT /shops/{shop}` → `shops.update` (routes/web.php 117行目)
- ミドルウェア: `admin.permission:shops.index`

### 削除処理

**ファイル:** `app/Http/Controllers/ShopController.php`

**メソッド:** `destroy()` (406-410行目)

**現在の実装:**
```php
public function destroy(Shop $shop)
{
    $shop->delete();
    return redirect()->route('shops.index')
        ->with('success', '店舗を削除しました。');
}
```

**影響箇所:**
- **408行目**: `$shop->delete()` の前に、アクセス権限チェックを追加

**修正が必要な箇所:**
```php
// 修正案（アクセス権限チェック）
$user = Auth::user();

if ($user && $user->is_admin) {
    if ($user->customer_scope === 'own' && $shop->created_by !== $user->id) {
        abort(403, 'この店舗を削除する権限がありません。');
    }
} else {
    if ($shop->created_by !== $user->id) {
        abort(403, 'この店舗を削除する権限がありません。');
    }
}
```

**ルート:**
- `DELETE /shops/{shop}` → `shops.destroy` (routes/web.php 117行目)
- ミドルウェア: `admin.permission:shops.index`

### 詳細表示処理

**ファイル:** `app/Http/Controllers/ShopController.php`

**メソッド:** `show()` (153-202行目)

**現在の実装:**
```php
public function show(Shop $shop)
{
    // オペレーターの場合は自分の担当店舗のみアクセス可能
    $user = Auth::user();
    $operatorId = session('operator_id');
    
    if (!$user || !$user->is_admin) {
        // オペレーターの場合の権限チェック
        // ...
    }
    
    // プランと担当営業、オペレーション担当のリレーションをロード
    $shop->load('plan', 'salesPerson', 'operationPerson');
    
    return view('shops.show', compact('shop', ...));
}
```

**影響箇所:**
- **160行目**: 管理者の場合の権限チェックを追加

**修正が必要な箇所:**
```php
// 修正案
if ($user && $user->is_admin) {
    if ($user->customer_scope === 'own' && $shop->created_by !== $user->id) {
        abort(403, 'この店舗を閲覧する権限がありません。');
    }
} elseif (!$user || !$user->is_admin) {
    // 既存のオペレーター権限チェック
}
```

**ルート:**
- `GET /shops/{shop}` → `shops.show` (routes/web.php 117行目)
- ミドルウェア: `admin.permission:shops.index`

---

## ④ 管理画面で顧客一覧を表示しているBlade

### 主要な一覧表示画面

**ファイル:** `resources/views/shops/index.blade.php`

**現在の実装:**
- 83行目: `@forelse($shops as $shop)` で店舗一覧を表示
- 絞り込みフォーム: 店舗ステータス、営業担当、オペレーション担当

**影響箇所:**
- **7-9行目**: ヘッダー部分に「全顧客 / 自分の顧客」切り替えボタンを追加（管理者のみ表示）
- **22-62行目**: 絞り込みフォームに `view_mode` パラメータを追加

**修正が必要な箇所:**
```blade
{{-- 管理者のみ表示 --}}
@if(Auth::user() && Auth::user()->is_admin)
    <div class="flex items-center gap-2 mb-4">
        <span class="text-sm font-medium text-gray-700">表示範囲:</span>
        <label class="flex items-center">
            <input type="radio" name="view_mode" value="all" 
                   {{ (request('view_mode', Auth::user()->customer_scope ?? 'own') === 'all') ? 'checked' : '' }}
                   onchange="this.form.submit()" class="mr-2">
            <span class="text-sm text-gray-700">全顧客</span>
        </label>
        <label class="flex items-center">
            <input type="radio" name="view_mode" value="own"
                   {{ (request('view_mode', Auth::user()->customer_scope ?? 'own') === 'own') ? 'checked' : '' }}
                   onchange="this.form.submit()" class="mr-2">
            <span class="text-sm text-gray-700">自分の顧客</span>
        </label>
    </div>
@endif
```

### その他の一覧表示画面

#### 1. resources/views/reports/index.blade.php
- **用途**: レポート画面での店舗一覧表示
- **影響**: 管理者の場合に `view_mode` 切り替えUIを追加

#### 2. resources/views/reviews/index.blade.php
- **用途**: 口コミ管理画面での店舗一覧表示
- **影響**: 管理者の場合に `view_mode` 切り替えUIを追加

#### 3. resources/views/shops/schedule.blade.php
- **用途**: スケジュール画面での店舗一覧表示
- **影響**: 管理者の場合に `view_mode` 切り替えUIを追加

#### 4. resources/views/operator/dashboard.blade.php
- **用途**: オペレーターダッシュボード
- **影響**: オペレーター用なので影響なし

---

## ⑤ 今後Policyを導入する場合の影響箇所

### Policy作成が必要な箇所

**推奨Policy:** `app/Policies/ShopPolicy.php`

**必要なメソッド:**
```php
class ShopPolicy
{
    public function viewAny(User $user): bool
    {
        // 一覧表示権限
        // 管理者の場合: customer_scope に基づく
        // 一般ユーザーの場合: 自分の顧客のみ
    }
    
    public function view(User $user, Shop $shop): bool
    {
        // 詳細表示権限
        if ($user->is_admin) {
            if ($user->customer_scope === 'own') {
                return $shop->created_by === $user->id;
            }
            return true; // 'all' の場合は全顧客閲覧可能
        }
        return $shop->created_by === $user->id;
    }
    
    public function create(User $user): bool
    {
        // 作成権限（既存の権限チェックを使用）
        return $user->hasPermission('shops.index');
    }
    
    public function update(User $user, Shop $shop): bool
    {
        // 更新権限
        if ($user->is_admin) {
            if ($user->customer_scope === 'own') {
                return $shop->created_by === $user->id;
            }
            return true;
        }
        return $shop->created_by === $user->id;
    }
    
    public function delete(User $user, Shop $shop): bool
    {
        // 削除権限
        if ($user->is_admin) {
            if ($user->customer_scope === 'own') {
                return $shop->created_by === $user->id;
            }
            return true;
        }
        return $shop->created_by === $user->id;
    }
}
```

### Policy登録が必要な箇所

**ファイル:** `app/Providers/AuthServiceProvider.php`

**修正内容:**
```php
protected $policies = [
    Shop::class => ShopPolicy::class,
];
```

### ControllerでのPolicy使用箇所

**修正が必要なController:**

1. **ShopController**
   - `index()`: `$this->authorize('viewAny', Shop::class)`
   - `show()`: `$this->authorize('view', $shop)`
   - `create()`: `$this->authorize('create', Shop::class)`
   - `store()`: `$this->authorize('create', Shop::class)`
   - `update()`: `$this->authorize('update', $shop)`
   - `destroy()`: `$this->authorize('delete', $shop)`

2. **ReportController**
   - 店舗一覧取得箇所で `$this->authorize('viewAny', Shop::class)`
   - 店舗詳細取得箇所で `$this->authorize('view', $shop)`

3. **ReviewsController**
   - 店舗一覧取得箇所で `$this->authorize('viewAny', Shop::class)`
   - 店舗詳細取得箇所で `$this->authorize('view', $shop)`

### BladeでのPolicy使用箇所

**修正が必要なBlade:**

1. **resources/views/shops/index.blade.php**
   - 編集・削除ボタンの表示制御: `@can('update', $shop)`, `@can('delete', $shop)`

2. **resources/views/shops/show.blade.php**
   - 編集・削除ボタンの表示制御: `@can('update', $shop)`, `@can('delete', $shop)`

---

## 📊 影響範囲まとめ

### データベース変更

1. **マイグレーション作成が必要:**
   - `shops` テーブルに `created_by` カラム追加
   - `users` テーブルに `customer_scope` カラム追加

2. **モデル修正が必要:**
   - `app/Models/Shop.php`: `fillable` に `created_by` 追加、`createdBy()` リレーション追加
   - `app/Models/User.php`: `fillable` に `customer_scope` 追加、`casts` に追加（不要、stringのため）

### Controller修正箇所

| Controller | メソッド | 行数 | 修正内容 |
|-----------|---------|------|---------|
| ShopController | `store()` | 136 | `created_by` を追加 |
| ShopController | `index()` | 38-77 | `customer_scope` によるフィルタリング追加 |
| ShopController | `show()` | 160 | アクセス権限チェック追加 |
| ShopController | `update()` | 320 | アクセス権限チェック追加 |
| ShopController | `destroy()` | 408 | アクセス権限チェック追加 |
| ShopController | `schedule()` | 447-500 | `customer_scope` によるフィルタリング追加 |
| ReportController | `index()` | 30-189 | `customer_scope` によるフィルタリング追加 |
| ReportController | `syncAll()` | 105-145 | `customer_scope` によるフィルタリング追加 |
| ReportController | `show()` | 515-561 | `customer_scope` によるフィルタリング追加 |
| ReviewsController | `index()` | 38-356 | `customer_scope` によるフィルタリング追加 |

### Blade修正箇所

| Blade | 行数 | 修正内容 |
|------|------|---------|
| shops/index.blade.php | 7-9, 22-62 | `view_mode` 切り替えUI追加 |
| reports/index.blade.php | - | `view_mode` 切り替えUI追加 |
| reviews/index.blade.php | - | `view_mode` 切り替えUI追加 |
| shops/schedule.blade.php | - | `view_mode` 切り替えUI追加 |

### その他の修正箇所

1. **ルート定義:** 変更不要（既存のルート定義で対応可能）

2. **ミドルウェア:** 変更不要（既存の `admin.permission` ミドルウェアで対応可能）

3. **サービス層:** 変更不要（直接的な影響なし）

4. **Job/Queue:** 変更不要（`SyncShopDataJob` などは影響なし）

---

## ⚠️ 注意事項

### 既存データへの対応

1. **`created_by` が null の既存データ:**
   - マイグレーション時に既存データの `created_by` を設定する必要がある
   - 推奨: 最初の管理者ユーザーに割り当てる、または `null` のまま（全管理者が閲覧可能）

2. **`customer_scope` のデフォルト値:**
   - 新規ユーザー: `'own'`（デフォルト）
   - 既存ユーザー: マイグレーションで `'own'` を設定

### セキュリティ考慮事項

1. **アクセス権限チェック:**
   - すべての店舗操作（view, update, delete）で `created_by` と `customer_scope` をチェック
   - Policy導入前でも、Controller内で明示的にチェック

2. **URL直接アクセス対策:**
   - `show()`, `update()`, `destroy()` で権限チェックを必須
   - 403エラーを返す

3. **一覧取得の漏れ防止:**
   - すべての `Shop::query()` の後にフィルタリングを追加
   - オペレーター用の処理は既存のまま（影響なし）

---

## 🚀 実装優先順位

### Phase 1: データベース変更
1. マイグレーション作成（`created_by`, `customer_scope`）
2. モデル修正（`fillable`, リレーション）

### Phase 2: 基本機能実装
1. `ShopController::store()` で `created_by` を設定
2. `ShopController::index()` でフィルタリング実装
3. `ShopController::show()`, `update()`, `destroy()` で権限チェック

### Phase 3: 他のController対応
1. `ReportController` の各メソッドでフィルタリング追加
2. `ReviewsController` の各メソッドでフィルタリング追加
3. `ShopController::schedule()` でフィルタリング追加

### Phase 4: UI実装
1. `shops/index.blade.php` に切り替えUI追加
2. 他の一覧画面にも切り替えUI追加

### Phase 5: Policy導入（オプション）
1. `ShopPolicy` 作成
2. `AuthServiceProvider` に登録
3. Controllerで `authorize()` 使用
4. Bladeで `@can()` 使用

---

## 📝 まとめ

**影響範囲:**
- **Controller**: 10メソッド以上
- **Blade**: 4ファイル以上
- **Model**: 2ファイル
- **Migration**: 2ファイル

**実装難易度:** 中程度

**リスク:** 低（既存機能への影響は最小限、段階的実装可能）







