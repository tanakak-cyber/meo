# 投稿（localPosts）同期処理の詳細調査結果

## 1) localPosts API はどこで呼ばれているか？

### エンドポイントURL

**APIエンドポイント**: 
```
GET https://mybusiness.googleapis.com/v4/accounts/{accountId}/locations/{locationId}/localPosts
```

**コード**: `app/Services/GoogleBusinessProfileService.php` (913-993行目)

```php
public function listLocalPosts(string $accessToken, string $accountId, string $locationId): array
{
    // locationIdから "locations/" プレフィックスを除去
    $locationIdClean = str_replace('locations/', '', $locationId);
    
    // 正しいエンドポイント: /v4/accounts/{accountId}/locations/{locationId}/localPosts
    $url = "https://mybusiness.googleapis.com/v4/accounts/{$accountId}/locations/{$locationIdClean}/localPosts";
    
    $response = Http::withToken($accessToken)->get($url);
    
    if ($response->successful()) {
        $data = $response->json();
        $localPosts = $data['localPosts'] ?? [];
        return $localPosts; // 配列を返す
    }
    
    return [];
}
```

### 呼び出し箇所

**Controller**: `app/Http/Controllers/ReportController.php`

**メソッド**: `syncLocalPosts()` (1454-1536行目)

```php
private function syncLocalPosts(Shop $shop, string $accessToken, GoogleBusinessProfileService $googleService): int
{
    // ... バリデーション ...
    
    // API実行（直接Http::withToken()を使用、googleService->listLocalPosts()は使用していない）
    $url = "https://mybusiness.googleapis.com/v4/accounts/{$accountId}/locations/{$locationIdClean}/localPosts";
    $response = Http::withToken($accessToken)->get($url);
    
    // 成功時の処理
    $data = $response->json();
    $localPosts = $data['localPosts'] ?? [];
    $postCount = count($localPosts);
    
    // 投稿の中身は保存せず、件数のみを返す
    return $postCount;
}
```

**注意**: `syncLocalPosts()` メソッド内では `googleService->listLocalPosts()` を呼び出していない。直接 `Http::withToken()->get()` を使用している。

**呼び出し元**: 
- `ReportController::syncAll()` (632行目)
- `ReportController::sync()` (781行目)

```php
// 投稿を同期（件数のみを snapshot に保存）
$postsCount = $this->syncLocalPosts($shop, $accessToken, $googleService);

// スナップショットの数を更新
$snapshot->update([
    'posts_count' => $postsCount,
]);
```

---

## 2) 取得した投稿データは何を保存しているか？

### 結論: **件数のみ保存（詳細データは保存していない）**

### 保存しているデータ

| データ項目 | 保存有無 | 保存先 |
|----------|---------|--------|
| **投稿ID（gbp_post_id）** | ❌ NO | - |
| **本文（summary）** | ❌ NO | - |
| **作成日時（create_time）** | ❌ NO | - |
| **更新日時** | ❌ NO | - |
| **メディア情報** | ❌ NO | - |
| **ステータス（公開/期限切れ）** | ❌ NO | - |
| **件数のみ** | ✅ YES | `gbp_snapshots.posts_count` |

### コード根拠

**ファイル**: `app/Http/Controllers/ReportController.php` (1534-1535行目)

```php
// 投稿の中身は保存せず、件数のみを返す
return $postCount;
```

**保存処理**: 
- `GbpPost::create()` や `GbpPost::updateOrCreate()` の呼び出しは **存在しない**
- `gbp_snapshots.posts_count` に件数のみ保存（638行目, 787行目）

```php
$snapshot->update([
    'posts_count' => $postsCount,
]);
```

---

## 3) 保存先テーブルはどこか？

### 保存先テーブル

**`gbp_snapshots.posts_count`**: ✅ **YES（件数のみ）**

**`gbp_posts` テーブル**: ❌ **NO（同期処理では使用していない）**

### gbp_posts テーブルの存在

**テーブル**: `gbp_posts` は存在する

**マイグレーション**: `database/migrations/2026_02_01_000001_create_gbp_posts_table.php`

**初期構造**:
```php
Schema::create('gbp_posts', function (Blueprint $table) {
    $table->id();
    $table->foreignId('shop_id')->constrained()->onDelete('cascade');
    $table->foreignId('operator_id')->nullable()->constrained('operation_persons')->onDelete('cascade');
    $table->string('gbp_post_id');
    $table->datetime('create_time');
    $table->datetime('fetched_at');
    $table->timestamps();
    
    // UNIQUE KEY: (shop_id, operator_id, gbp_post_id)
    $table->unique(['shop_id', 'operator_id', 'gbp_post_id'], 'gbp_posts_unique');
});
```

**最新構造**（`GbpPost` モデルから推測）:
- `shop_id` (FK)
- `gbp_post_name` (string)
- `gbp_post_id` (string)
- `source_url` (string, nullable)
- `posted_at` (datetime, nullable)
- `summary` (text, nullable)
- `snapshot_id` (FK, nullable) ← **後で追加された**
- `create_time` (datetime)
- `event_start_date` (date, nullable)
- `event_end_date` (date, nullable)
- `call_to_action_type` (string, nullable)
- `call_to_action_url` (string, nullable)
- `media_url` (string, nullable)
- `is_deleted` (boolean)
- `fetched_at` (datetime)

**UNIQUE制約**: 
- 初期: `['shop_id', 'operator_id', 'gbp_post_id']`
- 現在: 要確認（`operator_id` が削除された可能性）

### gbp_posts テーブルの使用箇所

**同期処理では使用していない**: ✅ **確認済み**

**他の使用箇所**:
- `app/Console/Commands/SyncGbpPosts.php` (161行目): `GbpPost::create()` を使用
- `app/Http/Controllers/BlogTestController.php` (425行目): `GbpPost::create()` を使用
- `app/Console/Commands/CrawlAndPostBlogs.php` (551行目): `GbpPost::create()` を使用

**結論**: `gbp_posts` テーブルは存在するが、**同期処理（`syncLocalPosts()`）では使用されていない**。別の用途（ブログ投稿機能など）で使用されている可能性がある。

---

## 4) 同期1回で投稿データは増える構造か？

### 結論: **NO（件数のみ保存、詳細データは増えない）**

### 詳細

**同期1回の動作**:
1. `syncLocalPosts()` が `localPosts` 配列を取得
2. `count($localPosts)` で件数を計算
3. `gbp_snapshots.posts_count` を更新（INSERTではなくUPDATE）

**増加するレコード数**: **0レコード**（`gbp_snapshots` テーブルの既存レコードを更新するのみ）

**snapshotごとの保存**: ✅ **YES（件数のみ）**

**詳細データの重複保存**: ❌ **NO（詳細データは保存していない）**

### コード根拠

**ファイル**: `app/Http/Controllers/ReportController.php` (632-639行目, 781-788行目)

```php
// 投稿を同期（件数のみを snapshot に保存）
$postsCount = $this->syncLocalPosts($shop, $accessToken, $googleService);

// スナップショットの数を更新
$snapshot->update([
    'posts_count' => $postsCount,
]);
```

**`syncLocalPosts()` の戻り値**: `int`（件数のみ）

```php
// 投稿の中身は保存せず、件数のみを返す
return $postCount;
```

---

## 5) 現在の投稿同期方式は

### 結論: **C. 件数のみ保存**

### 各方式との比較

| 方式 | 該当 | 理由 |
|-----|------|------|
| **A. 状態型（updateOrCreate）** | ❌ NO | 詳細データを保存していない |
| **B. snapshot型（履歴保存）** | ❌ NO | 詳細データを保存していない |
| **C. 件数のみ保存** | ✅ **YES** | `gbp_snapshots.posts_count` に件数のみ保存 |
| **D. その他** | ❌ NO | - |

### 詳細

**現在の実装**:
- 投稿の詳細データ（ID、本文、作成日時等）は一切保存していない
- `gbp_snapshots.posts_count` に件数のみ保存
- 同期のたびに `posts_count` を更新（履歴は残らない）

**snapshot方式との違い**:
- snapshot方式（口コミ・写真）: 詳細データを `snapshot_id` と紐付けて保存、履歴が残る
- 投稿同期方式: 件数のみ保存、履歴は残らない

---

## 最終回答

### 投稿同期方式は「**件数のみ保存方式**」

### 詳細データ保存：**NO**

**根拠**:
- `syncLocalPosts()` メソッド内で `GbpPost::create()` や `GbpPost::updateOrCreate()` の呼び出しが存在しない
- コメントに「投稿の中身は保存せず、件数のみを返す」と明記されている（1534行目）
- `gbp_snapshots.posts_count` に件数のみ保存

### 重複リスク：**NO**

**理由**:
- 詳細データを保存していないため、重複の概念が存在しない
- `gbp_snapshots.posts_count` は `snapshot_id` ごとに1つの値のみ（重複しない）

### 将来的に問題になりうる点

1. **投稿の履歴が残らない**
   - 同期のたびに `posts_count` を上書きするため、過去の投稿数が分からない
   - 例: 1回目に10件、2回目に8件の場合、1回目の10件という情報は失われる

2. **投稿の詳細データが取得できない**
   - 投稿ID、本文、作成日時、メディア情報等が一切保存されていない
   - レポートで「どの投稿がいつ作成されたか」などの分析ができない

3. **投稿の削除・更新が検知できない**
   - 件数のみでは、どの投稿が削除されたか、更新されたかが分からない
   - 例: 10件→8件になった場合、どの2件が削除されたか不明

4. **投稿のステータス（公開/期限切れ）が分からない**
   - 件数には「有効な投稿数」が含まれるが、期限切れ投稿の数は分からない

5. **snapshot方式との不整合**
   - 口コミ・写真は snapshot方式で詳細データを保存しているが、投稿は件数のみ
   - データ構造の一貫性がない

6. **gbp_posts テーブルが未使用**
   - `gbp_posts` テーブルは存在し、`snapshot_id` カラムも追加されているが、同期処理では使用されていない
   - テーブル設計と実装が乖離している

---

## コード参照箇所まとめ

### API呼び出し
- `app/Services/GoogleBusinessProfileService.php` (913-993行目: `listLocalPosts()`)
- `app/Http/Controllers/ReportController.php` (1454-1536行目: `syncLocalPosts()`)

### 保存処理
- `app/Http/Controllers/ReportController.php` (632-639行目: `syncAll()` 内)
- `app/Http/Controllers/ReportController.php` (781-788行目: `sync()` 内)

### テーブル構造
- `database/migrations/2026_02_01_000001_create_gbp_posts_table.php` (初期構造)
- `app/Models/GbpPost.php` (最新構造の推測)

### 使用箇所（同期処理以外）
- `app/Console/Commands/SyncGbpPosts.php` (161行目)
- `app/Http/Controllers/BlogTestController.php` (425行目)
- `app/Console/Commands/CrawlAndPostBlogs.php` (551行目)









