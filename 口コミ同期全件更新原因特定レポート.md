# å£ã‚³ãƒŸåŒæœŸå…¨ä»¶æ›´æ–°åŸå› ç‰¹å®šãƒ¬ãƒãƒ¼ãƒˆ

## A. è©²å½“æ¯”è¼ƒéƒ¨åˆ†ã®ã‚³ãƒ¼ãƒ‰

### 1. æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—ã€œæ¯”è¼ƒã€œ$shouldSkipæ±ºå®šã€œcontinueã®ä¸€é€£

```php
// app/Services/ReviewSyncService.php:176-266

// æ—¢å­˜ã® update_timeï¼ˆNULLãªã‚‰ create_timeï¼‰ã¨æ¯”è¼ƒã—ã€API updateTime <= æ—¢å­˜ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
$existingReview = $existingReviews->get($reviewId);
$shouldSkip = false;
$existingTime = null;

if ($existingReview) {
    // æ—¢å­˜å´: DBã® update_time/create_time ã‚’å–å¾—
    $existingRaw = $existingReview->update_time ?? $existingReview->create_time ?? null;
    if ($existingRaw) {
        try {
            // DBã‹ã‚‰å–ã‚ŒãŸ Carbon ã¯ãã®ã¾ã¾ ->utc() ã«çµ±ä¸€ï¼ˆtimezoneäº‹æ•…é˜²æ­¢ï¼‰
            if ($existingRaw instanceof \Carbon\Carbon) {
                // Carbonå‹ã®å ´åˆã¯ãã®ã¾ã¾ ->utc() ã—ã¦ CarbonImmutable ã«å¤‰æ›
                $existingTime = CarbonImmutable::instance($existingRaw)->utc();
            } else {
                // æ–‡å­—åˆ—ã®å ´åˆã¯ createFromFormat ã§å³å¯†ã«èª­ã‚€
                $existingTimeRaw = (string)$existingRaw;
                $existingTime = CarbonImmutable::createFromFormat('Y-m-d H:i:s', $existingTimeRaw, 'UTC')->utc();
            }
        } catch (\Exception $e) {
            // createFromFormat ãŒä¾‹å¤–ãªã‚‰ parse fallback
            try {
                $existingTime = CarbonImmutable::parse($existingRaw, 'UTC')->utc();
            } catch (\Exception $e2) {
                Log::warning('ReviewSyncService: æ—¢å­˜æ™‚åˆ»ã®ãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—', [
                    'shop_id' => $shop->id,
                    'gbp_review_id' => $reviewId,
                    'existing_raw' => $existingRaw,
                    'existing_raw_type' => gettype($existingRaw),
                    'error' => $e2->getMessage(),
                ]);
                // ãƒ‘ãƒ¼ã‚¹å¤±æ•—æ™‚ã¯æ—¢å­˜æ™‚åˆ»ã‚’ null ã¨ã—ã¦æ‰±ã†ï¼ˆUPSERTå´ï¼‰
                $existingTime = null;
            }
        }
    }
    // ã‚‚ã— $existingRaw ãŒ null ãªã‚‰ã€existingãŒå£Šã‚Œã¦ã‚‹ã®ã§UPSERTå´ï¼ˆcreate_timeã‚‚å…¥ã‚Œã‚‹ï¼‰

    // åˆ¤å®š: api_update_time <= existing_time ãªã‚‰ SKIPã€api_update_time > existing_time ã®ã¨ãã®ã¿ UPSERT
    // æ¯”è¼ƒã¯å¿…ãš CarbonImmutable(UTC) åŒå£«ã§è¡Œã†
    if ($existingTime) {
        $shouldSkip = $apiTime->lessThanOrEqualTo($existingTime);
    }
}

if ($shouldSkip) {
    $skippedCount++;
    // ... ãƒ­ã‚°å‡ºåŠ› ...
    continue;
}
```

### 2. $hasChanges ã‚’æ±ºã‚ã¦ $rows ã«è¿½åŠ ã™ã‚‹ç®‡æ‰€

```php
// app/Services/ReviewSyncService.php:268-433

// å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆï¼‰
$hasChanges = false;
$changeReasons = [];

if ($existingReview) {
    // æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã¨æ¯”è¼ƒï¼ˆç©ºæ–‡å­—/NULLã®æ­£è¦åŒ–ï¼‰
    $normalizeString = function($value) {
        if ($value === null || $value === '') {
            return null;
        }
        return trim($value);
    };

    $newAuthorName = $normalizeString($review['reviewer']['displayName'] ?? 'ä¸æ˜');
    $newRating = $this->convertStarRating($review['starRating'] ?? null);
    $newComment = $normalizeString($review['comment'] ?? null);
    
    $replyText = data_get($review, 'reviewReply.comment');
    $replyUpdateTimeRaw = data_get($review, 'reviewReply.updateTime');
    $repliedAt = $replyUpdateTimeRaw
        ? Carbon::parse($replyUpdateTimeRaw)->utc()
        : null;
    $newReplyText = $normalizeString($replyText);
    $newRepliedAt = $repliedAt ? $repliedAt->format('Y-m-d H:i:s') : null;

    $existingAuthorName = $normalizeString($existingReview->author_name);
    $existingRating = $existingReview->rating;
    $existingComment = $normalizeString($existingReview->comment);
    $existingReplyText = $normalizeString($existingReview->reply_text);
    $existingRepliedAt = $existingReview->replied_at 
        ? ($existingReview->replied_at instanceof \Carbon\Carbon 
            ? $existingReview->replied_at->format('Y-m-d H:i:s')
            : (string)$existingReview->replied_at)
        : null;

    // å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆç†ç”±ã‚’è¨˜éŒ²ï¼‰
    if ($newAuthorName !== $existingAuthorName) {
        $hasChanges = true;
        $changeReasons[] = 'author_name_diff';
    }
    if ($newRating !== $existingRating) {
        $hasChanges = true;
        $changeReasons[] = 'rating_diff';
    }
    if ($newComment !== $existingComment) {
        $hasChanges = true;
        $changeReasons[] = 'comment_diff';
    }
    if ($newReplyText !== $existingReplyText) {
        $hasChanges = true;
        $changeReasons[] = 'reply_text_diff';
    }
    if ($newRepliedAt !== $existingRepliedAt) {
        $hasChanges = true;
        $changeReasons[] = 'replied_at_diff';
    }
    // åˆ¤å®š: api_update_time > existing_time ã®ã¨ãã®ã¿ UPSERT
    if ($existingTime && $apiTime->greaterThan($existingTime)) {
        $hasChanges = true;
        $changeReasons[] = 'update_time_gt';
    }
    
    // æ¤œè¨¼ç”¨ãƒ­ã‚°ï¼ˆæœ€åˆã®3ä»¶ã®ã¿ï¼‰
    if (count($rows) < 3) {
        // ... ãƒ­ã‚°å‡ºåŠ› ...
    }
} else {
    // æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰
    $hasChanges = true;
    
    // æ¤œè¨¼ç”¨ãƒ­ã‚°ï¼ˆæœ€åˆã®3ä»¶ã®ã¿ï¼‰
    if (count($rows) < 3) {
        // ... ãƒ­ã‚°å‡ºåŠ› ...
    }
}

// å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ $rows ã«è¿½åŠ 
if ($hasChanges) {
    $replyText = data_get($review, 'reviewReply.comment');
    $replyUpdateTimeRaw = data_get($review, 'reviewReply.updateTime');
    $repliedAt = $replyUpdateTimeRaw
        ? Carbon::parse($replyUpdateTimeRaw)->utc()
        : null;

    $rows[] = [
        'shop_id' => $shop->id,
        'gbp_review_id' => $reviewId,
        'snapshot_id' => $snapshotId,
        'author_name' => $review['reviewer']['displayName'] ?? 'ä¸æ˜',
        'rating' => $this->convertStarRating($review['starRating'] ?? null),
        'comment' => $review['comment'] ?? null,
        'create_time' => $createTime->format('Y-m-d H:i:s'),
        'update_time' => $apiTime->format('Y-m-d H:i:s'), // updateTime ãŒç„¡ã„å ´åˆã¯ createTime ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        'reply_text' => $replyText,
        'replied_at' => $repliedAt ? $repliedAt->format('Y-m-d H:i:s') : null,
    ];

    // æœ€å¤§updateTimeã‚’æ›´æ–°
    if ($maxUpdateTime === null || $apiTime->greaterThan($maxUpdateTime)) {
        $maxUpdateTime = $apiTime;
    }
} else {
    $skippedCount++;
}
```

### 3. upsert ã®æ›´æ–°ã‚«ãƒ©ãƒ 

```php
// app/Services/ReviewSyncService.php:460-475

Review::upsert(
    $rows,
    ['shop_id', 'gbp_review_id'], // ãƒ¦ãƒ‹ãƒ¼ã‚¯ã‚­ãƒ¼
    [
        // 'snapshot_id' ã¯é™¤å¤–ï¼ˆæ¯å›å¤‰ã‚ã‚‹ãŸã‚ã€æ›´æ–°æ™‚ã«å¤‰æ›´ã™ã‚‹ã¨å…¨ä»¶æ›´æ–°ã«ãªã‚‹ï¼‰
        // snapshot_id ã¯æ–°è¦insertæ™‚ã®ã¿è¨­å®šã•ã‚Œã‚‹ï¼ˆupsertã®ä»•æ§˜ä¸Šã€insertæ™‚ã¯å…¨ã‚«ãƒ©ãƒ ãŒè¨­å®šã•ã‚Œã‚‹ï¼‰
        'author_name',
        'rating',
        'comment',
        'create_time',
        'reply_text',
        'replied_at',
        'update_time',   // â† ã“ã‚Œã‚’å¿…ãšå…¥ã‚Œã‚‹
        // 'updated_at' ã¯é™¤å¤–ï¼ˆDBã«ä»»ã›ã‚‹ï¼‰
    ]
);
```

## B. "å…¨ä»¶æ›´æ–°"ã®å…¸å‹åŸå› ãƒã‚§ãƒƒã‚¯

### 1. $rows[] ãŒ "hasChangesåˆ¤å®šãªã—" ã§å…¥ã£ã¦ãªã„ã‹ï¼Ÿ

**ç¢ºèªçµæœ**: âœ… **å•é¡Œãªã—**

- `if ($hasChanges) { $rows[] = ... }` ã§åˆ¤å®šã•ã‚Œã¦ã„ã‚‹ï¼ˆ407è¡Œç›®ï¼‰
- `shouldSkip` ãƒ–ãƒ­ãƒƒã‚¯ã‚’æŠœã‘ãŸå¾Œã€`hasChanges=false` ã§ã‚‚ `$rows` ã«å…¥ã‚‹çµŒè·¯ã¯ãªã„
- `else { $skippedCount++; }` ã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹ï¼ˆ432è¡Œç›®ï¼‰

### 2. upsert() ã®æ›´æ–°ã‚«ãƒ©ãƒ ã«ã€Œæ¯å›å¤‰ã‚ã‚‹å€¤ã€ãŒå…¥ã£ã¦ãªã„ã‹ï¼Ÿ

**ç¢ºèªçµæœ**: âš ï¸ **æ½œåœ¨çš„ãªå•é¡Œã‚ã‚Š**

**è©²å½“ç®‡æ‰€**: `app/Services/ReviewSyncService.php:460-475`

**æ›´æ–°ã‚«ãƒ©ãƒ **:
- `snapshot_id`: âœ… é™¤å¤–ã•ã‚Œã¦ã„ã‚‹ï¼ˆ464è¡Œç›®ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
- `updated_at`: âœ… é™¤å¤–ã•ã‚Œã¦ã„ã‚‹ï¼ˆ473è¡Œç›®ã®ã‚³ãƒ¡ãƒ³ãƒˆï¼‰
- `create_time`: âš ï¸ **å«ã¾ã‚Œã¦ã„ã‚‹ï¼ˆ469è¡Œç›®ï¼‰** - ã“ã‚Œã¯å•é¡Œãªã„ã¯ãšã ãŒã€ç¢ºèªãŒå¿…è¦
- `update_time`: âœ… å«ã¾ã‚Œã¦ã„ã‚‹ï¼ˆ472è¡Œç›®ï¼‰- ã“ã‚Œã¯æ„å›³é€šã‚Š

**å•é¡Œç‚¹**: `create_time` ãŒæ›´æ–°ã‚«ãƒ©ãƒ ã«å«ã¾ã‚Œã¦ã„ã‚‹ãŒã€ã“ã‚Œã¯é€šå¸¸å¤‰æ›´ã•ã‚Œãªã„å€¤ãªã®ã§å•é¡Œãªã„ã¯ãšã€‚ãŸã ã—ã€ã‚‚ã— `create_time` ãŒæ¯å›å¤‰ã‚ã£ã¦ã„ã‚‹å ´åˆã¯å…¨ä»¶æ›´æ–°ã«ãªã‚‹ã€‚

### 3. compare_api_lte_existing / existing_update_time ã®ãƒ­ã‚°ãŒ "æ¯”è¼ƒã«ä½¿ã£ãŸå€¤" ã‹ã‚‰ä½œã‚‰ã‚Œã¦ã‚‹ã‹ï¼Ÿ

**ç¢ºèªçµæœ**: âœ… **å•é¡Œãªã—**

- ãƒ­ã‚°ã® `api_update_time` / `existing_update_time` ã¯ `$apiTime` / `$existingTime` ã‹ã‚‰å‡ºã—ã¦ã„ã‚‹ï¼ˆ233-234è¡Œç›®ã€340-341è¡Œç›®ï¼‰
- `compare_api_lte_existing` ã¯ `$compareResult` ã§å®Ÿéš›ã«åˆ¤å®šã«ä½¿ã£ãŸçµæœã‚’ãã®ã¾ã¾å‡ºã—ã¦ã„ã‚‹ï¼ˆ246è¡Œç›®ã€353è¡Œç›®ï¼‰

### 4. æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®çªåˆã‚­ãƒ¼ãŒã‚ºãƒ¬ã¦ã„ãªã„ã‹ï¼Ÿ

**ç¢ºèªçµæœ**: âš ï¸ **ç¢ºèªãŒå¿…è¦**

**è©²å½“ç®‡æ‰€**: `app/Services/ReviewSyncService.php:82-85, 108, 177`

```php
// æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼å–å¾—
$existingReviews = Review::where('shop_id', $shop->id)
    ->whereNotNull('gbp_review_id')
    ->get()
    ->keyBy('gbp_review_id'); // âœ… keyBy('gbp_review_id') ã«ãªã£ã¦ã„ã‚‹

// APIå´ã®reviewIdå–å¾—
$reviewId = trim(basename($review['name'])); // âœ… basenameã§å–å¾—

// çªåˆ
$existingReview = $existingReviews->get($reviewId); // âœ… åŒã˜ã‚­ãƒ¼ã§å–å¾—
```

**æ½œåœ¨çš„ãªå•é¡Œ**:
- `$reviewId` ãŒæ­£ã—ãå–å¾—ã§ãã¦ã„ã‚‹ã‹ï¼ˆ`review['name']` ã®å½¢å¼ãŒæƒ³å®šé€šã‚Šã‹ï¼‰
- `$existingReviews->get($reviewId)` ãŒ `null` ã‚’è¿”ã—ã¦ã„ã‚‹å ´åˆã€æ¯å› "æ–°è¦æ‰±ã„" ã§ `$rows` ã«å…¥ã‚‹

## C. åŸå› ã®ç‰¹å®šï¼ˆç¬¬ä¸€å®¹ç–‘è€…ï¼‰

### ç¬¬ä¸€å®¹ç–‘è€…: **$existingTime ãŒ null ã®å ´åˆã®å‡¦ç†**

**å•é¡Œç®‡æ‰€**: `app/Services/ReviewSyncService.php:216-218`

```php
// åˆ¤å®š: api_update_time <= existing_time ãªã‚‰ SKIPã€api_update_time > existing_time ã®ã¨ãã®ã¿ UPSERT
// æ¯”è¼ƒã¯å¿…ãš CarbonImmutable(UTC) åŒå£«ã§è¡Œã†
if ($existingTime) {
    $shouldSkip = $apiTime->lessThanOrEqualTo($existingTime);
}
```

**å•é¡Œç‚¹**:
- `$existingTime` ãŒ `null` ã®å ´åˆã€`$shouldSkip` ã¯ `false` ã®ã¾ã¾ï¼ˆåˆæœŸå€¤ï¼‰
- ãã®çµæœã€`shouldSkip` ãƒ–ãƒ­ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ `hasChanges` åˆ¤å®šã«é€²ã‚€
- `hasChanges` åˆ¤å®šã§ã€`$existingTime` ãŒ `null` ã ã¨ `update_time_gt` åˆ¤å®šã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ãŒã€ä»–ã®æ¯”è¼ƒï¼ˆauthor_name, rating, commentç­‰ï¼‰ã§å·®åˆ†ãŒã‚ã‚‹ã¨ `$hasChanges = true` ã«ãªã‚‹
- **ã—ã‹ã—ã€ã‚‚ã—å…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒåŒã˜ãªã‚‰ã€`$hasChanges = false` ã«ãªã‚‹ã¯ãš**

### ç¬¬äºŒå®¹ç–‘è€…: **$existingReview ãŒ null ã®å ´åˆï¼ˆæ–°è¦æ‰±ã„ï¼‰**

**å•é¡Œç®‡æ‰€**: `app/Services/ReviewSyncService.php:177, 364-403`

```php
$existingReview = $existingReviews->get($reviewId);
// ...
if ($existingReview) {
    // ... æ¯”è¼ƒå‡¦ç† ...
} else {
    // æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰
    $hasChanges = true; // â† å¸¸ã« true
    // ...
}
```

**å•é¡Œç‚¹**:
- `$existingReview` ãŒ `null` ã®å ´åˆã€æ¯å› "æ–°è¦æ‰±ã„" ã§ `$hasChanges = true` ã«ãªã‚Šã€`$rows` ã«å…¥ã‚‹
- ã“ã‚Œã¯ `$reviewId` ãŒæ­£ã—ãå–å¾—ã§ãã¦ã„ãªã„ã€ã¾ãŸã¯ `$existingReviews` ã«è©²å½“ã™ã‚‹ã‚­ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã«ç™ºç”Ÿ

## D. æœ€çŸ­ã§åŸå› ã‚’ç‚™ã‚Šå‡ºã™ä¸€ç™ºãƒ­ã‚°ï¼ˆææ¡ˆï¼‰

ä»¥ä¸‹ã®ãƒ­ã‚°ã‚’ "åŒä¸€åº—èˆ— 1å›ã®åŒæœŸã§æœ€åˆã®5ä»¶ã ã‘" å‡ºã™ï¼š

```php
// app/Services/ReviewSyncService.php:268è¡Œç›®ã®ç›´å¾Œï¼ˆ$hasChanges = false; ã®å¾Œï¼‰ã«è¿½åŠ 

// æœ€çŸ­ã§åŸå› ã‚’ç‚™ã‚Šå‡ºã™ä¸€ç™ºãƒ­ã‚°ï¼ˆæœ€åˆã®5ä»¶ã ã‘ï¼‰
if (count($rows) + $skippedCount < 5) {
    Log::info('REVIEWS_DIFF_ROOT_CAUSE', [
        'shop_id' => $shop->id,
        'gbp_review_id' => $reviewId,
        'existing_hit' => $existingReview !== null, // æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒãƒ’ãƒƒãƒˆã—ãŸã‹
        'existing_time_is_null' => $existingTime === null, // existingTimeãŒnullã‹
        'shouldSkip' => $shouldSkip, // æœ€çµ‚å€¤
        'hasChanges' => $hasChanges, // æœ€çµ‚å€¤ï¼ˆåˆ¤å®šå¾Œï¼‰
        'rows_appended' => $hasChanges, // $rowsã«è¿½åŠ ã•ã‚ŒãŸã‹
        'changeReasons' => $changeReasons, // å¤‰æ›´ç†ç”±ã®é…åˆ—
        'api_ts' => $apiTime->timestamp,
        'existing_ts' => $existingTime ? $existingTime->timestamp : null,
        'api_time_iso' => $apiTime->toIso8601String(),
        'existing_time_iso' => $existingTime ? $existingTime->toIso8601String() : null,
        'review_id_from_api' => $reviewId, // APIã‹ã‚‰å–å¾—ã—ãŸreviewId
        'existing_review_ids_sample' => $existingReviews->keys()->take(3)->toArray(), // æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã‚­ãƒ¼ã‚µãƒ³ãƒ—ãƒ«ï¼ˆæœ€åˆã®3ä»¶ï¼‰
    ]);
}
```

## E. ä¿®æ­£ãƒ‘ãƒƒãƒæ–¹é‡ï¼ˆæœ€å°å¤‰æ›´ï¼‰

### ä¿®æ­£æ¡ˆ1: $existingTime ãŒ null ã®å ´åˆã®å‡¦ç†ã‚’æ”¹å–„

**å•é¡Œ**: `$existingTime` ãŒ `null` ã®å ´åˆã€`$shouldSkip` ãŒ `false` ã®ã¾ã¾ã«ãªã‚Šã€`hasChanges` åˆ¤å®šã«é€²ã‚€

**ä¿®æ­£æ–¹é‡**: `$existingTime` ãŒ `null` ã®å ´åˆã€`$existingReview` ãŒå­˜åœ¨ã™ã‚‹ãªã‚‰ã€`$shouldSkip = false` ã®ã¾ã¾ï¼ˆæ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã ãŒæ™‚åˆ»ãŒå–å¾—ã§ããªã„ï¼‰ã¨ã—ã¦æ‰±ã†ã€‚ãŸã ã—ã€`hasChanges` åˆ¤å®šã§ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å·®åˆ†ãŒãªã„å ´åˆã¯ `$hasChanges = false` ã«ãªã‚‹ã¯ãšã€‚

**ä¿®æ­£ç®‡æ‰€**: `app/Services/ReviewSyncService.php:216-218`

```php
// ä¿®æ­£å‰
if ($existingTime) {
    $shouldSkip = $apiTime->lessThanOrEqualTo($existingTime);
}

// ä¿®æ­£å¾Œï¼ˆå¤‰æ›´ãªã— - ç¾çŠ¶ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯æ­£ã—ã„ï¼‰
// $existingTime ãŒ null ã®å ´åˆã¯ $shouldSkip = false ã®ã¾ã¾ï¼ˆæ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã ãŒæ™‚åˆ»ãŒå–å¾—ã§ããªã„ï¼‰
// hasChanges åˆ¤å®šã§ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å·®åˆ†ãŒãªã„å ´åˆã¯ $hasChanges = false ã«ãªã‚‹
```

### ä¿®æ­£æ¡ˆ2: $existingReview ãŒ null ã®å ´åˆã®ãƒ­ã‚°è¿½åŠ 

**å•é¡Œ**: `$existingReview` ãŒ `null` ã®å ´åˆã€æ¯å› "æ–°è¦æ‰±ã„" ã§ `$hasChanges = true` ã«ãªã‚Šã€`$rows` ã«å…¥ã‚‹

**ä¿®æ­£æ–¹é‡**: ãƒ­ã‚°ã‚’è¿½åŠ ã—ã¦ã€`$existingReview` ãŒ `null` ã«ãªã‚‹åŸå› ã‚’ç‰¹å®šã™ã‚‹

**ä¿®æ­£ç®‡æ‰€**: `app/Services/ReviewSyncService.php:177è¡Œç›®ã®ç›´å¾Œ`

```php
$existingReview = $existingReviews->get($reviewId);

// ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ï¼ˆæœ€åˆã®5ä»¶ã ã‘ï¼‰
if (count($rows) + $skippedCount < 5) {
    Log::info('REVIEWS_DIFF_ROOT_CAUSE', [
        'shop_id' => $shop->id,
        'gbp_review_id' => $reviewId,
        'existing_hit' => $existingReview !== null,
        'existing_time_is_null' => $existingTime === null,
        'shouldSkip' => $shouldSkip,
        'hasChanges' => $hasChanges, // ã“ã®æ™‚ç‚¹ã§ã¯ã¾ã  falseï¼ˆå¾Œã§åˆ¤å®šã•ã‚Œã‚‹ï¼‰
        'rows_appended' => false, // ã“ã®æ™‚ç‚¹ã§ã¯ã¾ã  falseï¼ˆå¾Œã§åˆ¤å®šã•ã‚Œã‚‹ï¼‰
        'changeReasons' => [], // ã“ã®æ™‚ç‚¹ã§ã¯ã¾ã ç©ºï¼ˆå¾Œã§åˆ¤å®šã•ã‚Œã‚‹ï¼‰
        'api_ts' => $apiTime->timestamp,
        'existing_ts' => $existingTime ? $existingTime->timestamp : null,
        'review_id_from_api' => $reviewId,
        'existing_review_ids_sample' => $existingReviews->keys()->take(3)->toArray(),
    ]);
}
```

### ä¿®æ­£æ¡ˆ3: hasChanges åˆ¤å®šå¾Œã®ãƒ­ã‚°è¿½åŠ 

**ä¿®æ­£ç®‡æ‰€**: `app/Services/ReviewSyncService.php:406è¡Œç›®ã®ç›´å‰ï¼ˆif ($hasChanges) { ã®ç›´å‰ï¼‰`

```php
// å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ $rows ã«è¿½åŠ 
// æœ€çŸ­ã§åŸå› ã‚’ç‚™ã‚Šå‡ºã™ä¸€ç™ºãƒ­ã‚°ï¼ˆæœ€åˆã®5ä»¶ã ã‘ï¼‰
if (count($rows) + $skippedCount < 5) {
    Log::info('REVIEWS_DIFF_ROOT_CAUSE', [
        'shop_id' => $shop->id,
        'gbp_review_id' => $reviewId,
        'existing_hit' => $existingReview !== null,
        'existing_time_is_null' => $existingTime === null,
        'shouldSkip' => $shouldSkip, // æœ€çµ‚å€¤
        'hasChanges' => $hasChanges, // æœ€çµ‚å€¤ï¼ˆåˆ¤å®šå¾Œï¼‰
        'rows_appended' => $hasChanges, // $rowsã«è¿½åŠ ã•ã‚Œã‚‹ã‹
        'changeReasons' => $changeReasons, // å¤‰æ›´ç†ç”±ã®é…åˆ—
        'api_ts' => $apiTime->timestamp,
        'existing_ts' => $existingTime ? $existingTime->timestamp : null,
        'api_time_iso' => $apiTime->toIso8601String(),
        'existing_time_iso' => $existingTime ? $existingTime->toIso8601String() : null,
        'review_id_from_api' => $reviewId,
        'existing_review_ids_sample' => $existingReviews->keys()->take(3)->toArray(),
    ]);
}

if ($hasChanges) {
    // ... $rows[] ã«è¿½åŠ  ...
}
```

## F. åŸå› ã®æ–­å®šï¼ˆç¬¬ä¸€å®¹ç–‘è€…ï¼‰

### ç¬¬ä¸€å®¹ç–‘è€…: **$existingReview ãŒ null ã®å ´åˆï¼ˆæ–°è¦æ‰±ã„ï¼‰**

**å•é¡Œç®‡æ‰€**: `app/Services/ReviewSyncService.php:177, 364-403`

**ç—‡çŠ¶**:
- `fetched_count == existing_count` ãªã®ã« `rows_to_write_count` ãŒå¤§ãã„
- 2å›é€£ç¶šåŒæœŸã§ã‚‚æ”¹å–„ã—ãªã„

**åŸå› **:
- `$existingReview = $existingReviews->get($reviewId);` ãŒ `null` ã‚’è¿”ã—ã¦ã„ã‚‹
- ãã®çµæœã€æ¯å› "æ–°è¦æ‰±ã„" ã§ `$hasChanges = true` ã«ãªã‚Šã€`$rows` ã«å…¥ã‚‹
- ã“ã‚Œã¯ `$reviewId` ãŒæ­£ã—ãå–å¾—ã§ãã¦ã„ãªã„ã€ã¾ãŸã¯ `$existingReviews` ã«è©²å½“ã™ã‚‹ã‚­ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã«ç™ºç”Ÿ

**ç¢ºèªæ–¹æ³•**:
- `REVIEWS_DIFF_ROOT_CAUSE` ãƒ­ã‚°ã§ `existing_hit: false` ãŒå¤šæ•°å‡ºã¦ã„ã‚‹ã‹ç¢ºèª
- `review_id_from_api` ã¨ `existing_review_ids_sample` ã‚’æ¯”è¼ƒã—ã¦ã€ã‚­ãƒ¼ã®å½¢å¼ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèª

### ç¬¬äºŒå®¹ç–‘è€…: **$existingTime ãŒ null ã®å ´åˆã®å‡¦ç†**

**å•é¡Œç®‡æ‰€**: `app/Services/ReviewSyncService.php:216-218, 325`

**ç—‡çŠ¶**:
- `$existingReview` ã¯å­˜åœ¨ã™ã‚‹ãŒã€`$existingTime` ãŒ `null` ã®å ´åˆ
- `$shouldSkip = false` ã®ã¾ã¾ï¼ˆåˆæœŸå€¤ï¼‰
- `hasChanges` åˆ¤å®šã§ã€`$existingTime` ãŒ `null` ã ã¨ `update_time_gt` åˆ¤å®šã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ãŒã€ä»–ã®æ¯”è¼ƒï¼ˆauthor_name, rating, commentç­‰ï¼‰ã§å·®åˆ†ãŒã‚ã‚‹ã¨ `$hasChanges = true` ã«ãªã‚‹

**ç¢ºèªæ–¹æ³•**:
- `REVIEWS_DIFF_ROOT_CAUSE` ãƒ­ã‚°ã§ `existing_hit: true` ã‹ã¤ `existing_time_is_null: true` ãŒå¤šæ•°å‡ºã¦ã„ã‚‹ã‹ç¢ºèª
- `changeReasons` ã« `update_time_gt` ä»¥å¤–ã®ç†ç”±ï¼ˆ`author_name_diff`, `rating_diff`, `comment_diff` ç­‰ï¼‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### ç¬¬ä¸‰å®¹ç–‘è€…: **ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆauthor_name, rating, commentç­‰ï¼‰ã«æ¯å›å·®åˆ†ãŒã‚ã‚‹**

**å•é¡Œç®‡æ‰€**: `app/Services/ReviewSyncService.php:304-323`

**ç—‡çŠ¶**:
- `$existingReview` ã¯å­˜åœ¨ã—ã€`$existingTime` ã‚‚å­˜åœ¨ã™ã‚‹
- ã—ã‹ã—ã€`author_name`, `rating`, `comment`, `reply_text`, `replied_at` ã®ã„ãšã‚Œã‹ã«æ¯å›å·®åˆ†ãŒã‚ã‚‹
- ãã®çµæœã€`$hasChanges = true` ã«ãªã‚Šã€`$rows` ã«å…¥ã‚‹

**ç¢ºèªæ–¹æ³•**:
- `REVIEWS_DIFF_ROOT_CAUSE` ãƒ­ã‚°ã§ `changeReasons` ã« `update_time_gt` ä»¥å¤–ã®ç†ç”±ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- `REVIEWS_DIFF_DECISION` ãƒ­ã‚°ã§ `api_reply_text_hash` / `existing_reply_text_hash` ã‚„ `api_comment_hash` / `existing_comment_hash` ãŒç•°ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª

## G. ä¿®æ­£ãƒ‘ãƒƒãƒæ–¹é‡ï¼ˆæœ€å°å¤‰æ›´ï¼‰

### ä¿®æ­£æ¡ˆ1: $existingReview ãŒ null ã®å ´åˆã®ãƒ­ã‚°è¿½åŠ ã¨åŸå› ç‰¹å®š

**ä¿®æ­£ç®‡æ‰€**: `app/Services/ReviewSyncService.php:177è¡Œç›®ã®ç›´å¾Œ`

```php
$existingReview = $existingReviews->get($reviewId);

// ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ï¼ˆæœ€åˆã®5ä»¶ã ã‘ï¼‰
if (count($rows) + $skippedCount < 5) {
    Log::info('REVIEWS_DIFF_ROOT_CAUSE', [
        'shop_id' => $shop->id,
        'gbp_review_id' => $reviewId,
        'existing_hit' => $existingReview !== null,
        'existing_time_is_null' => $existingTime === null,
        'shouldSkip' => $shouldSkip, // ã“ã®æ™‚ç‚¹ã§ã¯ã¾ã  falseï¼ˆå¾Œã§åˆ¤å®šã•ã‚Œã‚‹ï¼‰
        'hasChanges' => false, // ã“ã®æ™‚ç‚¹ã§ã¯ã¾ã  falseï¼ˆå¾Œã§åˆ¤å®šã•ã‚Œã‚‹ï¼‰
        'rows_appended' => false, // ã“ã®æ™‚ç‚¹ã§ã¯ã¾ã  falseï¼ˆå¾Œã§åˆ¤å®šã•ã‚Œã‚‹ï¼‰
        'changeReasons' => [], // ã“ã®æ™‚ç‚¹ã§ã¯ã¾ã ç©ºï¼ˆå¾Œã§åˆ¤å®šã•ã‚Œã‚‹ï¼‰
        'api_ts' => $apiTime->timestamp,
        'existing_ts' => $existingTime ? $existingTime->timestamp : null,
        'review_id_from_api' => $reviewId,
        'existing_review_ids_sample' => $existingReviews->keys()->take(3)->toArray(),
    ]);
}
```

**æ³¨æ„**: ã“ã®ãƒ­ã‚°ã¯ `$existingTime` ãŒåˆ¤å®šã•ã‚Œã‚‹å‰ãªã®ã§ã€`existing_time_is_null` ã¯å¸¸ã« `true` ã«ãªã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚ã‚ˆã‚Šæ­£ç¢ºãªãƒ­ã‚°ã¯ `hasChanges` åˆ¤å®šå¾Œã«å‡ºåŠ›ã™ã‚‹ï¼ˆæ—¢ã«å®Ÿè£…æ¸ˆã¿ï¼‰ã€‚

### ä¿®æ­£æ¡ˆ2: hasChanges åˆ¤å®šå¾Œã®ãƒ­ã‚°è¿½åŠ ï¼ˆæ—¢ã«å®Ÿè£…æ¸ˆã¿ï¼‰

**ä¿®æ­£ç®‡æ‰€**: `app/Services/ReviewSyncService.php:406è¡Œç›®ã®ç›´å‰ï¼ˆif ($hasChanges) { ã®ç›´å‰ï¼‰`

```php
// æœ€çŸ­ã§åŸå› ã‚’ç‚™ã‚Šå‡ºã™ä¸€ç™ºãƒ­ã‚°ï¼ˆæœ€åˆã®5ä»¶ã ã‘ï¼‰
if (count($rows) + $skippedCount < 5) {
    Log::info('REVIEWS_DIFF_ROOT_CAUSE', [
        'shop_id' => $shop->id,
        'gbp_review_id' => $reviewId,
        'existing_hit' => $existingReview !== null,
        'existing_time_is_null' => $existingTime === null,
        'shouldSkip' => $shouldSkip, // æœ€çµ‚å€¤
        'hasChanges' => $hasChanges, // æœ€çµ‚å€¤ï¼ˆåˆ¤å®šå¾Œï¼‰
        'rows_appended' => $hasChanges, // $rowsã«è¿½åŠ ã•ã‚Œã‚‹ã‹
        'changeReasons' => $changeReasons, // å¤‰æ›´ç†ç”±ã®é…åˆ—
        'api_ts' => $apiTime->timestamp,
        'existing_ts' => $existingTime ? $existingTime->timestamp : null,
        'api_time_iso' => $apiTime->toIso8601String(),
        'existing_time_iso' => $existingTime ? $existingTime->toIso8601String() : null,
        'review_id_from_api' => $reviewId,
        'existing_review_ids_sample' => $existingReviews->keys()->take(3)->toArray(),
    ]);
}

if ($hasChanges) {
    // ... $rows[] ã«è¿½åŠ  ...
}
```

**å®Ÿè£…çŠ¶æ³**: âœ… **æ—¢ã«å®Ÿè£…æ¸ˆã¿**ï¼ˆ406è¡Œç›®ã®ç›´å‰ï¼‰

## H. åŸå› ã®æ–­å®šï¼ˆç¬¬ä¸€å®¹ç–‘è€…ã‚’1ã¤ã«çµã‚‹ï¼‰

### ç¬¬ä¸€å®¹ç–‘è€…: **$existingReview ãŒ null ã®å ´åˆï¼ˆæ–°è¦æ‰±ã„ï¼‰**

**ç¢ºä¿¡åº¦**: ğŸ”´ **é«˜ï¼ˆ80%ï¼‰**

**æ ¹æ‹ **:
- `fetched_count == existing_count` ãªã®ã« `rows_to_write_count` ãŒå¤§ãã„
- 2å›é€£ç¶šåŒæœŸã§ã‚‚æ”¹å–„ã—ãªã„
- ã“ã‚Œã¯æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã®ã«ã€`$existingReviews->get($reviewId)` ãŒ `null` ã‚’è¿”ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„

**å•é¡Œç®‡æ‰€**: `app/Services/ReviewSyncService.php:177`

```php
$existingReview = $existingReviews->get($reviewId);
```

**åŸå› å€™è£œ**:
1. `$reviewId` ã®å–å¾—æ–¹æ³•ãŒæ­£ã—ããªã„ï¼ˆ`basename($review['name'])` ã®çµæœãŒDBã® `gbp_review_id` ã¨ä¸€è‡´ã—ãªã„ï¼‰
2. `$existingReviews` ã®ã‚­ãƒ¼å½¢å¼ã¨ `$reviewId` ã®å½¢å¼ãŒä¸€è‡´ã—ã¦ã„ãªã„ï¼ˆå¤§æ–‡å­—å°æ–‡å­—ã€å‰å¾Œã®ç©ºç™½ç­‰ï¼‰

**ç¢ºèªæ–¹æ³•**:
- `REVIEWS_DIFF_ROOT_CAUSE` ãƒ­ã‚°ã§ `existing_hit: false` ãŒå¤šæ•°å‡ºã¦ã„ã‚‹ã‹ç¢ºèª
- `review_id_from_api` ã¨ `existing_review_ids_sample` ã‚’æ¯”è¼ƒã—ã¦ã€ã‚­ãƒ¼ã®å½¢å¼ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ç¢ºèª

### ç¬¬äºŒå®¹ç–‘è€…: **ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆauthor_name, rating, commentç­‰ï¼‰ã«æ¯å›å·®åˆ†ãŒã‚ã‚‹**

**ç¢ºä¿¡åº¦**: ğŸŸ¡ **ä¸­ï¼ˆ15%ï¼‰**

**æ ¹æ‹ **:
- `$existingReview` ã¯å­˜åœ¨ã™ã‚‹ãŒã€`author_name`, `rating`, `comment`, `reply_text`, `replied_at` ã®ã„ãšã‚Œã‹ã«æ¯å›å·®åˆ†ãŒã‚ã‚‹
- ãã®çµæœã€`$hasChanges = true` ã«ãªã‚Šã€`$rows` ã«å…¥ã‚‹

**å•é¡Œç®‡æ‰€**: `app/Services/ReviewSyncService.php:304-323`

**ç¢ºèªæ–¹æ³•**:
- `REVIEWS_DIFF_ROOT_CAUSE` ãƒ­ã‚°ã§ `changeReasons` ã« `update_time_gt` ä»¥å¤–ã®ç†ç”±ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
- `REVIEWS_DIFF_DECISION` ãƒ­ã‚°ã§ `api_reply_text_hash` / `existing_reply_text_hash` ã‚„ `api_comment_hash` / `existing_comment_hash` ãŒç•°ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª

### ç¬¬ä¸‰å®¹ç–‘è€…: **$existingTime ãŒ null ã®å ´åˆã®å‡¦ç†**

**ç¢ºä¿¡åº¦**: ğŸŸ¢ **ä½ï¼ˆ5%ï¼‰**

**æ ¹æ‹ **:
- `$existingReview` ã¯å­˜åœ¨ã™ã‚‹ãŒã€`$existingTime` ãŒ `null` ã®å ´åˆ
- `$shouldSkip = false` ã®ã¾ã¾ï¼ˆåˆæœŸå€¤ï¼‰
- `hasChanges` åˆ¤å®šã§ã€`$existingTime` ãŒ `null` ã ã¨ `update_time_gt` åˆ¤å®šã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ãŒã€ä»–ã®æ¯”è¼ƒã§å·®åˆ†ãŒã‚ã‚‹ã¨ `$hasChanges = true` ã«ãªã‚‹

**ç¢ºèªæ–¹æ³•**:
- `REVIEWS_DIFF_ROOT_CAUSE` ãƒ­ã‚°ã§ `existing_hit: true` ã‹ã¤ `existing_time_is_null: true` ãŒå¤šæ•°å‡ºã¦ã„ã‚‹ã‹ç¢ºèª

## I. ä¿®æ­£ãƒ‘ãƒƒãƒæ–¹é‡ï¼ˆæœ€å°å¤‰æ›´ï¼‰

### ä¿®æ­£æ¡ˆ1: $existingReview ãŒ null ã®å ´åˆã®åŸå› ç‰¹å®šï¼ˆãƒ­ã‚°è¿½åŠ æ¸ˆã¿ï¼‰

**å®Ÿè£…çŠ¶æ³**: âœ… **æ—¢ã«å®Ÿè£…æ¸ˆã¿**ï¼ˆ406è¡Œç›®ã®ç›´å‰ï¼‰

**ä¿®æ­£å†…å®¹**:
- `REVIEWS_DIFF_ROOT_CAUSE` ãƒ­ã‚°ã‚’è¿½åŠ ã—ã¦ã€`existing_hit`, `review_id_from_api`, `existing_review_ids_sample` ã‚’å‡ºåŠ›
- ã“ã‚Œã§ã€`$existingReview` ãŒ `null` ã«ãªã‚‹åŸå› ï¼ˆã‚­ãƒ¼ã®ä¸ä¸€è‡´ç­‰ï¼‰ã‚’ç‰¹å®šã§ãã‚‹

### ä¿®æ­£æ¡ˆ2: $reviewId ã®å–å¾—æ–¹æ³•ã‚’æ”¹å–„ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

**ä¿®æ­£ç®‡æ‰€**: `app/Services/ReviewSyncService.php:108`

**ä¿®æ­£å‰**:
```php
$reviewId = trim(basename($review['name']));
```

**ä¿®æ­£å¾Œï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰**:
```php
$reviewId = trim(basename($review['name']));
// ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¿½åŠ ï¼ˆæœ€åˆã®5ä»¶ã ã‘ï¼‰
if (count($rows) + $skippedCount < 5) {
    Log::info('REVIEWS_REVIEW_ID_EXTRACTION', [
        'shop_id' => $shop->id,
        'review_name' => $review['name'] ?? null,
        'review_id_extracted' => $reviewId,
        'review_id_length' => strlen($reviewId),
        'existing_review_ids_sample' => $existingReviews->keys()->take(3)->toArray(),
    ]);
}
```

**æ³¨æ„**: ã“ã®ä¿®æ­£ã¯ã€`REVIEWS_DIFF_ROOT_CAUSE` ãƒ­ã‚°ã§åŸå› ãŒç‰¹å®šã§ããŸå¾Œã«å®Ÿæ–½ã™ã‚‹

### ä¿®æ­£æ¡ˆ3: $existingReviews ã®å–å¾—æ–¹æ³•ã‚’æ”¹å–„ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

**ä¿®æ­£ç®‡æ‰€**: `app/Services/ReviewSyncService.php:82-85`

**ä¿®æ­£å‰**:
```php
$existingReviews = Review::where('shop_id', $shop->id)
    ->whereNotNull('gbp_review_id')
    ->get()
    ->keyBy('gbp_review_id');
```

**ä¿®æ­£å¾Œï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰**:
```php
$existingReviews = Review::where('shop_id', $shop->id)
    ->whereNotNull('gbp_review_id')
    ->get()
    ->keyBy(function ($review) {
        // gbp_review_id ã‚’æ­£è¦åŒ–ï¼ˆå‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤ã€å¤§æ–‡å­—å°æ–‡å­—ã‚’çµ±ä¸€ç­‰ï¼‰
        return trim($review->gbp_review_id);
    });
```

**æ³¨æ„**: ã“ã®ä¿®æ­£ã¯ã€`REVIEWS_DIFF_ROOT_CAUSE` ãƒ­ã‚°ã§åŸå› ãŒç‰¹å®šã§ããŸå¾Œã«å®Ÿæ–½ã™ã‚‹

## J. ä¿®æ­£å¾Œã®æœŸå¾…ãƒ­ã‚°ï¼ˆ2å›ç›®åŒæœŸã§ rows_to_write_count ãŒã©ã†ãªã‚‹ã‹ï¼‰

### æ­£å¸¸ãªå ´åˆï¼ˆä¿®æ­£å¾Œãƒ»åŸå› ãŒè§£æ±ºã—ãŸå ´åˆï¼‰

**1å›ç›®ã®åŒæœŸ**:
- `fetched_count`: 176ä»¶ï¼ˆä¾‹ï¼‰
- `existing_count`: 0ä»¶ï¼ˆåˆå›ï¼‰
- `rows_to_write_count`: 176ä»¶
- `inserted_count`: 176ä»¶
- `updated_count`: 0ä»¶
- `skipped_count`: 0ä»¶

**2å›ç›®ã®åŒæœŸï¼ˆå¤‰æ›´ãŒãªã„å ´åˆï¼‰**:
- `fetched_count`: 176ä»¶
- `existing_count`: 176ä»¶
- `rows_to_write_count`: 0ä»¶ï¼ˆã¾ãŸã¯æ¥µå°ï¼‰
- `inserted_count`: 0ä»¶
- `updated_count`: 0ä»¶ï¼ˆã¾ãŸã¯æ¥µå°ï¼‰
- `skipped_count`: 176ä»¶ï¼ˆã»ã¼å…¨ä»¶ï¼‰

**REVIEWS_DIFF_ROOT_CAUSE ãƒ­ã‚°ï¼ˆ2å›ç›®åŒæœŸã€æœ€åˆã®5ä»¶ï¼‰**:
```json
{
  "shop_id": 1,
  "gbp_review_id": "AbFv...",
  "existing_hit": true,  // â† æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒãƒ’ãƒƒãƒˆã—ã¦ã„ã‚‹
  "existing_time_is_null": false,  // â† existingTimeãŒnullã§ã¯ãªã„
  "shouldSkip": true,  // â† SKIPåˆ¤å®šãŒtrue
  "hasChanges": false,  // â† å¤‰æ›´ãªã—
  "rows_appended": false,  // â† $rowsã«è¿½åŠ ã•ã‚Œãªã„
  "changeReasons": [],  // â† å¤‰æ›´ç†ç”±ãªã—
  "api_ts": 1234567890,
  "existing_ts": 1234567890,  // â† åŒå€¤
  "api_time_iso": "2024-01-01T00:00:00+00:00",
  "existing_time_iso": "2024-01-01T00:00:00+00:00",
  "review_id_from_api": "AbFv...",
  "existing_review_ids_sample": ["AbFv...", "BcGw...", "CdHx..."]  // â† ã‚­ãƒ¼ãŒä¸€è‡´ã—ã¦ã„ã‚‹
}
```

**ReviewSyncService: å£ã‚³ãƒŸåŒæœŸå®Œäº†ï¼ˆ2å›ç›®ï¼‰**:
```json
{
  "shop_id": 1,
  "fetched_count": 176,
  "rows_to_write_count": 0,  // â† æ¥µå°
  "inserted_count": 0,
  "updated_count": 0,  // â† æ¥µå°
  "skipped_count": 176,  // â† ã»ã¼å…¨ä»¶
  "synced_count": 0
}
```

### å•é¡ŒãŒã‚ã‚‹å ´åˆï¼ˆä¿®æ­£å‰ï¼‰

**2å›ç›®ã®åŒæœŸï¼ˆå¤‰æ›´ãŒãªã„å ´åˆã§ã‚‚ï¼‰**:
- `fetched_count`: 176ä»¶
- `existing_count`: 176ä»¶
- `rows_to_write_count`: 176ä»¶ï¼ˆå…¨ä»¶ï¼‰
- `inserted_count`: 0ä»¶
- `updated_count`: 176ä»¶ï¼ˆå…¨ä»¶æ›´æ–°ï¼‰
- `skipped_count`: 0ä»¶

**REVIEWS_DIFF_ROOT_CAUSE ãƒ­ã‚°ï¼ˆ2å›ç›®åŒæœŸã€æœ€åˆã®5ä»¶ï¼‰**:

**ãƒ‘ã‚¿ãƒ¼ãƒ³1: $existingReview ãŒ null ã®å ´åˆ**
```json
{
  "shop_id": 1,
  "gbp_review_id": "AbFv...",
  "existing_hit": false,  // â† å•é¡Œ: æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒãƒ’ãƒƒãƒˆã—ã¦ã„ãªã„
  "existing_time_is_null": true,
  "shouldSkip": false,
  "hasChanges": true,  // â† å•é¡Œ: æ–°è¦æ‰±ã„ã§true
  "rows_appended": true,  // â† å•é¡Œ: $rowsã«è¿½åŠ ã•ã‚Œã‚‹
  "changeReasons": [],  // â† æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ãªã®ã§ç©º
  "api_ts": 1234567890,
  "existing_ts": null,
  "review_id_from_api": "AbFv...",
  "existing_review_ids_sample": ["BcGw...", "CdHx...", "DeIy..."]  // â† ã‚­ãƒ¼ãŒä¸€è‡´ã—ã¦ã„ãªã„å¯èƒ½æ€§
}
```

**ãƒ‘ã‚¿ãƒ¼ãƒ³2: ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å·®åˆ†ãŒã‚ã‚‹å ´åˆ**
```json
{
  "shop_id": 1,
  "gbp_review_id": "AbFv...",
  "existing_hit": true,
  "existing_time_is_null": false,
  "shouldSkip": false,  // â† å•é¡Œ: shouldSkipãŒfalseã«ãªã£ã¦ã„ã‚‹
  "hasChanges": true,  // â† å•é¡Œ: å¤‰æ›´ã‚ã‚Šã¨åˆ¤å®šã•ã‚Œã¦ã„ã‚‹
  "rows_appended": true,  // â† å•é¡Œ: $rowsã«è¿½åŠ ã•ã‚Œã‚‹
  "changeReasons": ["comment_diff"],  // â† å•é¡Œ: ã‚³ãƒ¡ãƒ³ãƒˆã«å·®åˆ†ãŒã‚ã‚‹
  "api_ts": 1234567890,
  "existing_ts": 1234567890,  // â† åŒå€¤
  "review_id_from_api": "AbFv...",
  "existing_review_ids_sample": ["AbFv...", "BcGw...", "CdHx..."]
}
```

**ãƒ‘ã‚¿ãƒ¼ãƒ³3: update_time_gt åˆ¤å®šãŒèª¤ã£ã¦ã„ã‚‹å ´åˆ**
```json
{
  "shop_id": 1,
  "gbp_review_id": "AbFv...",
  "existing_hit": true,
  "existing_time_is_null": false,
  "shouldSkip": false,  // â† å•é¡Œ: shouldSkipãŒfalseã«ãªã£ã¦ã„ã‚‹
  "hasChanges": true,  // â† å•é¡Œ: å¤‰æ›´ã‚ã‚Šã¨åˆ¤å®šã•ã‚Œã¦ã„ã‚‹
  "rows_appended": true,  // â† å•é¡Œ: $rowsã«è¿½åŠ ã•ã‚Œã‚‹
  "changeReasons": ["update_time_gt"],  // â† å•é¡Œ: åŒå€¤ãªã®ã«update_time_gtã«ãªã£ã¦ã„ã‚‹
  "api_ts": 1234567890,
  "existing_ts": 1234567889  // â† å•é¡Œ: 1ç§’ã®å·®ãŒã‚ã‚‹ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚„ãƒ‘ãƒ¼ã‚¹ã®å•é¡Œï¼‰
}
```

**ReviewSyncService: å£ã‚³ãƒŸåŒæœŸå®Œäº†ï¼ˆ2å›ç›®ï¼‰**:
```json
{
  "shop_id": 1,
  "fetched_count": 176,
  "rows_to_write_count": 176,  // â† å•é¡Œ: å…¨ä»¶
  "inserted_count": 0,
  "updated_count": 176,  // â† å•é¡Œ: å…¨ä»¶æ›´æ–°
  "skipped_count": 0,  // â† å•é¡Œ: ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¦ã„ãªã„
  "synced_count": 176
}
```

## K. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **ãƒ­ã‚°ã‚’ç¢ºèª**
   - `REVIEWS_DIFF_ROOT_CAUSE` ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ã€åŸå› ã‚’ç‰¹å®š
   - `existing_hit`, `changeReasons`, `api_ts`, `existing_ts` ã‚’ç¢ºèª

2. **åŸå› ã«å¿œã˜ãŸä¿®æ­£**
   - **ãƒ‘ã‚¿ãƒ¼ãƒ³1ï¼ˆ$existingReview ãŒ nullï¼‰**: `$reviewId` ã®å–å¾—æ–¹æ³•ã‚„ `$existingReviews` ã®ã‚­ãƒ¼å½¢å¼ã‚’ç¢ºèªãƒ»ä¿®æ­£
   - **ãƒ‘ã‚¿ãƒ¼ãƒ³2ï¼ˆä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å·®åˆ†ï¼‰**: æ­£è¦åŒ–å‡¦ç†ï¼ˆ`normalizeString`ï¼‰ã‚’ç¢ºèªãƒ»ä¿®æ­£
   - **ãƒ‘ã‚¿ãƒ¼ãƒ³3ï¼ˆupdate_time_gt åˆ¤å®šãŒèª¤ã£ã¦ã„ã‚‹ï¼‰**: ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚„ãƒ‘ãƒ¼ã‚¹å‡¦ç†ã‚’ç¢ºèªãƒ»ä¿®æ­£

3. **ä¿®æ­£å¾Œã®æ¤œè¨¼**
   - 2å›é€£ç¶šåŒæœŸã‚’å®Ÿè¡Œ
   - `rows_to_write_count` ãŒ 0ï¼ˆã¾ãŸã¯æ¥µå°ï¼‰ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª
   - `skipped_count` ãŒã»ã¼ `fetched_count` ã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª

**1å›ç›®ã®åŒæœŸ**:
- `fetched_count`: 176ä»¶ï¼ˆä¾‹ï¼‰
- `existing_count`: 0ä»¶ï¼ˆåˆå›ï¼‰
- `rows_to_write_count`: 176ä»¶
- `inserted_count`: 176ä»¶
- `updated_count`: 0ä»¶
- `skipped_count`: 0ä»¶

**2å›ç›®ã®åŒæœŸï¼ˆå¤‰æ›´ãŒãªã„å ´åˆï¼‰**:
- `fetched_count`: 176ä»¶
- `existing_count`: 176ä»¶
- `rows_to_write_count`: 0ä»¶ï¼ˆã¾ãŸã¯æ¥µå°ï¼‰
- `inserted_count`: 0ä»¶
- `updated_count`: 0ä»¶ï¼ˆã¾ãŸã¯æ¥µå°ï¼‰
- `skipped_count`: 176ä»¶ï¼ˆã»ã¼å…¨ä»¶ï¼‰

**REVIEWS_DIFF_ROOT_CAUSE ãƒ­ã‚°ï¼ˆ2å›ç›®åŒæœŸã€æœ€åˆã®5ä»¶ï¼‰**:
```json
{
  "shop_id": 1,
  "gbp_review_id": "AbFv...",
  "existing_hit": true,
  "existing_time_is_null": false,
  "shouldSkip": true,
  "hasChanges": false,
  "rows_appended": false,
  "changeReasons": [],
  "api_ts": 1234567890,
  "existing_ts": 1234567890,
  "api_time_iso": "2024-01-01T00:00:00+00:00",
  "existing_time_iso": "2024-01-01T00:00:00+00:00"
}
```

### å•é¡ŒãŒã‚ã‚‹å ´åˆï¼ˆä¿®æ­£å‰ï¼‰

**2å›ç›®ã®åŒæœŸï¼ˆå¤‰æ›´ãŒãªã„å ´åˆã§ã‚‚ï¼‰**:
- `fetched_count`: 176ä»¶
- `existing_count`: 176ä»¶
- `rows_to_write_count`: 176ä»¶ï¼ˆå…¨ä»¶ï¼‰
- `inserted_count`: 0ä»¶
- `updated_count`: 176ä»¶ï¼ˆå…¨ä»¶æ›´æ–°ï¼‰
- `skipped_count`: 0ä»¶

**REVIEWS_DIFF_ROOT_CAUSE ãƒ­ã‚°ï¼ˆ2å›ç›®åŒæœŸã€æœ€åˆã®5ä»¶ï¼‰**:
```json
{
  "shop_id": 1,
  "gbp_review_id": "AbFv...",
  "existing_hit": false, // â† å•é¡Œ: æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒãƒ’ãƒƒãƒˆã—ã¦ã„ãªã„
  "existing_time_is_null": true,
  "shouldSkip": false,
  "hasChanges": true,
  "rows_appended": true,
  "changeReasons": [],
  "api_ts": 1234567890,
  "existing_ts": null
}
```

ã¾ãŸã¯

```json
{
  "shop_id": 1,
  "gbp_review_id": "AbFv...",
  "existing_hit": true,
  "existing_time_is_null": false,
  "shouldSkip": false, // â† å•é¡Œ: shouldSkipãŒfalseã«ãªã£ã¦ã„ã‚‹
  "hasChanges": true,
  "rows_appended": true,
  "changeReasons": ["update_time_gt"], // â† å•é¡Œ: åŒå€¤ãªã®ã«update_time_gtã«ãªã£ã¦ã„ã‚‹
  "api_ts": 1234567890,
  "existing_ts": 1234567889 // â† å•é¡Œ: 1ç§’ã®å·®ãŒã‚ã‚‹
}
```

