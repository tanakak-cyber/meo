# 同期データ保存構造の調査結果

## 1) 同期データ（口コミ・写真・投稿・インサイト等）の保存単位

### テーブル構造とリレーション

#### **gbp_snapshots テーブル**
**保存単位**: `shop_id` + `user_id` の組み合わせ

**カラム構造**:
- `id` (PK)
- `shop_id` (FK → shops)
- `user_id` (FK → users) ← **ユーザー別に分離**
- `synced_by_operator_id` (FK → operation_persons, nullable) ← 同期実行者（ログ用）
- `synced_at` (timestamp)
- `photos_count`, `reviews_count`, `posts_count`
- `sync_params` (JSON)

**インデックス**: `['shop_id', 'user_id', 'synced_at']`

**根拠**: 
- `database/migrations/2026_02_02_000001_add_user_id_to_gbp_snapshots_table.php` (17行目)
- `app/Models/GbpSnapshot.php` (14-23行目)

---

#### **reviews テーブル**
**保存単位**: `snapshot_id` + `gbp_review_id` の組み合わせ（ユニーク）

**カラム構造**:
- `id` (PK)
- `shop_id` (FK → shops)
- `snapshot_id` (FK → gbp_snapshots) ← **スナップショットに紐付け**
- `gbp_review_id` (string)
- `author_name`, `rating`, `comment`, `create_time`, `reply_text`, `replied_at`

**ユニーク制約**: `['snapshot_id', 'gbp_review_id']`

**根拠**: 
- `database/migrations/2026_01_31_000004_add_snapshot_id_to_reviews_table.php` (37行目)
- `app/Models/Review.php` (13-23行目)

**リレーション**:
- `Review::shop()` → `Shop`
- `Review::snapshot()` → `GbpSnapshot`

---

#### **photos テーブル**
**保存単位**: `snapshot_id` + `gbp_media_id` の組み合わせ（ユニーク）

**カラム構造**:
- `id` (PK)
- `shop_id` (FK → shops)
- `snapshot_id` (FK → gbp_snapshots) ← **スナップショットに紐付け**
- `gbp_media_id` (string)
- `gbp_media_name`, `media_format`, `google_url`, `thumbnail_url`, `create_time`, etc.

**ユニーク制約**: `['snapshot_id', 'gbp_media_id']`

**根拠**: 
- `database/migrations/2026_01_31_000003_add_snapshot_id_to_photos_table.php` (34行目)
- `app/Models/Photo.php` (13-25行目)

**リレーション**:
- `Photo::shop()` → `Shop`
- `Photo::snapshot()` → `GbpSnapshot`

---

#### **gbp_insights テーブル**
**保存単位**: `shop_id` のみ（**user_id や snapshot_id なし**）

**カラム構造**:
- `id` (PK)
- `shop_id` (FK → shops)
- `location_id`, `from_date`, `to_date`, `period_type`
- `impressions`, `directions`, `website`, `phone`
- `metrics_response`, `keywords_response` (JSON)

**ユニーク制約**: なし（user_idやsnapshot_idで分離されていない）

**根拠**: 
- `database/migrations/2026_02_02_190000_create_gbp_insights_table.php`
- `app/Models/GbpInsight.php` (13-27行目)

**リレーション**:
- `GbpInsight::shop()` → `Shop`

---

### データの所有単位まとめ

| データ種別 | 保存単位 | user_id分離 | snapshot_id分離 |
|-----------|---------|------------|----------------|
| **GbpSnapshot** | `shop_id` + `user_id` | ✅ YES | - |
| **Review** | `snapshot_id` + `gbp_review_id` | ✅ YES (間接的) | ✅ YES |
| **Photo** | `snapshot_id` + `gbp_media_id` | ✅ YES (間接的) | ✅ YES |
| **GbpInsight** | `shop_id` のみ | ❌ NO | ❌ NO |

---

## 2) 同期ボタン処理での user_id / operator_id の紐付け

### 同期処理での保存

**ファイル**: `app/Http/Controllers/ReportController.php`

#### **syncAll() メソッド** (613-623行目)
```php
$currentUserId = \App\Helpers\AuthHelper::getCurrentUserId();
$snapshot = GbpSnapshot::create([
    'shop_id' => $shop->id,
    'user_id' => $currentUserId,  // ← user_id を保存
    'synced_by_operator_id' => $operatorId,  // ← operator_id を保存（ログ用）
    'synced_at' => now(),
    'sync_params' => [...],
]);

// 口コミ・写真は snapshot_id で紐付け
$reviewsSynced = $this->syncReviews($shop, $accessToken, $googleService, $snapshot->id, ...);
$photosSynced = $this->syncPhotos($shop, $accessToken, $googleService, $snapshot->id, ...);
```

#### **sync() メソッド** (762-772行目)
```php
$currentUserId = \App\Helpers\AuthHelper::getCurrentUserId();
$snapshot = GbpSnapshot::create([
    'shop_id' => $shop->id,
    'user_id' => $currentUserId,  // ← user_id を保存
    'synced_by_operator_id' => $operatorId,  // ← operator_id を保存（ログ用）
    'synced_at' => now(),
    'sync_params' => [...],
]);

// 口コミ・写真は snapshot_id で紐付け
$reviewsSynced = $this->syncReviews($shop, $accessToken, $googleService, $snapshot->id, ...);
$photosSynced = $this->syncPhotos($shop, $accessToken, $googleService, $snapshot->id, ...);
```

**結論**: 
- ✅ **user_id を保存している** (`AuthHelper::getCurrentUserId()` を使用)
- ✅ **operator_id も保存している** (`synced_by_operator_id` として、ログ用)
- ✅ **口コミ・写真は snapshot_id で紐付け** (間接的に user_id で分離)

---

## 3) 表示クエリでの user_id フィルタリング

### 表示処理でのフィルタリング

**ファイル**: `app/Http/Controllers/ReportController.php`

#### **show() メソッド** (229-234行目)
```php
// 最新のスナップショットを取得（ユーザー別に分離）
$currentUserId = \App\Helpers\AuthHelper::getCurrentUserId();
$latestSnapshot = GbpSnapshot::where('shop_id', $shop->id)
    ->where('user_id', $currentUserId)  // ← user_id でフィルタリング
    ->orderBy('synced_at', 'desc')
    ->first();
```

#### **データ取得時の snapshot_id フィルタリング** (250-261行目)
```php
// 口コミ数：該当期間で投稿された口コミ数（ユニーク）
$currentReviewIds = DB::table('reviews')
    ->where('shop_id', $shop->id)
    ->where('snapshot_id', $latestSnapshot->id)  // ← snapshot_id でフィルタリング
    ->whereBetween('create_time', [...])
    ->select(DB::raw('MAX(id) as id'))
    ->groupBy('gbp_review_id')
    ->pluck('id');
```

#### **写真数の取得** (320-326行目)
```php
$currentPhotoIds = DB::table('photos')
    ->where('shop_id', $shop->id)
    ->where('snapshot_id', $latestSnapshot->id)  // ← snapshot_id でフィルタリング
    ->whereBetween('create_time', [...])
    ->select(DB::raw('MAX(id) as id'))
    ->groupBy('gbp_media_id')
    ->pluck('id');
```

#### **前月のスナップショット取得** (305-309行目)
```php
$prevSnapshot = GbpSnapshot::where('shop_id', $shop->id)
    ->where('user_id', $currentUserId)  // ← user_id でフィルタリング
    ->where('synced_at', '<=', $prevPeriodEnd)
    ->orderBy('synced_at', 'desc')
    ->first();
```

#### **downloadPdf() メソッド** (1232-1236行目)
```php
// 最新のスナップショットを取得（ユーザー別に分離）
$currentUserId = \App\Helpers\AuthHelper::getCurrentUserId();
$latestSnapshot = GbpSnapshot::where('shop_id', $shop->id)
    ->where('user_id', $currentUserId)  // ← user_id でフィルタリング
    ->orderBy('synced_at', 'desc')
    ->first();
```

**結論**: 
- ✅ **user_id でフィルタリングしている** (`where('user_id', $currentUserId)`)
- ✅ **snapshot_id でフィルタリングしている** (`where('snapshot_id', $latestSnapshot->id)`)

---

### GbpInsight の取得（例外）

**ファイル**: `app/Services/GbpInsightsService.php` (35-39行目)
```php
$insights = GbpInsight::where('shop_id', $shop->id)
    ->whereBetween('from_date', [$from, $to])
    ->where('period_type', 'daily')
    ->whereNotNull('impressions')
    ->get();
```

**問題**: 
- ❌ **user_id でフィルタリングしていない**
- ❌ **snapshot_id でフィルタリングしていない**
- **shop_id のみで取得** → 全ユーザーのデータが混在する可能性

---

## 4) Aユーザーが同期した後、Bユーザーが同じ店舗を開いた場合の挙動

### 結論: **NO（最新同期データが表示されない）**

### 根拠となるコード箇所

#### **表示処理** (`app/Http/Controllers/ReportController.php` 229-234行目)
```php
// 最新のスナップショットを取得（ユーザー別に分離）
$currentUserId = \App\Helpers\AuthHelper::getCurrentUserId();
$latestSnapshot = GbpSnapshot::where('shop_id', $shop->id)
    ->where('user_id', $currentUserId)  // ← 現在ログイン中のユーザーのIDでフィルタリング
    ->orderBy('synced_at', 'desc')
    ->first();
```

**動作**:
1. Aユーザー（user_id=1）が同期 → `GbpSnapshot` に `user_id=1` で保存
2. Bユーザー（user_id=2）が同じ店舗を開く
3. `AuthHelper::getCurrentUserId()` は `2` を返す
4. クエリ: `where('user_id', 2)` → **Aユーザーのスナップショットは取得されない**
5. Bユーザーが同期していない場合 → `$latestSnapshot = null`
6. データは `0` または空で表示される

**結論**: 
- ✅ **ユーザー別にデータが分離されている**
- ❌ **別ユーザーが同期しても、自分のデータは変わらない**

---

## 5) 現在の設計は「店舗単位でデータを共有」か「ユーザー単位でデータを分離」か

### 結論: **「ユーザー単位でデータを分離」している**

### 根拠

#### **データ保存構造**
1. **GbpSnapshot**: `shop_id` + `user_id` の組み合わせで保存
2. **Review**: `snapshot_id` で紐付け（間接的に user_id で分離）
3. **Photo**: `snapshot_id` で紐付け（間接的に user_id で分離）

#### **表示ロジック**
- `where('user_id', $currentUserId)` でフィルタリング
- `where('snapshot_id', $latestSnapshot->id)` でフィルタリング

#### **例外: GbpInsight**
- `shop_id` のみで保存・取得
- **ユーザー別に分離されていない** ← 問題点

---

## 最終結論

### **同期データの所有単位は何か**

**結論**: **「ユーザー単位（user_id）でデータを所有・分離している」**

ただし、**GbpInsight のみ例外**で、`shop_id` 単位で共有されている。

---

## 問題点と改善案

### 問題点1: GbpInsight がユーザー別に分離されていない

**現状**:
- `gbp_insights` テーブルに `user_id` や `snapshot_id` がない
- 全ユーザーのデータが混在

**影響**:
- AユーザーがインポートしたInsightsデータが、Bユーザーにも表示される
- データの所有権が不明確

**改善案**:
1. `gbp_insights` テーブルに `user_id` カラムを追加
2. `GbpInsightsService::getInsightsFromDb()` で `user_id` でフィルタリング

---

### 問題点2: 自動レポート生成で user_id を考慮していない

**現状**:
- `SendMonthlyReports::generatePdf()` では `user_id` でフィルタリングしていない
- スナップショットを取得していない

**影響**:
- 自動レポートがどのユーザーのデータを使うか不明確
- 全ユーザーのデータが混在する可能性

**改善案**:
1. 自動レポート生成時に、特定のユーザー（例: 管理者ユーザー）のスナップショットを使用
2. または、全ユーザーの最新スナップショットをマージ

---

## コード参照箇所まとめ

### 同期処理
- `app/Http/Controllers/ReportController.php` 613-623行目 (syncAll)
- `app/Http/Controllers/ReportController.php` 762-772行目 (sync)

### 表示処理
- `app/Http/Controllers/ReportController.php` 229-234行目 (show)
- `app/Http/Controllers/ReportController.php` 250-261行目 (口コミ取得)
- `app/Http/Controllers/ReportController.php` 320-326行目 (写真取得)
- `app/Http/Controllers/ReportController.php` 1232-1236行目 (downloadPdf)

### モデル定義
- `app/Models/GbpSnapshot.php` (14-23行目)
- `app/Models/Review.php` (13-23行目)
- `app/Models/Photo.php` (13-25行目)
- `app/Models/GbpInsight.php` (13-27行目)

### ヘルパー
- `app/Helpers/AuthHelper.php` (16-36行目)









