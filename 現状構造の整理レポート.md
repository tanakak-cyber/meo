# 現状構造の整理レポート

## 【1】dashboard ルート確認

### routes/web.php の /dashboard のルート定義

#### ① オペレーター用 dashboard（28-34行目）

```28:34:routes/web.php
Route::middleware('operator.auth')->prefix('operator')->name('operator.')->group(function () {
    Route::get('/dashboard', function () {
        $operatorId = session('operator_id');
        $operator = \App\Models\OperationPerson::find($operatorId);
        $shops = \App\Models\Shop::where('operation_person_id', $operatorId)->get();
        return view('operator.dashboard', compact('operator', 'shops'));
    })->name('dashboard');
```

- **ルート名**: `operator.dashboard`
- **URL**: `/operator/dashboard`
- **Middleware**: `operator.auth`
- **verified**: ❌ なし
- **can**: ❌ なし
- **auth**: ❌ なし（`operator.auth` は独自ミドルウェア）

#### ② 管理者用 dashboard（72-102行目）

```72:102:routes/web.php
Route::middleware(['auth', 'admin.only'])->group(function () {
    Route::get('/dashboard', function () {
        // ... ダッシュボードのロジック ...
        return view('dashboard', compact('shopCount', 'reviewCount', 'unrepliedReviewCount'));
    })->middleware('admin.permission:dashboard')->name('dashboard');
```

- **ルート名**: `dashboard`
- **URL**: `/dashboard`
- **Middleware**: 
  - `auth`（Laravel標準の認証ミドルウェア）
  - `admin.only`（オペレーターを除外）
  - `admin.permission:dashboard`（権限チェック）
- **verified**: ❌ なし
- **can**: ❌ なし
- **auth**: ✅ あり（`auth` middleware）

### RouteServiceProvider::HOME の値

**結論**: RouteServiceProvider は存在しません（Laravel 11 では削除されています）

代わりに、`AuthenticatedSessionController::store()` でリダイレクト先を決定しています：

```41:68:app/Http/Controllers/Auth/AuthenticatedSessionController.php
// 権限が設定されている場合、ダッシュボードの権限があるかチェック
$permissions = session('admin_permissions', []);
if (!empty($permissions) && in_array('dashboard', $permissions)) {
    return redirect()->intended(route('dashboard', absolute: false));
} elseif (!empty($permissions)) {
    // ダッシュボードの権限がない場合は、最初の権限があるページにリダイレクト
    $firstPermission = $permissions[0];
    $routeMap = [
        'shops.index' => 'shops.index',
        'shops.schedule' => 'shops.schedule',
        'reviews.index' => 'reviews.index',
        'reports.index' => 'reports.index',
        'report-email-settings.index' => 'report-email-settings.index',
        'masters.index' => 'masters.index',
    ];
    if (isset($routeMap[$firstPermission])) {
        $route = $routeMap[$firstPermission];
        if ($route === 'shops.schedule') {
            return redirect()->route($route, ['year' => now()->year, 'month' => now()->month]);
        }
        return redirect()->route($route);
    }
}

// 権限がない場合は、ログイン画面にリダイレクト（403エラーではなく）
$intended = session()->pull('url.intended', route('login'));
return redirect($intended)->with('error', 'アクセス権限がありません。権限が設定されていません。');
```

---

## 【2】reports.sync ルート確認

### routes/web.php で route('reports.sync') の定義

#### ① オペレーター用 reports.sync（68行目）

```68:68:routes/web.php
Route::post('/reports/{shop}/sync', [ReportController::class, 'sync'])->name('reports.sync');
```

- **ルート名**: `operator.reports.sync`
- **URL**: `/operator/reports/{shop}/sync`
- **Middleware**: `operator.auth`
- **Controller**: `ReportController::sync`
- **Policy**: ❌ 使用していない

#### ② 管理者用 reports.sync（152行目）

```148:154:routes/web.php
Route::middleware('admin.permission:reports.index')->group(function () {
    Route::get('/reports', [ReportController::class, 'index'])->name('reports.index');
    Route::get('/reports/{shop}', [ReportController::class, 'show'])->name('reports.show');
    Route::post('/reports/sync-all', [ReportController::class, 'syncAll'])->name('reports.sync-all');
    Route::post('/reports/{shop}/sync', [ReportController::class, 'sync'])->name('reports.sync');
    Route::match(['get', 'post'], '/reports/{shop}/pdf', [ReportController::class, 'downloadPdf'])->name('reports.pdf');
});
```

- **ルート名**: `reports.sync`
- **URL**: `/reports/{shop}/sync`
- **Middleware**: 
  - `auth`（親グループ: 72行目）
  - `admin.only`（親グループ: 72行目）
  - `admin.permission:reports.index`（148行目）
- **Controller**: `ReportController::sync`
- **Policy**: ❌ 使用していない

### ReportController::sync の実装

```686:825:app/Http/Controllers/ReportController.php
public function sync(Request $request, $shopId)
{
    $shop = Shop::findOrFail($shopId);
    
    // operator_id を取得（同期実行者の記録用）
    $user = Auth::user();
    $operatorId = session('operator_id');
    if (!$user || !$user->is_admin) {
        // オペレーターの場合
        if ($user && !$user->is_admin && $user->operator_id) {
            $operatorId = $user->operator_id;
        }
        if ($operatorId) {
            // オペレーターの場合は自分の担当店舗のみアクセス可能（operator_shopsテーブルを使用）
            $isAssigned = \App\Models\OperatorShop::where('operator_id', $operatorId)
                ->where('shop_id', $shop->id)
                ->exists();
            
            if (!$isAssigned) {
                abort(403, 'この店舗を同期する権限がありません。');
            }
        }
    }
    // ... 同期処理 ...
}
```

**403エラーの発生箇所**:
- 705行目: `abort(403, 'この店舗を同期する権限がありません。');`

---

## 【3】ShopPolicy の確認

**結論**: `ShopPolicy` は存在しません。

検索結果:
- `glob_file_search` で `ShopPolicy.php` を検索 → 見つからない
- `grep` で `ShopPolicy` を検索 → 見つからない

**Policy は使用されていません**。

---

## 【4】ReportSyncTest の actingAs 確認

### test_sync_creates_snapshot_and_saves_reviews_photos_posts_count()

```25:40:tests/Feature/ReportSyncTest.php
public function test_sync_creates_snapshot_and_saves_reviews_photos_posts_count(): void
{
    // ダミーshopを作成
    $shop = Shop::factory()->create([
        'name' => 'テスト店舗',
        'gbp_account_id' => '123456789012345678901',
        'gbp_location_id' => 'locations/987654321098765432109',
        'gbp_refresh_token' => 'dummy_refresh_token',
        'contract_end_date' => null, // 契約中
    ]);

    // 認証済みユーザーを作成
    $user = User::factory()->create([
        'is_admin' => true,
    ]);
    Auth::login($user);
```

- **actingAs の使用**: ❌ 使用していない（`Auth::login($user)` を使用）
- **shop 作成時の user_id**: ❌ 設定されていない
- **shop 作成時の operation_person_id**: ❌ 設定されていない
- **shop 作成時の sales_person_id**: ❌ 設定されていない

### test_sync_twice_creates_two_snapshots_and_duplicates_reviews_photos()

```195:210:tests/Feature/ReportSyncTest.php
public function test_sync_twice_creates_two_snapshots_and_duplicates_reviews_photos(): void
{
    // ダミーshopを作成
    $shop = Shop::factory()->create([
        'name' => 'テスト店舗',
        'gbp_account_id' => '123456789012345678901',
        'gbp_location_id' => 'locations/987654321098765432109',
        'gbp_refresh_token' => 'dummy_refresh_token',
        'contract_end_date' => null, // 契約中
    ]);

    // 認証済みユーザーを作成
    $user = User::factory()->create([
        'is_admin' => true,
    ]);
    Auth::login($user);
```

- **actingAs の使用**: ❌ 使用していない（`Auth::login($user)` を使用）
- **shop 作成時の user_id**: ❌ 設定されていない
- **shop 作成時の operation_person_id**: ❌ 設定されていない
- **shop 作成時の sales_person_id**: ❌ 設定されていない

### test_sync_isolated_by_user()

```358:379:tests/Feature/ReportSyncTest.php
public function test_sync_isolated_by_user(): void
{
    // ダミーshopを作成
    $shop = Shop::factory()->create([
        'name' => 'テスト店舗',
        'gbp_account_id' => '123456789012345678901',
        'gbp_location_id' => 'locations/987654321098765432109',
        'gbp_refresh_token' => 'dummy_refresh_token',
        'contract_end_date' => null, // 契約中
    ]);

    // userAを作成
    $userA = User::factory()->create([
        'name' => 'ユーザーA',
        'is_admin' => true,
    ]);

    // userBを作成
    $userB = User::factory()->create([
        'name' => 'ユーザーB',
        'is_admin' => true,
    ]);
```

- **actingAs の使用**: ❌ 使用していない（`Auth::login($userA)` / `Auth::login($userB)` を使用）
- **shop 作成時の user_id**: ❌ 設定されていない
- **shop 作成時の operation_person_id**: ❌ 設定されていない
- **shop 作成時の sales_person_id**: ❌ 設定されていない

---

## 【5】Middleware の実装確認

### AdminOnly ミドルウェア

```16:24:app/Http/Middleware/AdminOnly.php
public function handle(Request $request, Closure $next): Response
{
    // オペレーターがログインしている場合は403
    if (session('operator_id')) {
        abort(403, 'このページにアクセスする権限がありません。');
    }

    return $next($request);
}
```

### CheckAdminPermission ミドルウェア

```16:42:app/Http/Middleware/CheckAdminPermission.php
public function handle(Request $request, Closure $next, string $permission): Response
{
    // オペレーターの場合は通過
    if (session('operator_id')) {
        return $next($request);
    }

    // 管理者でない場合は403エラー（ログイン画面へのリダイレクトはしない）
    if (!auth()->check()) {
        abort(403, 'アクセス権限がありません。');
    }

    $permissions = session('admin_permissions', []);
    
    // 権限が空の場合はアクセス不可
    if (empty($permissions)) {
        abort(403, 'アクセス権限がありません。権限が設定されていません。');
    }

    // 指定された権限がない場合は403
    if (!in_array($permission, $permissions)) {
        abort(403, 'アクセス権限がありません。');
    }

    return $next($request);
}
```

---

## 【6】UserFactory の確認

```24:33:database/factories/UserFactory.php
public function definition(): array
{
    return [
        'name' => fake()->name(),
        'email' => fake()->unique()->safeEmail(),
        'email_verified_at' => now(),
        'password' => static::$password ??= Hash::make('password'),
        'remember_token' => Str::random(10),
    ];
}
```

**問題点**:
- `permissions` が設定されていない（デフォルトで null）
- `is_admin` が設定されていない（デフォルトで false または null）

---

## 403エラーの原因分析

### ReportSyncTest で 403 が返る原因

**結論**: **B) Policy で拒否** ではなく、**C) middleware で拒否** の可能性が高い

#### 原因候補

1. **`admin.permission:reports.index` ミドルウェアで拒否**
   - `CheckAdminPermission` が `reports.index` 権限をチェック
   - テストで作成した User に `permissions` が設定されていない
   - `session('admin_permissions')` が空のため、403 が返る

2. **`admin.only` ミドルウェアで拒否**
   - `AdminOnly` は `session('operator_id')` をチェック
   - テスト環境では `operator_id` が設定されていないため、通過するはず

3. **ReportController::sync 内の権限チェック**
   - 705行目: オペレーターの場合、`operator_shops` テーブルで担当店舗をチェック
   - テストで作成した shop に `operation_person_id` が設定されていない
   - `operator_shops` テーブルにレコードが存在しないため、403 が返る可能性

#### 確認が必要な点

1. **User の permissions が設定されていない**
   - `UserFactory` で `permissions` が設定されていない
   - `AuthenticatedSessionController::store()` で `session(['admin_permissions' => $user->permissions])` を設定
   - テストでは `Auth::login($user)` を使用しているため、`store()` が呼ばれない
   - そのため、`session('admin_permissions')` が空になり、403 が返る

2. **actingAs を使用していない**
   - `Auth::login($user)` はセッションにユーザーを保存するが、middleware のチェックには問題ない
   - ただし、`session('admin_permissions')` が設定されていない

---

## 【7】AuthenticationTest で /dashboard にリダイレクトされない原因

### テストコード

```20:31:tests/Feature/Auth/AuthenticationTest.php
public function test_users_can_authenticate_using_the_login_screen(): void
{
    $user = User::factory()->create();

    $response = $this->post('/login', [
        'email' => $user->email,
        'password' => 'password',
    ]);

    $this->assertAuthenticated();
    $response->assertRedirect(route('dashboard', absolute: false));
}
```

### 原因分析

**AuthenticatedSessionController::store()** のロジック:

```41:68:app/Http/Controllers/Auth/AuthenticatedSessionController.php
// 権限が設定されている場合、ダッシュボードの権限があるかチェック
$permissions = session('admin_permissions', []);
if (!empty($permissions) && in_array('dashboard', $permissions)) {
    return redirect()->intended(route('dashboard', absolute: false));
} elseif (!empty($permissions)) {
    // ダッシュボードの権限がない場合は、最初の権限があるページにリダイレクト
    // ...
}

// 権限がない場合は、ログイン画面にリダイレクト（403エラーではなく）
$intended = session()->pull('url.intended', route('login'));
return redirect($intended)->with('error', 'アクセス権限がありません。権限が設定されていません。');
```

**問題点**:
1. `UserFactory` で作成された User に `permissions` が設定されていない
2. `session('admin_permissions')` が空配列になる
3. 68行目で `route('login')` にリダイレクトされる

---

## まとめ

### 403エラーの原因

**結論**: **C) middleware で拒否**（`CheckAdminPermission` ミドルウェア）

**詳細**:
1. `reports.sync` ルートは `admin.permission:reports.index` ミドルウェアが適用されている
2. テストで作成した User に `permissions` が設定されていない
3. `session('admin_permissions')` が空のため、`CheckAdminPermission` が 403 を返す

### dashboard にリダイレクトされない原因

**結論**: **権限が設定されていないため**

**詳細**:
1. `UserFactory` で作成された User に `permissions` が設定されていない
2. `AuthenticatedSessionController::store()` で `session('admin_permissions')` が空配列になる
3. 68行目で `route('login')` にリダイレクトされる

### 修正が必要な箇所

1. **ReportSyncTest**: 
   - `actingAs($user)` を使用する
   - User 作成時に `permissions` を設定する
   - または、`session(['admin_permissions' => ['reports.index']])` を設定する

2. **AuthenticationTest**:
   - User 作成時に `permissions` を設定する
   - または、`session(['admin_permissions' => ['dashboard']])` を設定する









